"use strict";const e=require("../common/vendor.js"),i=require("../components/file-upload/choose-file.js"),t=require("../api/app.js"),o={count:9,imageAccept:["jpg","png","jpeg"],imageSize:20,imageResolution:[4096,4096],videoAccept:["mp4","mov"],videoSize:200,videoDuration:[1,600],fileAccept:["jpg","png","jpeg","mp4","mov"],fileSize:200};exports.useUpload=function(n){const{count:a=o.count,imageAccept:u=o.imageAccept,imageSize:s=o.imageSize,imageResolution:l=o.imageResolution,videoAccept:c=o.videoAccept,videoSize:p=o.videoSize,videoDuration:r=o.videoDuration,fileAccept:d=o.fileAccept,fileSize:f=o.fileSize,onSuccess:g}=n,m=e.ref([]),h=e.ref(!1),v=(e,i)=>{const t=m.value.findIndex((e=>e.tempFilePath===i.tempFilePath));if(-1!==t){const i=[...m.value];i[t]={...i[t],progress:e},m.value=i}};return{uploadMaterialList:m,showUploadProgress:h,uploadAndProcessFiles:async o=>{var n;m.value=[];try{const n="image"===o,z="video"===o,x="file"===o,j="all"===o,{tempFiles:A}=await i.chooseFile({type:o,count:a,sourceType:["album"],extension:n?u:z?c:d}),F=[];for(const i of A){if(n)try{const{width:t,height:o}=await e.index.getImageInfo({src:i.tempFilePath});if(u.length>0&&!u.includes(i.name.split(".").pop())){e.index.$u.toast(`图片格式必须是${u.join("、")}`);continue}if(t>l[0]||o>l[1]){e.index.$u.toast(`图片分辨率不能超过${l[0]}*${l[1]}`);continue}if(i.size>1024*s*1024){e.index.$u.toast(`图片大小不能超过${s}M`);continue}F.push(i)}catch($){continue}if(z){if(!(i.duration>=r[0]&&i.duration<=r[1])&&r.length>0){e.index.$u.toast(`视频时长不能小于${r[0]}秒，不能超过${r[1]}秒`);continue}if(i.size>1024*p*1024){e.index.$u.toast(`视频大小不能超过${p}M`);continue}if(c.length>0&&!c.includes(i.name.split(".").pop())){e.index.$u.toast(`视频格式必须是${c.join("、")}`);continue}F.push(i)}if(x||j){if(d.length>0&&!d.includes(i.name.split(".").pop())){e.index.$u.toast(`文件格式必须是${d.join("、")}`);continue}if(i.size>1024*f*1024){e.index.$u.toast(`文件大小不能超过${f}M`);continue}F.push(i)}}if(0===F.length)return;m.value=F.map((e=>({...e,progress:0}))),h.value=!0;const S=[];for(const e of m.value){const i=z?await t.uploadFile("image",{filePath:e.thumbTempFilePath}):{},a=await t.uploadFile(j?"file":o,{filePath:e.tempFilePath},(i=>v(i,e)));S.push({name:e.name,url:a.uri,size:e.size,type:o,pic:n?a.uri:i.uri,duration:e.duration||0,width:e.width||0,height:e.height||0})}m.value.every((e=>100===e.progress))&&(h.value=!1,null==g||g(S))}catch($){(null==(n=null==$?void 0:$.errMsg)?void 0:n.includes("cancel"))||e.index.$u.toast((null==$?void 0:$.errMsg)||$),m.value=[],h.value=!1}}}};
