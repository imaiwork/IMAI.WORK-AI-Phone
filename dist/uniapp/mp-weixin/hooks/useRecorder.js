"use strict";const e=require("../common/vendor.js"),l=require("../ai_modules/digital_human/common/vendor.js");exports.useRecorder=(a,n)=>{const{type:o="mp3",sampleRate:r=16e3,bitRate:t=32,duration:u=3e5,numberOfChannels:c=1,encodeBitRate:i=64e3,format:s="mp3",frameSize:v=1200}=n||{};n={type:o,sampleRate:r,bitRate:t,duration:u,numberOfChannels:c,encodeBitRate:i,format:s,frameSize:v};const d=e.ref(!1),m=e.shallowRef(),f=()=>{var e,l,a,n,o,r,t,u,c,i,s;m.value&&(null==(e=m.value)||e.stop()),null==(a=null==(l=m.value)?void 0:l.offStart)||a.call(l),null==(o=null==(n=m.value)?void 0:n.offStop)||o.call(n),null==(t=null==(r=m.value)?void 0:r.offError)||t.call(r),null==(c=null==(u=m.value)?void 0:u.offInterruptionEnd)||c.call(u),null==(s=null==(i=m.value)?void 0:i.onFrameRecorded)||s.call(i)},p=()=>{var e,l;null==(l=null==(e=m.value)?void 0:e.close)||l.call(e,(()=>{d.value=!1})),m.value=null};return e.onBeforeUnmount((()=>{f(),p()})),{isRecording:d,mediaRecorder:m,start:async()=>{var o;try{m.value||(m.value=e.index.getRecorderManager()),console.log("start",n),m.value.start(n),d.value=!0,null==(o=null==a?void 0:a.onstart)||o.call(a),m.value.onStart((()=>{var e;d.value=!0,null==(e=null==a?void 0:a.onstart)||e.call(a)})),m.value.onStop((e=>{var l;d.value=!1,null==(l=null==a?void 0:a.onstop)||l.call(a,e)})),m.value.onError((e=>{var l;d.value=!1,null==(l=null==a?void 0:a.onerror)||l.call(a,e)})),m.value.onInterruptionEnd((()=>{d.value=!0,m.value.resume()})),m.value.onFrameRecorded((async({frameBuffer:e})=>{var o;const r=l.jsMp3.newDecoder(e);if(null!=r){const e=r.decode(),l=new Int16Array(e),t=l.length;let u=0;for(let a=0;a<t;a++)u+=Math.abs(l[a]);let c=500*u/(16383*t);c>=100&&(c=100),c<=5&&(c=1),c=parseInt(String(c)),null==(o=null==a?void 0:a.ondata)||o.call(a,{pcmData:l,powerLevel:c,sampleRate:null==n?void 0:n.sampleRate})}}))}catch(r){return console.log(r),Promise.reject(r)}},authorize:()=>new Promise((async(l,a)=>{try{await e.index.authorize({scope:"scope.record"}),l()}catch(n){if((await e.index.showModal({title:"开启麦克风权限",content:"为了正常使用语音输入功能，请开启麦克风权限",confirmText:"去设置"})).confirm){const{authSetting:a}=await e.index.openSetting();if(a["scope.record"])return l()}a("无法录音：用户拒绝了麦克风权限")}})),stop:f,close:p,pause:()=>{var e;null==(e=m.value)||e.pause()},resume:()=>{var e;null==(e=m.value)||e.resume()}}};
