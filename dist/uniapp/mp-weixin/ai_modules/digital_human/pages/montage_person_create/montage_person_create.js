"use strict";const e=require("../../../../common/vendor.js"),r=require("../../../../common/assets.js"),o=require("../../../../api/digital_human.js"),n=require("../../../../stores/user.js"),a=require("../../enums/index.js"),t=require("../../config/index.js"),i=require("../../hooks/useMontageMaterial.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),require("../../../../api/material.js"),require("../../../../hooks/usePolling.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-input")+e.resolveComponent("upload-progress")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+s+l+u+(()=>"../../../../components/upload-progress/upload-progress.js")+c+d+p+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const u=()=>"../../components/upload-rule-pop/upload-rule-pop.js",s=()=>"../../components/choose-history/choose-history.js",l=()=>"../../components/choose-character/choose-character.js",c=()=>"../../../../components/video-preview/video-preview.js",p=()=>"../../components/tokens-cost/tokens-cost.js",d=()=>"../../components/create-success-pop/create-success-pop.js",f=e.defineComponent({__name:"montage_person_create",setup(u){const s=n.useUserStore(),{userTokens:l}=e.toRefs(s),c=e.ref([{step:1,title:"上传视频"},{step:2,title:"填写身份"},{step:3,title:"参考素材"},{step:4,title:"生成设置"}]),p=e.ref(1),d=e.reactive({anchorLists:[],copywriterList:[],materialList:[],name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM")+"真人口播视频智剪",person_name:"",person_introduction:"",video_count:1,shanjian_type:a.MontageTypeEnum.REAL_PERSON_AI}),f=e.ref(!0),m=e.ref(!1),v=e.ref(-1),h=e.ref("video"),g=e.ref(0),_=e.ref(!1),j=e.reactive({pic:"",url:""}),y=e.ref(!1),x=e.ref(!1),L=e.ref(!1),q=e.ref(0),b=e.reactive({poster:"",url:""}),w=e.ref(!1),k=e.ref(null),$=e.ref(!1),C=e.shallowRef(),R=r=>{switch(r){case 1:return d.anchorLists.length>0;case 2:return d.person_name&&d.person_introduction;case 3:if(0===q.value){return!(d.materialList.reduce(((e,r)=>"video"===r.type?e+r.duration:e),0)+d.materialList.filter((e=>"image"===e.type)).length*t.montageConfig.imageDuration>60*t.montageConfig.materialTotalDuration)||(e.index.$u.toast(`素材总时长不能超过${t.montageConfig.materialTotalDuration}分钟`),!1)}return!0;case 4:return!0;default:return!1}},M=e.computed((()=>R(p.value))),V=(r,o)=>{if("prev"!==o)if("next"!==o){if(r!==p.value)if(r<p.value)p.value=r;else{for(let o=1;o<r;o++)if(!R(o))return void e.index.$u.toast("请按顺序完成步骤");p.value=r}}else if(M.value)p.value++;else{const r={1:"请上传视频",2:"请填写人物名称和介绍",3:"请上传至少3个素材"};e.index.$u.toast(r[p.value]||"请完成当前步骤")}else p.value--},{showUploadProgress:z,uploadMaterialList:A,uploadAndProcessFiles:S,handleDeleteMaterial:B}=i.useMontageMaterial({onSuccess:e=>{0==g.value?(-1!==v.value?d.anchorLists[v.value]=e[0]:d.anchorLists=d.anchorLists.concat(e),v.value=-1):(-1!==v.value?d.materialList[v.value]=e[0]:d.materialList=d.materialList.concat(e),v.value=-1)}}),D=r=>{g.value=r,0==r&&e.index.showActionSheet({itemList:['从"创作历史"中选择','从"手机相册"中选择'],success:async e=>{if(0==e.tapIndex&&(_.value=!0),1==e.tapIndex){if(f.value)return f.value=!1,void(m.value=!0);S("video")}}}),1==r&&e.index.showActionSheet({itemList:["选择图片素材","选择视频素材"],success:async e=>{if(h.value=0==e.tapIndex?"image":"video",f.value)return f.value=!1,void(m.value=!0);S(h.value)}})},T=e=>{const r=e.map((e=>({pic:e.pic,url:e.video_result_url,name:e.name,duration:e.duration})));-1!==v.value?d.anchorLists[v.value]=r[0]:d.anchorLists=d.anchorLists.concat(r),v.value=-1,_.value=!1},P=(e,r)=>{v.value=e,D(r)},E=e=>{d.person_name=e.name,d.person_introduction=e.introduced,L.value=!0,x.value=!1},I=r=>{if("minus"===r){if(d.video_count<=1)return void e.index.$u.toast("最少生成1个视频哦");d.video_count--}else{if(d.video_count>=99)return void e.index.$u.toast("最多生成99个视频哦");d.video_count++}},U=async()=>{var r;if(l.value<0)null==(r=C.value)||r.open();else if(d.name)if(d.video_count<=0)e.index.$u.toast("请输入生成视频数量");else{e.index.showLoading({title:"创建中...",mask:!0});try{const r=await o.createShanjianTask({name:d.name,anchor:d.anchorLists.map((e=>({pic:e.pic,anchor_url:e.url,name:e.name,duration:e.duration}))),character_design:[{name:d.person_name,introduced:d.person_introduction}],copywriting:d.copywriterList,material:0===q.value?d.materialList.map((e=>({fileUrl:e.url,type:e.type,cover:e.pic}))):[],shanjian_type:d.shanjian_type,video_count:d.video_count});L.value||o.addShanjianPerson({name:d.person_name,introduced:d.person_introduction}),e.index.hideLoading(),k.value=r,w.value=!0}catch(n){e.index.hideLoading(),e.index.showToast({title:n,icon:"none",duration:3e3})}}else e.index.$u.toast("请输入视频名称")},F=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_publish/montage_publish",type:"redirect",params:{task_id:JSON.stringify([k.value.id]),scene:1,type:d.shanjian_type}})},N=()=>{e.index.$u.route({url:"/packages/pages/creation/creation",type:"redirect"})};return(o,n)=>e.e({a:e.p({title:"真人口播视频混剪","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(c),((r,o,n)=>e.e({a:e.unref(p)>r.step},e.unref(p)>r.step?{b:"4dcd7414-1-"+n,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(r.title),e:r.step!==e.unref(c).length},r.step!==e.unref(c).length?{f:e.unref(p)>r.step?1:""}:{},{g:r.step,h:e.unref(p)==r.step?1:"",i:e.o((e=>V(r.step)),r.step)}))),c:1==e.unref(p)},1==e.unref(p)?{d:e.t(e.unref(d).anchorLists.length),e:e.f(e.unref(d).anchorLists,((r,o,n)=>({a:r.pic,b:e.o((e=>(e=>{j.pic=e.pic,j.url=e.url,y.value=!0})(r)),o),c:"4dcd7414-2-"+n,d:e.o((e=>{return o=r.id,d.anchorLists=d.anchorLists.filter((e=>e.id!==o)),void B(o);var o}),o),e:e.o((e=>P(o,0)),o),f:o}))),f:e.p({name:"close",color:"#ffffff",size:"16"}),g:r._imports_0$6,h:e.o((e=>D(0)))}:{},{i:2===e.unref(p)},2===e.unref(p)?{j:e.o((e=>L.value=!1)),k:e.o((r=>e.unref(d).person_name=r)),l:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物名称",maxlength:"20",modelValue:e.unref(d).person_name}),m:e.o((e=>L.value=!1)),n:e.o((r=>e.unref(d).person_introduction=r)),o:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物介绍",maxlength:"50",modelValue:e.unref(d).person_introduction}),p:r._imports_0$10,q:e.o((e=>x.value=!0))}:{},{r:3==e.unref(p)},3==e.unref(p)?e.e({s:e.t(e.unref(t.montageConfig).materialTotalDuration),t:e.t(e.unref(t.montageConfig).imageDuration),v:e.f(["使用素材","不使用素材"],((r,o,n)=>({a:e.t(r),b:o,c:o==e.unref(q)?1:"",d:e.o((e=>q.value=o),o)}))),w:`translateX(${100*e.unref(q)}%)`,x:0===e.unref(q)},0===e.unref(q)?{y:e.f(e.unref(d).materialList,((o,n,a)=>e.e({a:o.pic,b:"image"===o.type},"image"===o.type?{c:r._imports_0$11}:{d:r._imports_3$5},{e:e.o((r=>(r=>{const{type:o,pic:n,url:a}=r;"image"===o?e.index.previewImage({urls:[n]}):(b.poster=n,b.url=a,y.value=!0)})(o)),n),f:"4dcd7414-5-"+a,g:e.o((e=>{return r=o.id,d.materialList=d.materialList.filter((e=>e.id!==r)),void B(r);var r}),n),h:e.o((e=>P(n,1)),n),i:n}))),z:e.p({name:"close",color:"#ffffff",size:"16"}),A:r._imports_0$6,B:e.o((e=>D(1)))}:{}):{},{C:4==e.unref(p)},4==e.unref(p)?{D:e.o((r=>e.unref(d).name=r)),E:e.p({maxlength:"50","placeholder-style":"font-size:26rpx;",placeholder:"请输入",clearable:!0,modelValue:e.unref(d).name}),F:e.t(e.unref(d).anchorLists.length),G:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),H:e.o((e=>V(1))),I:e.f(e.unref(d).anchorLists,((e,r,o)=>({a:e.pic,b:r}))),J:e.t(e.unref(d).person_name),K:e.t(e.unref(d).person_introduction),L:e.p({name:"arrow-right",size:20,color:"#C5CACA"}),M:e.o((e=>V(2))),N:e.t(e.unref(d).materialList.length),O:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),P:e.o((e=>V(3))),Q:r._imports_1$10,R:e.o((e=>I("minus"))),S:e.o((r=>e.unref(d).video_count=r)),T:e.p({type:"digit",placeholder:"",min:1,max:99,"custom-style":{color:"#0065fb",fontWeight:"bold"},"input-align":"center",modelValue:e.unref(d).video_count}),U:r._imports_2$4,V:e.o((e=>I("add")))}:{},{W:e.unref(p)!=e.unref(c).length},e.unref(p)!=e.unref(c).length?e.e({X:1===e.unref(p)},1===e.unref(p)?{Y:e.t(e.unref(d).anchorLists.length),Z:e.n(e.unref(d).anchorLists.length>0?"bg-black":"bg-_h787878CC_")}:{aa:e.o((r=>V(e.unref(p),"prev")))},{ab:e.n(e.unref(M)?"bg-black":"bg-_h787878CC_"),ac:e.o((r=>V(e.unref(p),"next")))}):{ad:r._imports_3$2,ae:e.o((e=>$.value=!0)),af:e.t(e.unref(d).video_count),ag:e.o(U)},{ah:e.o(T),ai:e.o((r=>e.isRef(_)?_.value=r:null)),aj:e.p({type:3,modelValue:e.unref(_)}),ak:e.o(E),al:e.o((r=>e.isRef(x)?x.value=r:null)),am:e.p({modelValue:e.unref(x)}),an:e.o((r=>e.unref(S)("video"))),ao:e.o((e=>f.value=!1)),ap:e.o((r=>e.isRef(m)?m.value=r:null)),aq:e.p({modelValue:e.unref(m)}),ar:e.o((r=>e.isRef(z)?z.value=r:null)),as:e.p({"upload-list":e.unref(A),modelValue:e.unref(z)}),at:e.o((e=>y.value=!1)),av:e.o((r=>e.isRef(y)?y.value=r:null)),aw:e.p({"video-url":e.unref(j).url,poster:e.unref(j).pic,modelValue:e.unref(y)}),ax:e.o(F),ay:e.o(N),az:e.o((r=>e.isRef(w)?w.value=r:null)),aA:e.p({title:"视频生成中",desc:`本次提交视频 ${e.unref(d).video_count} 条，预计生成时间比较长，您可以先去设置发布任务，也可以等待视频生成成功后再发布`,modelValue:e.unref(w)}),aB:e.o((r=>e.isRef($)?$.value=r:null)),aC:e.p({type:2,modelValue:e.unref($)}),aD:e.sr(C,"4dcd7414-18",{k:"rechargePopupRef"})})}});wx.createPage(f);
