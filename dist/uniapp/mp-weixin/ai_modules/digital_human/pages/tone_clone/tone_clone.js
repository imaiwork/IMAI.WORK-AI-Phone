"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js"),r=require("../../../../api/app.js"),i=require("../../../../api/digital_human.js"),u=require("../../../../hooks/useAudio.js"),a=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),c=require("../../../../enums/appEnums.js"),d=require("../../enums/index.js"),m=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../common/vendor.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("recharge-popup")+e.resolveComponent("popup-bottom"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js")+p+(()=>"../../../../components/popup-bottom/popup-bottom.js"))();const p=()=>"../../components/choose-model/choose-model.js",v=e.defineComponent({__name:"tone_clone",setup(p){const v=s.useAppStore(),f=l.useUserStore(),{userTokens:g}=e.toRefs(f),h=e.computed((()=>{const{channel:e}=v.getDigitalHumanConfig;return e&&e.length>0?e.find((e=>e.id==j.model_version)):{}})),_=e.computed((()=>{var e,o,n;const r={[d.DigitalHumanModelVersionEnum.STANDARD]:null==(e=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[d.DigitalHumanModelVersionEnum.CHANJING]:null==(o=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_CHANJING))?void 0:o.score,[d.DigitalHumanModelVersionEnum.SHANJIAN]:null==(n=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_SHANJIAN))?void 0:n.score};return parseFloat(r[j.model_version])})),j=e.reactive({url:"",name:"",gender:"male",model_version:d.DigitalHumanModelVersionEnum.STANDARD}),q=e.ref(""),x=()=>j.model_version==d.DigitalHumanModelVersionEnum.SHANJIAN?["mp3","wav"]:["mp3","wav","m4a"],w=[{name:"男声",value:"male",icon:o.ManIcon,activeIcon:o.ManActiveIcon},{name:"女声",value:"female",icon:o.WomanIcon,activeIcon:o.WomanActiveIcon}],A=e.ref(!1),y=e.ref(!1),I=e.ref(0),N=e.ref(null),H=e.ref(0),M=e.ref(!1),{setUrl:k,isPlaying:E,play:b,pause:C,destroy:S}=u.useAudio({onError:o=>{"error"==o.type&&o.errMsg.includes("Unable to decode audio data")&&e.index.$u.toast("音频资源异常，建议请重新上传")}}),{authorize:T,isRecording:V,start:$,stop:D,close:F}=a.useRecorder({onstart:()=>{G()},onstop:async e=>{if(M.value)return;const{tempFilePath:o,fileSize:n}=e;H.value<15||U(n)&&(clearInterval(N.value),await O(o),k(o))},onerror:e=>{W()}},{duration:6e4}),B=e.ref(),L=e=>{j.model_version=e},J=()=>{j.url="",q.value="",y.value=!0,M.value=!1,C(),D(),S()},R=async()=>{await P(),k(j.url)},U=o=>!(o>10485760)||(e.index.$u.toast("音频文件大小不能超过10M"),!1),P=async()=>{try{const e=await n.chooseFile({type:"file",extension:x()});await z(e)}catch(e){console.error("选择文件出错:",e)}},z=async o=>{var n;const{tempFiles:r}=o,{size:i,name:u}=r[0],a=null==(n=u.split(".").pop())?void 0:n.toLowerCase();a&&x().includes(a)?U(i)&&await O(r[0].path):e.index.$u.toast(`请上传${x().join("、")}格式的音频文件`)},O=async o=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:n,name:i}=await r.uploadFile("audio",{filePath:o});e.index.hideLoading(),j.url=n,q.value=i,y.value=!1}catch(n){e.index.hideLoading(),e.index.showToast({title:n||"上传失败",icon:"none",duration:3e3})}},G=()=>{W(),N.value=setInterval((()=>{H.value+=1}),1e3)},W=()=>{H.value=0,clearInterval(N.value)},K=async()=>{await T(),V.value||$()},Q=()=>{H.value<15?e.index.$u.toast("录制时间不能少于15秒"):D()},X=()=>{V.value=!1,y.value=!1,M.value=!0,D(),S(),F(),W()},Y=()=>{V.value=!1,y.value=!1,M.value=!1,D(),S(),W(),F()},Z=()=>{I.value=Math.floor(Math.random()*m.cratedVoiceCopywriter.length)},ee=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/clone_manage/clone_manage",type:"redirect"})};return e.onLoad((e=>{e.model_version&&(j.model_version=parseInt(e.model_version))})),(n,r)=>{var u;return e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((o=>e.unref(j).name=o)),c:e.p({placeholder:"请输入音色名称",maxlength:"50",clearable:!0,modelValue:e.unref(j).name}),d:e.t((null==(u=e.unref(h))?void 0:u.name)||"请选择"),e:e.p({name:"arrow-right",color:"#B2B2B2",size:20}),f:e.o((e=>A.value=!0)),g:e.unref(j).model_version!=e.unref(d.DigitalHumanModelVersionEnum).SHANJIAN},e.unref(j).model_version!=e.unref(d.DigitalHumanModelVersionEnum).SHANJIAN?{h:e.f(w,((o,n,r)=>e.e({a:e.unref(j).gender===o.value},e.unref(j).gender===o.value?{b:o.activeIcon}:{c:o.icon},{d:e.t(o.name),e:e.n(e.unref(j).gender===o.value?"border-_h0065FB_ text-primary":"border-_transparent_ text-_h00000080_"),f:n,g:e.o((e=>{return n=o.value,void(j.gender=n);var n}),n)})))}:{},{i:e.unref(j).url},e.unref(j).url?e.e({j:o._imports_0$7,k:e.t(e.unref(q)),l:!e.unref(E)},e.unref(E)?{n:o._imports_1$5}:{m:o._imports_2$2},{o:e.t(e.unref(E)?"暂停":"试听"),p:e.o((e=>(async()=>{E.value?C():b(j.url)})())),q:e.o((o=>{e.unref(j).url="",q.value=""}))}):{r:o._imports_3$3,s:e.o(J),t:o._imports_4$3,v:e.o(R),w:e.t(x().join("、"))},{x:e.unref(_)},e.unref(_)?{y:e.t(e.unref(_))}:{},{z:e.o((o=>(async()=>{var o;if(j.name.trim())if(j.url)if(j.model_version){if(g.value<_.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(o=B.value)||o.open());try{e.index.showLoading({title:"克隆中",mask:!0}),j.model_version==d.DigitalHumanModelVersionEnum.SHANJIAN?await i.shanjianVoiceClone({name:j.name,audio_url:j.url}):await i.voiceClone(j),e.index.hideLoading(),f.getUser(),e.index.hideLoading(),e.index.showToast({title:"克隆成功，请在我的音色中查看",icon:"none",duration:3e3}),setTimeout((()=>{ee()}),1500)}catch(n){e.index.hideLoading(),e.index.showToast({title:n||"克隆失败",icon:"none",duration:3e3})}}else e.index.$u.toast("请选择使用模型");else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请输入音色名称")})())),A:e.sr(B,"14636fc1-3",{k:"rechargePopupRef"}),B:e.o(L),C:e.o((o=>e.isRef(A)?A.value=o:null)),D:e.p({show:e.unref(A)}),E:e.t(e.unref(m.cratedVoiceCopywriter)[e.unref(I)]),F:e.p({name:"reload",color:"#0065FB"}),G:e.o(Z),H:e.unref(V)},e.unref(V)?{I:e.t(e.unref(t.formatAudioTime)(e.unref(H)))}:{},{J:!e.unref(V)},e.unref(V)?{M:e.o(Q)}:{K:o._imports_5,L:e.o(K)},{N:e.o(X),O:e.o(Y),P:e.o((o=>e.isRef(y)?y.value=o:null)),Q:e.p({title:"录制声音","custom-class":"bg-_hF6F6F6_","show-footer":!1,height:"80%",show:e.unref(y)})})}}}),f=e._export_sfc(v,[["__scopeId","data-v-14636fc1"]]);wx.createPage(f);
