"use strict";const e=require("../../common/vendor.js"),a=require("../../stores/user.js"),n=require("../../stores/app.js"),o=require("../../api/chat.js"),i=require("../../enums/appEnums.js"),t=require("../../api/device.js"),s=require("../../config/index.js");if(require("../../api/user.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../hooks/useShareMessage.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("tabbar")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../components/tabbar/tabbar.js")+(()=>"../../components/empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../components/popup-bottom/popup-bottom.js")+(()=>"../../components/recharge-popup/recharge-popup.js"))();const r=e.defineComponent({__name:"index",setup(r){var l;const u=[{key:"ai_customer",name:"AI获客",icon:"index_img_1.png"},{key:"digital_person_clone",name:"数字人克隆",icon:"index_img_2.png"},{key:"publish_img",name:"发布图文",icon:"index_img_3.png"},{key:"publish_video",name:"发布视频",icon:"index_img_4.png"},{key:"my_creation",name:"我的创作",icon:"index_img_5.png"},{key:"ai_puzzle",name:"AI拼图",icon:"index_img_6.png"},{key:"material_library",name:"素材库",icon:"index_img_7.png"},{key:"meeting_minutes",name:"会议助手",icon:"index_img_8.png"}],c=[{key:"digital_person_broadcast",name:"数字人口播",icon:"index_img_9.png"},{key:"oral_video_mix",name:"口播混剪",icon:"index_img_10.png"},{key:"real_person_broadcast",name:"真人口播",icon:"index_img_11.png"},{key:"material_mix",name:"素材混剪",icon:"index_img_12.png"},{key:"one_sentence_generation",name:"一句话生成",icon:"index_img_13.png"},{key:"news_body_generation",name:"新闻体生成",icon:"index_img_14.png"}],_=a=>{const n={create_task:"/ai_modules/device/pages/choose_task_type/choose_task_type",view_schedule:"/ai_modules/device/pages/task_calendar_full/task_calendar_full",dh:"/ai_modules/digital_human/pages/index/index",digital_person_clone:"/ai_modules/digital_human/pages/anchor_create/anchor_create",dh_creation:"/ai_modules/digital_human/pages/choose_create_type/choose_create_type",publish_img:"/ai_modules/device/pages/create_task/create_task?type=2",publish_video:"/ai_modules/device/pages/create_task/create_task?type=1",my_creation:"/packages/pages/creation/creation",ai_customer:"/ai_modules/sph/pages/create_task/create_task",ai_puzzle:"/ai_modules/drawing/pages/index/index",material_library:"/packages/pages/material_library/material_library",meeting_minutes:"/ai_modules/meeting_minutes/pages/index/index",digital_person_broadcast:"/ai_modules/digital_human/pages/szr_create/szr_create",oral_video_mix:"/ai_modules/digital_human/pages/montage_create/montage_create",real_person_broadcast:"/ai_modules/digital_human/pages/montage_person_create/montage_person_create",material_mix:"/ai_modules/digital_human/pages/montage_material_create/montage_material_create",one_sentence_generation:"/ai_modules/digital_human/pages/sora_create/sora_create",news_body_generation:"/ai_modules/digital_human/pages/montage_news_create/montage_news_create",device_config:"/pages/phone/phone",device_bind:"/packages/pages/rpa_code/rpa_code"};e.index.navigateTo({url:n[a]})},g=n.useAppStore(),m=a.useUserStore(),{chatConfig:p}=e.toRefs(g),d=e.computed((()=>g.getWebsiteConfig)),{userTokens:v}=e.toRefs(m),f=null==(l=m.getTokenByScene(i.TokensSceneEnum.CHAT))?void 0:l.score,h=e.ref(),k=e.shallowRef(),y=e.shallowRef(),b=e.ref(50),x=e.ref(!1),w=e.ref(!1),j=e.ref(!1),q=e.ref(!1),C=e.ref(!1),z=e.ref([]),$=e.ref([]),T=e.ref(""),A=e.ref([]),R=e.ref(1);let S=null;const B=e.reactive({page_no:1,page_size:1500,assistant_id:0}),U=e=>{w.value=e},L=async(e,a)=>{var n,i;try{const{lists:i}=await o.getCreativeRecord({page_no:e,page_size:a,scene_id:0,type:1});null==(n=y.value)||n.complete(i)}catch(t){null==(i=y.value)||i.complete([])}},E=async()=>{try{const a=await o.getChatLog({...B,task_id:T.value}),n=null==a?void 0:a.map((e=>1===e.type?{...e,fileList:(null==e?void 0:e.file_info)?Array.isArray(e.file_info)?e.file_info:[e.file_info]:[]}:{...e,is_reasoning_finished:!0,consume_tokens:e.tokens_info}));$.value=n,console.log("chatContentList",$.value),await e.nextTick$1(),k.value.scrollToBottom()}catch(a){console.error("获取聊天记录失败:",a)}},F=async(a,n=!1)=>{var i,t,s;if(v.value<=1)return e.index.$u.toast("算力不足，请充值！"),void(null==(i=h.value)||i.open());if(q.value)return;n||$.value.push({type:1,message:a,fileList:z.value});const r=e.reactive({type:2,loading:!0,reply:"",reasoning_content:"",consume_tokens:{}});$.value.push(r),q.value=!0;try{await o.chatSendTextStream({message:a,task_id:T.value,open_reasoning:0,is_network_search:w.value?1:0,file_info:z.value[0],...(null==(s=null==(t=k.value)?void 0:t.getChatConfig)?void 0:s.call(t))||{}},{onstart(e){S=e,C.value=!0},onmessage(e){K(e,r)},onclose(){M(r)}})}catch(l){H(l,r)}e.nextTick$1((()=>k.value.scrollToBottom()))},K=(e,a)=>{e.trim().split("data:").forEach((e=>{if(e)try{const{object:n,content:o,task_id:i,usage:t,reasoning_content:s}=JSON.parse(e);if((o||s)&&"loading"===n&&(s?a.reasoning_content+=s:a.reply+=o),"finished"===n)return a.loading=!1,a.consume_tokens=t,void(T.value||(T.value=i));k.value.scrollToBottom()}catch(n){console.error("解析流式消息失败:",n)}}))},M=e=>{e.loading=!1,D(),m.getUser(),setTimeout((()=>k.value.scrollToBottom()),600)},H=(a,n)=>{n.reply=600004===a.errno?"用户已停止内容生成":a||"发生错误",600004!==a.errno&&e.index.$u.toast(a),n.loading=!1,D()},I=()=>{T.value?(T.value="",$.value=[],D(),N(),F(p.value.new_chat_prompt,!0)):e.index.$u.toast("当前会话已经是最新的了")},D=()=>{z.value=[],q.value=!1,C.value=!1},J=()=>{$.value=[],D(),N()},N=()=>{null==S||S.abort(),q.value=!1,C.value=!1};return e.onMounted((()=>{const{safeArea:a}=e.index.$u.sys();b.value=a.top})),e.onLoad((a=>{(null==a?void 0:a.task_id)&&(T.value=a.task_id,E()),(async a=>{var n,o;await e.nextTick$1(),(null==a?void 0:a.agent_name)&&(null==(n=k.value)||n.setAgentConfig({name:a.agent_name,id:a.agent_id,avatar:a.agent_logo}),x.value=!0,await e.nextTick$1(),null==(o=k.value)||o.openKeyboard());try{const{count:e}=await t.getDeviceList({page_no:1,page_size:1});R.value=e>0?2:3}catch(i){R.value=3}})(a),e.index.$on("chooseFile",(e=>{z.value=e}))})),e.onUnload((()=>{var a;e.index.$off("chooseFile"),null==(a=k.value)||a.hideKeyboard()})),e.onHide((()=>{var e;null==(e=k.value)||e.hideKeyboard()})),e.onShow((()=>{g.getChatConfig()})),(a,n)=>e.e({a:e.unref($).length>0},e.unref($).length>0?{b:e.p({name:"arrow-left",size:32})}:{},{c:0==e.unref($).length},0==e.unref($).length?{d:e.unref(d).shop_logo,e:e.t(e.unref(d).shop_name)}:{},{f:e.p({"border-bottom":!1,"is-fixed":!1,"is-back":e.unref($).length>0,background:{background:"transparent"},"is-custom-back-icon":!0,"custom-back":J}),g:!e.unref(x)},e.unref(x)?{}:e.e({h:0==e.unref($).length},0==e.unref($).length?e.e({i:1!=e.unref(R)},1!=e.unref(R)?{j:e.t(2==e.unref(R)?"一键开启托管":"请先绑定设备"),k:e.p({name:"arrow-right",size:16})}:{},{l:`${e.unref(s.config).baseUrl}static/images/robot.webp`,m:e.o((a=>_(1==e.unref(R)?"device_bind":"device_config"))),n:`url(${e.unref(s.config).baseUrl}static/images/home_banner_bg.png)`,o:e.o((e=>_("create_task"))),p:e.o((e=>_("view_schedule"))),q:e.p({name:"arrow-right",size:20,color:"#0000004d"}),r:`${e.unref(s.config).baseUrl}static/images/index_img_15.png`,s:e.o((e=>_("dh_creation"))),t:e.f(u,((a,n,o)=>({a:`${e.unref(s.config).baseUrl}static/images/${a.icon}`,b:e.t(a.name),c:a.key,d:e.o((e=>_(a.key)),a.key)}))),v:e.p({name:"arrow-right",size:20,color:"#0000004d"}),w:e.f(c,((a,n,o)=>({a:e.t(a.name),b:`${e.unref(s.config).baseUrl}static/images/${a.icon}`,c:a.key,d:e.o((e=>_(a.key)),a.key)})))}):{}),{x:e.sr(k,"66e90c04-2",{k:"chattingRef"}),y:e.o(N),z:e.o(I),A:e.o(U),B:e.o(F),C:e.o((e=>j.value=!0)),D:e.o((a=>e.isRef(z)?z.value=a:null)),E:e.p({placeholder:"发送消息、输入@选择智能体","is-stop":e.unref(C),"content-list":e.unref($),"send-disabled":e.unref(q),tokens:e.unref(f),"file-list":e.unref(z)}),F:0===e.unref($).length},(e.unref($).length,{}),{G:e.f(e.unref(A),((a,n,o)=>({a:e.t(a.create_time),b:e.t(a.message||a.file_info.name),c:n,d:e.o((e=>(async e=>{var a;const{robot_id:n,avatar:o,robot_name:i,task_id:t}=e;null==(a=k.value)||a.setAgentConfig({id:n,avatar:o,name:i}),T.value=t,await E(),j.value=!1})(a)),n)}))),H:e.sr(y,"66e90c04-8,66e90c04-7",{k:"pagingRef"}),I:e.o(L),J:e.o((a=>e.isRef(A)?A.value=a:null)),K:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(A)}),L:e.o((a=>e.isRef(j)?j.value=a:null)),M:e.p({title:"历史记录","is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",modelValue:e.unref(j)}),N:e.sr(h,"66e90c04-10",{k:"rechargePopupRef"})})}});wx.createPage(r);
