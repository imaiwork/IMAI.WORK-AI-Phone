import{Q as ht,S as at,O as dt,d as ut,c as h,A as ct,r as B,o as mt,D as _t,b as xt,b8 as bt,k as J,l as Z,H as yt,a3 as wt,aa as kt,aS as Ct,an as St,au as At,z as Mt,bP as It,en as ot,m as L,q as V,s as X,Z as w,al as Bt,t as nt,a8 as $t,v as Et,J as ft,K as Rt,L as Tt,bM as zt,eo as Wt,u as Pt,G as pt,ep as lt,ay as Nt}from"./entry.556496e9.js";import{E as Lt}from"./index.4bb9b943.js";import{_ as Ft}from"./chatting.9296e1c5.js";/* empty css                     */import{I as Ht,J as Ot,K as Ut,L as jt}from"./agent.4a5bb123.js";import{_ as Dt}from"./pwd-check.vue.b1310463.js";import"./index.vue.9bac0f96.js";import"./debounce.0430f44a.js";import"./toNumber.844d22bd.js";import"./index.3864ff87.js";import"./katex.3347b9ac.js";import"./el-image.2c371257.js";import"./el-image-viewer.97d3022d.js";import"./throttle.ede6b671.js";import"./index.65c6aa54.js";/* empty css                    */import"./index.899f58ef.js";import"./index.ef7246b4.js";import"./strings.09a7c832.js";import"./_baseIteratee.4a27397d.js";import"./clamp.b3f2460d.js";import"./index.c754b099.js";/* empty css                  *//* empty css               */import"./useCopy.daab2575.js";import"./cloneDeep.3bea7aa0.js";import"./el-slider.3edc03f9.js";import"./el-input-number.fadfd561.js";import"./index.e9eda615.js";import"./el-switch.316f10b8.js";import"./index.a390bc0e.js";/* empty css                   */const Gt=ht({zIndex:{type:Number,default:9},rotate:{type:Number,default:-22},width:Number,height:Number,image:String,content:{type:at([String,Array]),default:"Element Plus"},font:{type:at(Object)},gap:{type:at(Array),default:()=>[100,100]},offset:{type:at(Array)}});function qt(f){return f.replace(/([A-Z])/g,"-$1").toLowerCase()}function Xt(f){return Object.keys(f).map(a=>`${qt(a)}: ${f[a]};`).join(" ")}function Yt(){return window.devicePixelRatio||1}const Kt=(f,a)=>{let l=!1;return f.removedNodes.length&&a&&(l=Array.from(f.removedNodes).includes(a)),f.type==="attributes"&&f.target===a&&(l=!0),l},Vt={left:[0,.5],start:[0,.5],center:[.5,0],right:[1,-.5],end:[1,-.5]};function it(f,a,l=1){const c=document.createElement("canvas"),u=c.getContext("2d"),i=f*l,m=a*l;return c.setAttribute("width",`${i}px`),c.setAttribute("height",`${m}px`),u.save(),[u,c,i,m]}function Jt(){function f(a,l,c,u,i,m,F,O,U){const[p,j,_,$]=it(u,i,c);let H=0;if(a instanceof HTMLImageElement)p.drawImage(a,0,0,_,$);else{const{color:C,fontSize:I,fontStyle:P,fontWeight:N,fontFamily:st,textAlign:Q,textBaseline:tt}=m,Y=Number(I)*c;p.font=`${P} normal ${N} ${Y}px/${i}px ${st}`,p.fillStyle=C,p.textAlign=Q,p.textBaseline=tt;const K=dt(a)?a:[a];if(tt!=="top"&&K[0]){const et=p.measureText(K[0]);p.textBaseline="top";const rt=p.measureText(K[0]);H=et.actualBoundingBoxAscent-rt.actualBoundingBoxAscent}K==null||K.forEach((et,rt)=>{const[vt,gt]=Vt[Q];p.fillText(et??"",_*vt+U*gt,rt*(Y+m.fontGap*c))})}const S=Math.PI/180*Number(l),x=Math.max(u,i),[E,b,n]=it(x,x,c);E.translate(n/2,n/2),E.rotate(S),_>0&&$>0&&E.drawImage(j,-_/2,-$/2);function R(C,I){const P=C*Math.cos(S)-I*Math.sin(S),N=C*Math.sin(S)+I*Math.cos(S);return[P,N]}let T=0,D=0,A=0,G=0;const M=_/2,q=$/2;[[0-M,0-q],[0+M,0-q],[0+M,0+q],[0-M,0+q]].forEach(([C,I])=>{const[P,N]=R(C,I);T=Math.min(T,P),D=Math.max(D,P),A=Math.min(A,N),G=Math.max(G,N)});const e=T+n/2,o=A+n/2,s=D-T,v=G-A,d=F*c,r=O*c,y=(s+d)*2,k=v+r,[z,g]=it(y,k);function W(C=0,I=0){z.drawImage(b,e,o,s,v,C,I+H,s,v)}return W(),W(s+d,-v/2-r/2),W(s+d,+v/2+r/2),[g.toDataURL(),y/c,k/c]}return f}const Zt=ut({name:"ElWatermark"}),Qt=ut({...Zt,props:Gt,setup(f){const a=f,l={position:"relative"},c=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontGap)!=null?e:3}),u=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.color)!=null?e:"rgba(0,0,0,.15)"}),i=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontSize)!=null?e:16}),m=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontWeight)!=null?e:"normal"}),F=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontStyle)!=null?e:"normal"}),O=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontFamily)!=null?e:"sans-serif"}),U=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.textAlign)!=null?e:"center"}),p=h(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.textBaseline)!=null?e:"hanging"}),j=h(()=>a.gap[0]),_=h(()=>a.gap[1]),$=h(()=>j.value/2),H=h(()=>_.value/2),S=h(()=>{var t,e;return(e=(t=a.offset)==null?void 0:t[0])!=null?e:$.value}),x=h(()=>{var t,e;return(e=(t=a.offset)==null?void 0:t[1])!=null?e:H.value}),E=()=>{const t={zIndex:a.zIndex,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat"};let e=S.value-$.value,o=x.value-H.value;return e>0&&(t.left=`${e}px`,t.width=`calc(100% - ${e}px)`,e=0),o>0&&(t.top=`${o}px`,t.height=`calc(100% - ${o}px)`,o=0),t.backgroundPosition=`${e}px ${o}px`,t},b=ct(null),n=ct(),R=B(!1),T=()=>{n.value&&(n.value.remove(),n.value=void 0)},D=(t,e)=>{var o;b.value&&n.value&&(R.value=!0,n.value.setAttribute("style",Xt({...E(),backgroundImage:`url('${t}')`,backgroundSize:`${Math.floor(e)}px`})),(o=b.value)==null||o.append(n.value),setTimeout(()=>{R.value=!1}))},A=t=>{let e=120,o=64,s=0;const{image:v,content:d,width:r,height:y,rotate:k}=a;if(!v&&t.measureText){t.font=`${Number(i.value)}px ${O.value}`;const z=dt(d)?d:[d];let g=0,W=0;z.forEach(I=>{const{width:P,fontBoundingBoxAscent:N,fontBoundingBoxDescent:st,actualBoundingBoxAscent:Q,actualBoundingBoxDescent:tt}=t.measureText(I),Y=Ct(N)?Q+tt:N+st;P>g&&(g=Math.ceil(P)),Y>W&&(W=Math.ceil(Y))}),e=g,o=W*z.length+(z.length-1)*c.value;const C=Math.PI/180*Number(k);s=Math.ceil(Math.abs(Math.sin(C)*o)/2),e+=s}return[r??e,y??o,s]},G=Jt(),M=()=>{const e=document.createElement("canvas").getContext("2d"),o=a.image,s=a.content,v=a.rotate;if(e){n.value||(n.value=document.createElement("div"));const d=Yt(),[r,y,k]=A(e),z=g=>{const[W,C]=G(g||"",v,d,r,y,{color:u.value,fontSize:i.value,fontStyle:F.value,fontWeight:m.value,fontFamily:O.value,fontGap:c.value,textAlign:U.value,textBaseline:p.value},j.value,_.value,k);D(W,C)};if(o){const g=new Image;g.onload=()=>{z(g)},g.onerror=()=>{z(s)},g.crossOrigin="anonymous",g.referrerPolicy="no-referrer",g.src=o}else z(s)}};return mt(()=>{M()}),_t(()=>a,()=>{M()},{deep:!0,flush:"post"}),xt(()=>{T()}),bt(b,t=>{R.value||t.forEach(e=>{Kt(e,n.value)&&(T(),M())})},{attributes:!0,subtree:!0,childList:!0}),(t,e)=>(J(),Z("div",{ref_key:"containerRef",ref:b,style:wt([l])},[yt(t.$slots,"default")],4))}});var te=kt(Qt,[["__file","watermark.vue"]]);const ee=St(te),ae={class:"h-screen"},oe={class:"px-4 h-full"},ne={class:"h-full flex flex-col items-center justify-center"},se=["src"],re={class:"text-[32px] font-bold mt-4"},le={class:"text-[#7b7b7b] mt-[10px] text-xs w-[383px] mx-auto text-center"},ie={class:"flex items-center gap-3"},ce={key:0},ue={class:"flex pb-3 gap-3"},fe=["onClick"],pe={class:"text-xs text-[#7b7b7b] text-center mt-2 line-clamp-1"},Ge=ut({__name:"[key]",setup(f){const a=At(),l=Mt(),u=It().params.key,i=B([]),m=B(!1),F=B(!1),O=ct(),U=async()=>{try{const{lists:t}=await Ot({share_apikey:u,identity:l.visitorId,page_size:25e3},{password:n.value,authorization:u,identity:l.visitorId});i.value=t.map(e=>e.type==1?{...e,message:e.content}:{...e,reply:e.content,form_avatar:x.value.image}),_()}catch(t){return t=="访问密码错误!"&&(D(),await R()),Promise.reject()}};let p=null;const j=async t=>{await l.getFingerprint(),await R();const e=Date.now();i.value.push({type:1,message:t,reasoning:""}),i.value.push({type:2,reply:"",reasoning:"",loading:!0,key:e,form_avatar:x.value.image});const o=i.value.find(s=>s.key===e);m.value=!0,_();try{await Wt({question:t,unique_id:A.value,stream:!0},{password:n.value,authorization:u,identity:l.visitorId},{onstart:s=>{p=s,F.value=!0},onmessage:s=>{s.trim().split("data:").forEach(v=>{if(v)try{const{object:d,content:r,task_id:y,usage:k}=JSON.parse(v);d==="loading"?o.reply+=r:d==="finished"&&(o.loading=!1,o.consume_tokens=k),_()}catch(d){console.error("解析流式消息失败:",d,"原始文本:",v)}})},onclose:()=>{o.loading=!1,m.value=!1,F.value=!1,_()}})}catch{o.loading=!1,m.value=!1,o.reply="请求失败，请重试"}},_=()=>{setTimeout(()=>{O.value.scrollToBottom()},100)},$=()=>{Pt().$confirm({title:"提示",message:"确定要清空聊天记录吗？",onConfirm:async()=>{if(m.value&&H(),i.value.length==0){pt.msgError("没有聊天记录");return}try{await Ht({},{password:n.value,authorization:u,identity:l.visitorId}),await U()}catch(t){pt.msgError(t)}}})},H=()=>{if(p==null||p.cancel(),m.value){const t=i.value[i.value.length-1];t.loading=!1,m.value=!1,F.value=!1}},S=B({}),x=B({}),E=B([]),b=B(!1);B();const n=B(""),R=()=>{const t=ot(lt,{});if(n.value=t.value[u]||"",S.value.pwd&&!n.value)return b.value=!0,Promise.reject()},T=async t=>{const e=ot(lt,{});n.value=t.password,e.value=Object.assign(e.value,{[u]:t.password}),b.value=!1,await U()},D=()=>{const t=ot(lt,{});t.value=Object.assign(t.value,{[u]:""})},A=ot("SHARE_CHAT_UNIQUE_ID",""),G=async()=>{if(A.value)return;const t=await jt({robot_id:S.value.robot.id},{password:n.value,authorization:u,identity:l.visitorId});A.value=t[0]},M=async()=>{const t=await Ut({apikey:u});S.value=t,x.value=t.robot,E.value=t.menus,R(),G()},q=async()=>{await M(),await U()};return mt(async()=>{await l.getFingerprint(),q()}),(t,e)=>{const o=Nt,s=Lt,v=Ft,d=ee;return J(),Z(ft,null,[L("div",ae,[V(d,{class:"h-full",content:w(a).getWebsiteConfig.shop_name,"z-index":-1,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:X(()=>[L("div",oe,[V(v,{ref_key:"chattingRef",ref:O,"is-stop":w(F),"content-list":w(i),"send-disabled":w(m),"is-disabled-humanize":!0,"is-new-chat":!1,"is-auth-login":!1,onClose:H,onContentPost:j},Bt({content:X(()=>{var r,y,k;return[L("div",ne,[L("img",{src:(r=w(x))==null?void 0:r.image,class:"w-[112px] h-[112px] rounded-full"},null,8,se),L("div",re,nt((y=w(x))==null?void 0:y.name),1),L("div",le,nt((k=w(x))==null?void 0:k.welcome_introducer),1)])]}),"chat-area-top":X(()=>[L("div",ie,[V(o,{round:"",icon:w($t),onClick:$,class:"mb-3"},{default:X(()=>[...e[2]||(e[2]=[Et("清空",-1)])]),_:1},8,["icon"]),w(E).length>0?(J(),Z("div",ce,[V(s,null,{default:X(()=>[L("div",ue,[(J(!0),Z(ft,null,Rt(w(E),(r,y)=>(J(),Z("div",{class:"whitespace-nowrap rounded-[24px] py-2 px-4 bg-white border border-[#F1F1F2] text-xs cursor-pointer hover:bg-[#F1F1F2]",key:y,onClick:k=>j(r)},nt(r),9,fe))),128))])]),_:1})])):Tt("",!0)])]),_:2},[w(x).copyright?{name:"chat-area-bottom",fn:X(()=>[L("div",pe,nt(w(x).copyright),1)]),key:"0"}:void 0]),1032,["is-stop","content-list","send-disabled"])])]),_:1},8,["content"])]),V(Dt,{show:w(b),"onUpdate:show":e[0]||(e[0]=r=>zt(b)?b.value=r:null),ref:"pwdCheckRef",onClose:e[1]||(e[1]=r=>b.value=!1),onConfirm:T},null,8,["show"])],64)}}});export{Ge as default};
