import{bP as B,z as D,au as U,bQ as b,A as F,ai as j,bR as O,G as k,bS as q,bO as z,bC as G}from"./entry.9c858de7.js";import{useChatStore as J}from"./chat.149a4778.js";import{useChatEventBus as Q}from"./useChatEventBus.9a258b07.js";function ae(){const A=B(),a=J(),S=D(),E=U(),{triggerHistoryRefresh:H}=Q(),{taskId:o,agentValue:h,chatContentList:c,isReceiving:p,isStopChat:N,isDeep:m,isNetwork:C,fileLists:g,extraParams:P}=b(a),{userTokens:Y,userInfo:M}=b(S),{chatConfig:L}=E,f=F(null),w=F(null),r=()=>{j(()=>{var e;return(e=f.value)==null?void 0:e.scrollToBottom()})},R=()=>{z({task_id:void 0,agent_name:void 0,agent_id:void 0})},x=e=>{e.trim().split("data:").forEach(t=>{var s,_;if(t){try{const{object:u,content:i,task_id:l,usage:d,reasoning_content:v}=JSON.parse(t);if(l&&!o.value){const n=c.value[0];H({taskId:l,message:n==null?void 0:n.message,createTime:G().format("YYYY-MM-DD HH:mm:ss")}),a.setTaskId(l),z({task_id:l,agent_name:(s=h.value)==null?void 0:s.name,agent_id:(_=h.value)==null?void 0:_.id})}const I=c.value[c.value.length-1];if(u==="loading"){const n={};v?(n.is_reasoning_finished=!1,n.reasoning_content=(I.reasoning_content||"")+v):i&&(n.is_reasoning_finished=!0,n.reply=(I.reply||"")+i),a.updateLastMessage(n)}else u==="finished"&&a.updateLastMessage({consume_tokens:d})}catch{}r()}})},T=async()=>{if(!(!o.value||o.value==="undefined")){a.isLoading=!0;try{const e=await O({page_no:1,page_size:9999,task_id:o.value,assistant_id:0}),t=(e==null?void 0:e.map(s=>s.type===1?{...s,form_avatar:M.value.avatar,fileList:s!=null&&s.file_info?Array.isArray(s.file_info)?s.file_info:[s.file_info]:[]}:{...s,is_reasoning_finished:!0,form_avatar:a.detail.logo,consume_tokens:s.tokens_info}))??[];a.chatContentList=t,r()}finally{a.isLoading=!1}}},y=async(e,t=!1,s)=>{var u,i,l;if(Y.value<=1)return k.msgPowerInsufficient();if(p.value||!e.trim()&&g.value.length===0)return;t||a.addMessage({type:1,message:e,form_avatar:M.value.avatar,fileList:g.value});const _={type:2,loading:!0,form_avatar:a.detail.logo,is_reasoning_finished:m.value,error:"",reply:"",reasoning_content:"",consume_tokens:{}};a.addMessage(_),a.startReceiving(),r();try{await q({message:e,task_id:o.value,robot_id:(u=h.value)==null?void 0:u.id,open_reasoning:m.value?1:0,is_network_search:C.value?1:0,file_info:g.value.length?g.value[0]:void 0,...((l=(i=f.value)==null?void 0:i.getChatConfig)==null?void 0:l.call(i))||{},...P.value},{onstart:d=>{w.value=d},onmessage:x,onclose:()=>{a.updateLastMessage({loading:!1}),a.stopReceiving(),a.clearFiles(),S.getUser(),r(),s==null||s()}})}catch(d){const v=d||"消息发送失败";a.updateLastMessage({error:v,loading:!1}),k.msgError(v),a.stopReceiving()}finally{r()}};return{chattingRef:f,isDeep:m,isNetwork:C,fileLists:g,taskId:o,chatContentList:c,isReceiving:p,isStopChat:N,initialize:async()=>{a.clearChat();const{content:e,task_id:t}=A.query;e?(await y(e),R()):t&&t!=="undefined"&&(a.setTaskId(t),await T()),r()},sendMessage:y,startNewChat:()=>{var e,t,s;if(!o.value)return k.msgError("当前已是新会话");a.clearChat(),R(),(t=(e=f.value)==null?void 0:e.cleanInput)==null||t.call(e),(s=L.value)!=null&&s.new_chat_prompt&&y(L.value.new_chat_prompt,!0)},stopStream:()=>{var e;if((e=w.value)==null||e.cancel(),p.value){const t=c.value[c.value.length-1];a.updateLastMessage({loading:!1,reply:t.reply||"用户已停止内容生成"}),a.stopReceiving()}},chatScrollToBottom:r,resetScroll:()=>{var e;return(e=f.value)==null?void 0:e.resetScroll()},fetchChatHistory:T,setFiles:a.setFiles,clearFiles:a.clearFiles}}export{ae as useChatManager};
