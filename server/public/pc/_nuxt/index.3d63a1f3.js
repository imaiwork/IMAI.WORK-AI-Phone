import{E as ce}from"./index.a9758b4e.js";import{_ as de}from"./index.vue.9ca81df6.js";import{_ as ue}from"./chatting.9296e1c5.js";import{d as pe,z as me,aH as fe,dv as _e,bP as ve,r as h,aG as S,A as ge,D as he,o as xe,b as ye,k as y,l as b,m,q as A,s as B,Z as l,I as ke,al as be,t as N,J as H,K as we,L as P,G as D,eC as Ce,bO as O,ai as L,eD as Te,bR as Ee,_ as Se}from"./entry.556496e9.js";/* empty css                 */import{C as Le}from"./ChatArea.720f2dd5.js";import{KnTypeEnum as M}from"./index.5bd136e1.js";import Re from"./sidebar.c9228701.js";import"./index.vue.9bac0f96.js";import"./debounce.0430f44a.js";import"./toNumber.844d22bd.js";import"./index.3864ff87.js";import"./katex.3347b9ac.js";import"./el-image.2c371257.js";import"./el-image-viewer.97d3022d.js";import"./throttle.ede6b671.js";import"./index.65c6aa54.js";/* empty css                    */import"./index.899f58ef.js";import"./index.4bb9b943.js";import"./index.ef7246b4.js";import"./strings.09a7c832.js";import"./_baseIteratee.4a27397d.js";import"./clamp.b3f2460d.js";import"./index.c754b099.js";/* empty css                  *//* empty css               *//* empty css                     */import"./useCopy.daab2575.js";import"./cloneDeep.3bea7aa0.js";import"./el-slider.3edc03f9.js";import"./el-input-number.fadfd561.js";import"./index.e9eda615.js";import"./el-switch.316f10b8.js";import"./index.a390bc0e.js";/* empty css                   */import"./index.40cc82f2.js";const Ie={class:"flex h-full w-full flex-col"},qe={class:"grow flex min-h-0 gap-4"},Ae={class:"h-full relative"},Be={class:"grow h-full relative rounded-xl py-4"},Ne={class:"pt-5 h-full mr-4 px-4"},Pe={key:0,class:"flex items-center justify-center flex-col h-full w-full md:max-w-3xl lg:max-w-[42rem] xl:max-w-[48rem] 2xl:max-w-[52rem] mx-auto text-center"},De={class:"mb-3"},Oe=["src"],Ue={key:1,class:"w-12 h-12"},Ve={class:"text-center text-2xl font-semibold"},je={class:"text-base"},Fe={class:"mx-3 mt-12 flex md:max-w-3xl lg:max-w-[42rem] xl:max-w-[48rem] 2xl:max-w-[52rem] flex-wrap items-stretch justify-center gap-4"},Ke=["onClick"],$e={class:"line-clamp-3 text-balance text-gray-600 break-all"},ze=pe({__name:"index",setup(Ge){var G;const w=me(),{userTokens:W,userInfo:U,isLogin:V}=fe(w),Z=(G=w.getTokenByScene(_e.SCENE_CHAT))==null?void 0:G.score,x=ve(),j=h(""),c=S({id:"",name:"",logo:"",form_info:"",description:"",template_info:{},preliminary_ask:[],assistants_id:""}),Q=ge(),C=h(!1),X=e=>{d.value=[],j.value=e.assistant_id,$()},d=h([]);let F=null;const v=h(!1),f=h(null),T=h(!1),R=h([]),_=h(""),Y=S({page_no:1,page_size:1500}),k=S({indexid:"",rerank_min_score:"",kb_id:""}),ee=e=>{const{type:a,data:o}=e;a==M.RAG?(k.indexid=o.index_id,k.rerank_min_score=o.rerank_min_score,k.kb_id=void 0):a==M.VECTOR&&(k.kb_id=o.id,k.indexid=void 0,k.rerank_min_score=void 0)},te=async()=>{try{const e=await Ee({...Y,assistant_id:x.query.id,task_id:_.value}),a=e==null?void 0:e.map(o=>o.type==1?{...o,form_avatar:U.value.avatar}:{...o,consume_tokens:o.tokens_info||{},form_avatar:c.logo});d.value=a}catch{}},se=e=>{R.value=e};let i;const K=h(null),ae=()=>{var o;const{template_info:e}=c,a=(o=e==null?void 0:e.form)==null?void 0:o.filter(t=>t.name=="WidgetSelect").map(t=>({dialogTitle:t.props.title,key:t.props.field,options:t.props.options.map((n,s)=>({id:s+1,name:n}))}));i=new Le({elm:K.value,placeholder:"请输入你要的内容",needCallEvery:!1,selectList:a}),i.addEventListener("enterSend",()=>{E(i.getText())}),i.addEventListener("operate",t=>{v.value=i.isEmpty(),f.value.setInput(i.getText())}),i.addEventListener("defaultAction",t=>{switch(t){case"CUT":f.value.setInput("");break}}),e!=null&&e.form&&!_.value&&oe(c.form_info,e.form),f.value.setInput(i.getText())},oe=(e,a,o,t)=>{ne(e,a).forEach(s=>{if(s.type==="text")i.insertText(s.content);else if(s.type==="variable"){const u=s.content;if(u.name=="WidgetSelect"){const p=u.props.options.map((r,g)=>({id:g+1,name:r}));p.length&&i.setSelectTag({id:p[0].id,name:p[0].name},u.props.field)}else i.setInputTag(u.props.field,u.props.title,u.props.default)}})},ne=(e,a)=>{const o={};a.forEach(r=>{o[r.props.field]=r});const t=[],n=/\$\{(\w+)\}/g;let s;for(;(s=n.exec(e))!==null;){const r=s[1],g=o[r];g&&t.push({name:r,variable:g,start:s.index,end:s.index+s[0].length})}t.sort((r,g)=>r.start-g.start);const u=[];let p=0;return t.forEach(r=>{p<r.start&&u.push({type:"text",content:e.substring(p,r.start)}),u.push({type:"variable",content:r.variable}),p=r.end}),p<e.length&&u.push({type:"text",content:e.substring(p)}),u},E=async(e,a=!1,o=!1)=>{if(!V.value){w.toggleShowLogin();return}if(W.value<=0){D.msgPowerInsufficient();return}if(v.value)return;v.value=!0,!a&&!o&&d.value.push({type:1,message:i.getText()||e,from_avatar:U.value.avatar,fileLists:R.value});const t=S({type:2,loading:!0,reply:"",is_reasoning_finished:!1,reasoning_content:"",error:"",from_avatar:c.logo,consume_tokens:{}});d.value.push(t),i.clear(),f.value.setInput("");try{await Ce({message:i.getText()||e||"",assistant_id:x.query.id,task_id:_.value,...k},{onstart(n){F=n,T.value=!0},onmessage(n){n.trim().split("data:").forEach((s,u)=>{if(s!=="")try{const p=JSON.parse(s),{object:r,content:g,task_id:J,reasoning_content:q,usage:le}=p;if((g||q)&&r==="loading"&&(q?(t.is_reasoning_finished=!1,t.reasoning_content+=q):(t.is_reasoning_finished=!0,t.reply+=g)),r==="finished"){t.loading=!1,t.consume_tokens={...le},_.value||(_.value=J),O({task_id:J||""});return}}catch{}})},async onclose(){t.loading=!1,I(),setTimeout(async()=>{await L(),f.value.scrollToBottom()},600),w.getUser()}})}catch(n){if(n&&n.type=="cancel")return;t.loading=!1,t.error=n||"发生错误",I(),D.msgError(n||"发生错误")}L(()=>{var n;(n=f==null?void 0:f.value)==null||n.scrollToBottom()})},ie=()=>{if(!_.value){D.msgError("当前会话已经是最新的了");return}_.value="",d.value=[],I(),O({ppid:x.query.ppid,pid:x.query.pid,id:x.query.id,task_id:""}),E("你好",!0)},I=()=>{R.value=[],v.value=!1,T.value=!1},re=e=>{var a;F.cancel(),d.value[d.value.length-1].loading=!1,v.value=!1,T.value=!1,d.value[e]&&!((a=d.value[e])!=null&&a.reply)&&(d.value[e].reply="用户已停止内容生成")},$=async()=>{const e=await Te({assistant_id:j.value||x.query.id});Object.keys(c).forEach(a=>{c[a]=e[a]})},z=async()=>{V.value||O({task_id:""});try{_.value=x.query.task_id,v.value||(C.value=!0,await $(),C.value=!1,_.value&&_.value!=="undefined"&&(await te(),await L(),f.value.scrollToBottom()),await L(),ae())}catch{C.value=!1}};return he(()=>x.params,()=>{$request.cancelRequest(),v.value=!1,z()}),xe(()=>{z()}),ye(()=>{i&&(i.dispose(),i=null)}),(e,a)=>{const o=ce,t=de,n=ue;return y(),b("div",Ie,[m("div",qe,[A(o,{width:"220px"},{default:B(()=>{var s;return[m("div",Ae,[A(Re,{ref_key:"sidebarConfigRef",ref:Q,"form-list":(s=l(c).template_info)==null?void 0:s.form,detail:{logo:l(c).logo,name:l(c).name,description:l(c).description},"is-lock":l(v),onChangeScene:X},null,8,["form-list","detail","is-lock"])])]}),_:1}),m("div",Be,[m("div",Ne,[l(C)?P("",!0):(y(),ke(n,{key:0,ref_key:"chattingRef",ref:f,"is-stop":l(T),"content-list":l(d),"send-disabled":l(v),tokens:l(Z),onClose:re,onContentPost:E,"onUpdate:fileLists":se,onNewChat:ie,onConfirmKnb:ee},be({input:B(()=>[m("div",{ref_key:"chatAreaRef",ref:K,class:"min-h-[30px] max-h-[200px] overflow-y-auto dynamic-scroller"},null,512)]),_:2},[l(d).length?void 0:{name:"content",fn:B(()=>[l(d).length?P("",!0):(y(),b("div",Pe,[m("div",De,[l(c).logo?(y(),b("img",{key:0,src:l(c).logo,class:"w-12 h-12"},null,8,Oe)):(y(),b("div",Ue,[A(t,{"icon-size":28})]))]),m("div",Ve,N(l(c).name),1),m("div",je,N(l(c).description),1),m("div",null,[m("div",Fe,[(y(!0),b(H,null,we(l(c).preliminary_ask,(s,u)=>(y(),b(H,null,[s.value?(y(),b("button",{key:0,class:"relative flex w-40 flex-col gap-2 rounded-2xl border border-token-border-light px-3 pb-4 pt-3 text-start align-top text-[15px] shadow-[0_0_2px_0_rgba(0,0,0,0.05),0_4px_6px_0_rgba(0,0,0,0.02)] transition hover:bg-token-main-surface-secondary",onClick:p=>E(s.value)},[m("div",$e,N(s.value),1)],8,Ke)):P("",!0)],64))),256))])])]))]),key:"0"}]),1032,["is-stop","content-list","send-disabled","tokens"]))])])])])}}});const Rt=Se(ze,[["__scopeId","data-v-7b1f7084"]]);export{Rt as default};
