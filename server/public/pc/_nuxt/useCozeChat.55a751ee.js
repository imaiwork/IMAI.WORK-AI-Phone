import{u as G}from"./usePolling.fc11778b.js";import{d as L,e as M,f as U,h as j}from"./agent.4a5bb123.js";import{z as H,aH as J,r as v,A as N,c as O,aG as V,G as h}from"./entry.556496e9.js";function K(m,g){const p=H(),{userInfo:A}=J(p),f=v([]),l=v(!1),r=v(!1),y=N(null),t=v(""),_=O(()=>{var e;return((e=m.value)==null?void 0:e.stream)==1}),R=async(e,w,z,E)=>{var k;f.value.push({type:1,message:e,form_avatar:A.value.avatar,...w});const s=V({type:2,loading:!0,form_avatar:(k=m.value)==null?void 0:k.avatar,reply:"",consume_tokens:{}});f.value.push(s),l.value=!0;const I={id:g,content:e,conversation_id:t.value,...w},S=!t.value;if(_.value)try{await L(I,{onstart:a=>{y.value=a,r.value=!0},onmessage:a=>{a.trim().split("data:").forEach(c=>{if(c)try{const{object:n,content:u,usage:i,conversation_id:o}=JSON.parse(c);u&&n==="loading"&&(s.reply+=u),n==="finished"&&(s.loading=!1,s.consume_tokens={total_tokens:i.token_count},o&&t.value!==o&&(t.value=o,z(o)))}catch{}})},onclose:()=>{s.loading=!1,p.getUser(),l.value=!1,r.value=!1,S&&E({id:t.value,title:e,conversation_id:t.value,content:e})}})}catch(a){s.loading=!1,s.reply=a||"发生错误",h.msgError(a||"发生错误"),l.value=!1,r.value=!1}else try{r.value=!0;const{conversation_id:a,id:c}=await M(I);a&&t.value!==a&&(t.value=a,z(a));const n={id:g,conversation_id:t.value},{start:u,end:i}=G(async()=>{try{const{status:o,id:P}=await U({chat_id:c,...n});if(o==="completed"){i();const d=await j({chat_id:P,...n});d&&d.length&&d.forEach(b=>s.reply+=b.content),s.loading=!1,C(),S&&E({id:t.value,title:e,conversation_id:t.value,content:e})}else if(o==="failed")throw i(),new Error("聊天失败")}catch{throw i(),s.loading=!1,s.reply="聊天失败，请稍后重试",new Error("聊天失败")}},{});u()}catch(a){s.loading=!1,s.reply=a||"发生错误",h.msgError(a||"发生错误"),C()}},C=()=>{l.value=!1,r.value=!1};return{chatContentList:f,isReceiving:l,isStopChat:r,sendMessage:R,stopChat:()=>{var e;_.value?((e=y.value)==null||e.cancel(),l.value=!1,r.value=!1):h.msgWarning("直接返回类型，聊天不可取消~")},setConversationId:e=>{t.value=e}}}export{K as useCozeChat};
