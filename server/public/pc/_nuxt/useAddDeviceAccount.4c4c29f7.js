import{r as d,el as _,G as m,e9 as E}from"./entry.8705b591.js";import{n as z,o as x}from"./service.557e9b35.js";import{i as H}from"./device.b8ac970d.js";var K=(e=>(e.AddDevice="addDevice",e.AddAccount="addAccount",e.UpdateAccount="updateAccount",e.BatchUpdateAccount="batchUpdateAccount",e))(K||{});const Y=e=>{const{send:G,onEvent:R}=e,A=d(!1),f=d(!1),S=d(null),u=d(0),r=d(null),w=d([]),n=d(null),o=(c,a)=>{G({type:_.GET_USER_INFO,content:{deviceId:c},deviceId:c,appType:a})};R("success",async c=>{var i,U,b,k,O,P,C,M;const{type:a,content:l,deviceId:I,appType:g}=c,y=l.msg||"";switch(a){case _.ADD_DEVICE:S.value={status:1,device_code:l.deviceId,device_model:l.deviceModel,sdk_version:l.sdkVersion};try{m.loading("添加中..."),await H(S.value),m.msgSuccess("添加设备成功"),(i=e.onSuccess)==null||i.call(e,{msg:"添加成功",type:a,data:c})}catch(s){(U=e.onError)==null||U.call(e,{error:s,type:a,code:E.API_ERROR})}finally{f.value=!1,A.value=!1,m.closeLoading()}break;case _.GET_USER_INFO:try{const{account:s,account_no:L,extra:J,avatar:j,nickname:q}=l,v={account:s,account_no:L,avatar:j,device_code:I,type:g,nickname:q,extra:JSON.stringify(J)},T=async()=>{const t=w.value.filter(D=>D.type==v.type).find(D=>D.account==v.account);t?await z({id:t.id,...v}):await x(v)};try{const t=n.value;t==="addAccount"?(await x(v),A.value=!1,m.msgSuccess("添加账号成功"),(b=e.onSuccess)==null||b.call(e,{msg:"添加账号成功",type:a,data:c})):t==="updateAccount"?(await T(),u.value=100,m.msgSuccess("更新成功"),(k=e.onSuccess)==null||k.call(e,{msg:"更新成功",type:a,data:c})):t==="batchUpdateAccount"&&(await T(),(O=e.onSuccess)==null||O.call(e,{msg:"批量更新成功",type:a,data:c}))}catch(t){(P=e.onError)==null||P.call(e,{error:t,type:a,code:E.API_ERROR})}}catch(s){(C=e.onError)==null||C.call(e,{error:s,type:a,code:E.API_ERROR})}f.value=!1,clearInterval(r.value);break;default:(M=e.onSuccess)==null||M.call(e,{msg:y,type:a,data:c});break}}),R("error",c=>{var a;f.value=!1,(a=e.onError)==null||a.call(e,c),r.value&&clearInterval(r.value)});const N=()=>{},V=(c,a)=>{n.value="updateAccount",h(),o(c,a)},B=c=>{n.value="batchUpdateAccount",o(c.device_code,c.type)},F=c=>{n.value="addAccount",h(),o(c.device_code,c.type)},h=()=>{r.value&&(clearInterval(r.value),r.value=null);const c=Date.now(),a=15*1e3,l=300,I=2;u.value=0,r.value=setInterval(()=>{const g=Date.now()-c,y=Math.min(I,Math.random()*(99-u.value)*.1);u.value=Math.floor(Math.min(99,u.value+y)),(u.value>=99||g>=a)&&(r.value&&(clearInterval(r.value),r.value=null),u.value=99)},l)};return{showAddDevice:A,addDeviceLoading:f,progressValue:u,eventAction:n,refreshAccount:w,handleAddDeviceConfirm:N,handleAddAccount:F,handleRefreshAccount:V,handleBatchUpdateAccount:B,completeProgress:h}};export{K as E,Y as u};
