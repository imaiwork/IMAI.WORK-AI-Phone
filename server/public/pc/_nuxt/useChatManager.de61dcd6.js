import{bP as B,z as D,au as U,bQ as b,A as F,ai as j,bR as O,G as S,bS as q,bO as z,bC as G}from"./entry.45b56a4a.js";import{useChatStore as J}from"./chat.f4618dc3.js";import{useChatEventBus as Q}from"./useChatEventBus.2cbae9d6.js";function ae(){const A=B(),a=J(),C=D(),E=U(),{triggerHistoryRefresh:H}=Q(),{taskId:i,agentValue:p,chatContentList:c,isReceiving:m,isStopChat:N,isDeep:y,isNetwork:M,fileLists:f,extraParams:P}=b(a),{userTokens:Y,userInfo:w}=b(C),{chatConfig:L}=E,g=F(null),_=F(null),r=()=>{j(()=>{var e;return(e=g.value)==null?void 0:e.scrollToBottom()})},R=()=>{z({task_id:void 0,agent_name:void 0,agent_id:void 0})},x=e=>{e.trim().split("data:").forEach(t=>{var s,h;if(t){try{const{object:u,content:l,task_id:o,usage:d,reasoning_content:v}=JSON.parse(t);if(o&&!i.value){const n=c.value[0];n&&H({taskId:o,message:n==null?void 0:n.message,createTime:G().format("YYYY-MM-DD HH:mm:ss")}),a.setTaskId(o),z({task_id:o,agent_name:(s=p.value)==null?void 0:s.name,agent_id:(h=p.value)==null?void 0:h.id})}else if(o&&o!==i.value)return;const I=c.value[c.value.length-1];if(u==="loading"){const n={};v?(n.is_reasoning_finished=!1,n.reasoning_content=(I.reasoning_content||"")+v):l&&(n.is_reasoning_finished=!0,n.reply=(I.reply||"")+l),a.updateLastMessage(n)}else u==="finished"&&a.updateLastMessage({consume_tokens:d})}catch{}r()}})},T=async()=>{if(!(!i.value||i.value==="undefined")){a.isLoading=!0;try{const e=await O({page_no:1,page_size:9999,task_id:i.value,assistant_id:0}),t=(e==null?void 0:e.map(s=>s.type===1?{...s,form_avatar:w.value.avatar,fileList:s!=null&&s.file_info?Array.isArray(s.file_info)?s.file_info:[s.file_info]:[]}:{...s,is_reasoning_finished:!0,form_avatar:a.detail.logo,consume_tokens:s.tokens_info}))??[];a.chatContentList=t,r()}finally{a.isLoading=!1}}},k=async(e,t=!1,s)=>{var u,l,o;if(Y.value<=1)return S.msgPowerInsufficient();if(m.value||!e.trim()&&f.value.length===0)return;t||a.addMessage({type:1,message:e,form_avatar:w.value.avatar,fileList:f.value});const h={type:2,loading:!0,form_avatar:a.detail.logo,is_reasoning_finished:y.value,error:"",reply:"",reasoning_content:"",consume_tokens:{}};a.addMessage(h),a.startReceiving(),r();try{await q({message:e,task_id:i.value,robot_id:(u=p.value)==null?void 0:u.id,open_reasoning:y.value?1:0,is_network_search:M.value?1:0,file_info:f.value.length?f.value[0]:void 0,...((o=(l=g.value)==null?void 0:l.getChatConfig)==null?void 0:o.call(l))||{},...P.value},{onstart:d=>{_.value=d},onmessage:x,onclose:()=>{a.updateLastMessage({loading:!1}),a.stopReceiving(),a.clearFiles(),C.getUser(),r(),s==null||s()}})}catch(d){const v=d||"消息发送失败";a.updateLastMessage({error:v,loading:!1}),S.msgError(v),a.stopReceiving()}finally{r()}};return{chattingRef:g,isDeep:y,isNetwork:M,fileLists:f,taskId:i,chatContentList:c,isReceiving:m,isStopChat:N,initialize:async()=>{a.clearChat();const{content:e,task_id:t}=A.query;e?(await k(e),R()):t&&t!=="undefined"&&(a.setTaskId(t),await T()),r()},sendMessage:k,startNewChat:()=>{var e,t,s;if(!i.value)return S.msgError("当前已是新会话");a.clearChat(),R(),(t=(e=g.value)==null?void 0:e.cleanInput)==null||t.call(e),(s=L.value)!=null&&s.new_chat_prompt&&k(L.value.new_chat_prompt,!0)},stopStream:async()=>{if(_.value&&(await _.value.cancel(),_.value=null),m.value){const e=c.value[c.value.length-1];a.updateLastMessage({loading:!1,reply:e.reply||"用户已停止内容生成"}),a.stopReceiving()}},chatScrollToBottom:r,resetScroll:()=>{var e;return(e=g.value)==null?void 0:e.resetScroll()},fetchChatHistory:T,setFiles:a.setFiles,clearFiles:a.clearFiles}}export{ae as useChatManager};
