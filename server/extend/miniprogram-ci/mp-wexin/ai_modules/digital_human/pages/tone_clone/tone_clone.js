"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js"),r=require("../../../../api/app.js"),i=require("../../../../api/digital_human.js"),u=require("../../../../hooks/useAudio.js"),a=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),d=require("../../../../enums/appEnums.js"),c=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../common/vendor.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("recharge-popup")+e.resolveComponent("popup-bottom"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js")+m+(()=>"../../../../components/popup-bottom/popup-bottom.js"))();const m=()=>"../../components/choose-model/choose-model.js",p=e.defineComponent({__name:"tone_clone",setup(m){const p=s.useAppStore(),v=l.useUserStore(),{userTokens:f}=e.toRefs(v),h=e.computed((()=>{const{channel:e}=p.getDigitalHumanConfig;return e&&e.length>0?e.find((e=>e.id==_.model_version)):{}})),g=e.computed((()=>{var e,o,n;const r={[d.DigitalHumanModelVersionEnum.STANDARD]:null==(e=v.getTokenByScene(d.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[d.DigitalHumanModelVersionEnum.CHANJING]:null==(o=v.getTokenByScene(d.TokensSceneEnum.HUMAN_VOICE_CHANJING))?void 0:o.score,[d.DigitalHumanModelVersionEnum.SHANJIAN]:null==(n=v.getTokenByScene(d.TokensSceneEnum.HUMAN_VOICE_SHANJIAN))?void 0:n.score};return parseFloat(r[_.model_version])})),_=e.reactive({url:"",name:"",model_version:d.DigitalHumanModelVersionEnum.STANDARD}),j=e.ref(""),q=()=>_.model_version==d.DigitalHumanModelVersionEnum.SHANJIAN?["mp3","wav"]:["mp3","wav","m4a"],x=e.ref(!1),w=e.ref(!1),y=e.ref(0),A=e.ref(null),k=e.ref(0),C=e.ref(!1),{setUrl:N,isPlaying:E,play:H,pause:M,destroy:S}=u.useAudio({onError:o=>{"error"==o.type&&o.errMsg.includes("Unable to decode audio data")&&e.index.$u.toast("音频资源异常，建议请重新上传")}}),{authorize:b,isRecording:I,start:T,stop:V,close:$}=a.useRecorder({onstart:()=>{P()},onstop:async e=>{if(C.value)return;const{tempFilePath:o,fileSize:n}=e;k.value<15||R(n)&&(clearInterval(A.value),await z(o),N(o))},onerror:e=>{O()}},{duration:6e4}),D=e.ref(),F=e=>{_.model_version=e},L=()=>{_.url="",j.value="",w.value=!0,C.value=!1,M(),V(),S()},B=async()=>{await J(),N(_.url)},R=o=>!(o>10485760)||(e.index.$u.toast("音频文件大小不能超过10M"),!1),J=async()=>{try{const e=await n.chooseFile({type:"file",extension:q()});await U(e)}catch(e){console.error("选择文件出错:",e)}},U=async o=>{var n;const{tempFiles:r}=o,{size:i,name:u}=r[0],a=null==(n=u.split(".").pop())?void 0:n.toLowerCase();a&&q().includes(a)?R(i)&&await z(r[0].path):e.index.$u.toast(`请上传${q().join("、")}格式的音频文件`)},z=async o=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:n,name:i}=await r.uploadFile("audio",{filePath:o});e.index.hideLoading(),_.url=n,j.value=i,w.value=!1}catch(n){e.index.hideLoading(),e.index.showToast({title:n||"上传失败",icon:"none",duration:3e3})}},P=()=>{O(),A.value=setInterval((()=>{k.value+=1}),1e3)},O=()=>{k.value=0,clearInterval(A.value)},G=async()=>{await b(),I.value||T()},K=()=>{k.value<15?e.index.$u.toast("录制时间不能少于15秒"):V()},Q=()=>{I.value=!1,w.value=!1,C.value=!0,V(),S(),$(),O()},W=()=>{I.value=!1,w.value=!1,C.value=!1,V(),S(),O(),$()},X=()=>{y.value=Math.floor(Math.random()*c.cratedVoiceCopywriter.length)},Y=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/clone_manage/clone_manage",type:"redirect"})};return e.onLoad((e=>{e.model_version&&(_.model_version=parseInt(e.model_version))})),(n,r)=>{var u;return e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((o=>e.unref(_).name=o)),c:e.p({placeholder:"请输入音色名称",maxlength:"50",clearable:!0,modelValue:e.unref(_).name}),d:e.t((null==(u=e.unref(h))?void 0:u.name)||"请选择"),e:e.p({name:"arrow-right",color:"#B2B2B2",size:20}),f:e.o((e=>x.value=!0)),g:e.unref(_).url},e.unref(_).url?e.e({h:o._imports_0$7,i:e.t(e.unref(j)),j:!e.unref(E)},e.unref(E)?{l:o._imports_1$5}:{k:o._imports_2$2},{m:e.t(e.unref(E)?"暂停":"试听"),n:e.o((e=>(async()=>{E.value?M():H(_.url)})())),o:e.o((o=>{e.unref(_).url="",j.value=""}))}):{p:o._imports_3$3,q:e.o(L),r:o._imports_4$3,s:e.o(B),t:e.t(q().join("、"))},{v:e.unref(g)},e.unref(g)?{w:e.t(e.unref(g))}:{},{x:e.o((o=>(async()=>{var o;if(_.name.trim())if(_.url)if(_.model_version){if(f.value<g.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(o=D.value)||o.open());try{e.index.showLoading({title:"克隆中",mask:!0}),_.model_version==d.DigitalHumanModelVersionEnum.SHANJIAN?await i.shanjianVoiceClone({name:_.name,audio_url:_.url}):await i.voiceClone(_),e.index.hideLoading(),v.getUser(),e.index.hideLoading(),e.index.showToast({title:"克隆成功，请在我的音色中查看",icon:"none",duration:3e3}),setTimeout((()=>{Y()}),1500)}catch(n){e.index.hideLoading(),e.index.showToast({title:n||"克隆失败",icon:"none",duration:3e3})}}else e.index.$u.toast("请选择使用模型");else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请输入音色名称")})())),y:e.sr(D,"3da21135-3",{k:"rechargePopupRef"}),z:e.o(F),A:e.o((o=>e.isRef(x)?x.value=o:null)),B:e.p({modelValue:e.unref(x)}),C:e.t(e.unref(c.cratedVoiceCopywriter)[e.unref(y)]),D:e.p({name:"reload",color:"#0065FB"}),E:e.o(X),F:e.unref(I)},e.unref(I)?{G:e.t(e.unref(t.formatAudioTime)(e.unref(k)))}:{},{H:!e.unref(I)},e.unref(I)?{K:e.o(K)}:{I:o._imports_5,J:e.o(G)},{L:e.o(Q),M:e.o(W),N:e.o((o=>e.isRef(w)?w.value=o:null)),O:e.p({title:"录制声音","custom-class":"bg-_hF6F6F6_","show-footer":!1,height:"80%",modelValue:e.unref(w)})})}}}),v=e._export_sfc(p,[["__scopeId","data-v-3da21135"]]);wx.createPage(v);
