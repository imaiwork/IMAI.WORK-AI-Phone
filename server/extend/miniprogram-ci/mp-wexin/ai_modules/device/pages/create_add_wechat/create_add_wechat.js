"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),r=require("../../../../api/device.js"),u=require("../../enums/index.js"),a=require("../../../../components/file-upload/choose-file.js"),n=require("../../../../api/app.js"),s=require("../../../../stores/app.js"),o=require("../../../../api/person_wechat.js"),i=require("../../../../hooks/useDictOptions.js"),l=require("../../../../hooks/useEventBusManager.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../config/index.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("data-select")+e.resolveComponent("u-input")+e.resolveComponent("upload-progress")+e.resolveComponent("u-popup")+e.resolveComponent("confirm-dialog"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+c+(()=>"../../../../components/empty/empty.js")+(()=>"../../../../components/data-select/data-select.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+f+(()=>"../../../../components/upload-progress/upload-progress.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/confirm-dialog/confirm-dialog.js"))();const c=()=>"../../components/clue-card/clue-card.js",f=()=>"../../components/bast-setting-v2/bast-setting-v2.js",p=e.defineComponent({__name:"create_add_wechat",setup(c){const{on:f}=l.useEventBusManager(),p=s.useAppStore(),d=e.ref([{step:1,title:"选择线索"},{step:2,title:"调设置"},{step:3,title:"设定时间"}]),m=e.ref(1),v=e.computed((()=>p.config.wechat_remarks||[])),h=e.reactive({name:`自动加好友任务${e.index.$u.timeFormat(new Date,"yyyymmddhhMM")}`,crawling_task_ids:[],add_number:1,add_interval_time:5,remarks:v.value||[],add_remark_enable:1,add_friends_prompt:"",source:1,fileurl:"",add_type:"1",wechat_id:[],wechat_reg_type:0,time_config:["09:00","09:30"],task_frep:1,device_codes:[],custom_date:[]}),_=e.ref([]),g=e.ref([]),x=e.ref(!1),j=[1,3,5,10,15],w=[5,10,15,20],y=e.ref(0),q=e.ref(),b=e.ref(!1),k=e.ref(""),C=e.ref(-1),E=e.ref(0),$=e.ref(""),L=e.ref(!1),{optionsData:z}=i.useDictOptions({wechatLists:{api:o.getWeChatLists,params:{page_size:9999},transformData:e=>{var t;return null==(t=e.lists)?void 0:t.map((e=>({text:e.wechat_nickname,value:e.wechat_id})))}}}),V=e.computed((()=>M(m.value))),M=e=>{switch(e){case 1:return _.value.length>0;case 2:return 0!=h.wechat_id.length&&(!(4==y.value&&!q.value)&&(h.add_remark_enable=0==h.remarks.length?0:1,!0));case 3:return!0;default:return!1}},T=(t,r)=>{if("prev"!==r)if("next"!==r){if(t!==m.value)if(t<m.value)m.value=t;else{for(let r=1;r<t;r++)if(!M(r))return void e.index.$u.toast("请按顺序完成步骤");m.value=t}}else if(V.value)m.value++;else{const t={1:"请至少添加一个线索",3:"请设定时间"};e.index.$u.toast(t[m.value]||"请完成当前步骤")}else m.value--},D=(e,t)=>{const r=g.value.findIndex((e=>e.tempFilePath===t.tempFilePath));-1!==r&&(g.value[r]={...g.value[r],progress:e})},A=()=>{e.index.showActionSheet({itemList:["从聊天记录中选择文件（需要符合模板）","从获客任务中选择线索"],success:async t=>{if(0===t.tapIndex)try{g.value=[];const{tempFiles:t}=await a.chooseFile({type:"file",extension:[".csv",".xlsx"],count:1}),r=[];for(const u of t)u.size>20971520?e.index.$u.toast("文件大小不能超过20M"):r.push(u);if(0===r.length)return;g.value=r,x.value=!0;for(const e of g.value){const t=await n.uploadFile("file",{filePath:e.path},(t=>D(t,e)));2==h.source&&(h.source=1),_.value.length=0,_.value.push({url:t.uri,name:e.name,size:e.size,file_type:1})}g.value.every((e=>100===e.progress))&&(x.value=!1)}catch(r){e.index.$u.toast(r),g.value=[],x.value=!1}else e.index.navigateTo({url:"/ai_modules/device/pages/wechat_clue/wechat_clue"})},fail:e=>{console.log(e)}})},F=e=>{b.value=!0,C.value=e??-1,e>-1&&(k.value=h.remarks[e])},O=()=>{-1==C.value?h.remarks.push(k.value):h.remarks[C.value]=k.value,C.value=-1,b.value=!1},R=()=>{b.value=!1,k.value="",C.value=-1},S=()=>{L.value=!1,e.index.$u.route({url:"/pages/phone/phone",type:"reLaunch"})},I=async()=>{if(!h.name)return e.index.$u.toast("请输入任务名称"),!1;if(0==h.device_codes.length)return e.index.$u.toast("请选择设备"),!1;if(5!==E.value||h.custom_date.length){if(!h.time_config[0]||!h.time_config[1])return e.index.$u.toast("请选择时间"),!1;e.index.showLoading({title:"创建中...",mask:!0});try{await r.createManualAddWechat({...h,crawling_task_ids:2==h.source?_.value.map((e=>e.id)):[],fileurl:1==h.source?_.value[0].url:"",time_config:[`${h.time_config[0]}-${h.time_config[1]}`],add_interval_time:4==y.value?q.value:h.add_interval_time}),e.index.hideLoading(),L.value=!0}catch(t){$.value=t,e.index.hideLoading(),e.index.showToast({title:t,icon:"none",duration:3e3})}}else e.index.$u.toast("请选择任务日期")};return e.watch((()=>p.config.wechat_remarks),(e=>{h.remarks=e||[]})),e.onLoad((()=>{f("confirm",(e=>{const{type:t,data:r}=e;if(t===u.ListenerTypeEnum.WECHAT_CLUE&&r&&r.length>0&&(1==h.source&&(_.value=[],h.fileurl="",h.source=2),_.value=_.value.concat(r)),t===u.ListenerTypeEnum.CHOOSE_DATE){if(0===r.length)return;h.custom_date=r,E.value=5}if(t===u.ListenerTypeEnum.CHOOSE_DEVICE){if(0===r.length)return;h.device_codes=r}}))})),(r,u)=>e.e({a:e.p({"title-bold":!0,title:"自动加好友","border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),b:e.f(e.unref(d),((t,r,u)=>e.e({a:e.unref(m)>t.step},e.unref(m)>t.step?{b:"ad78b166-1-"+u,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(d).length},t.step!==e.unref(d).length?{f:e.unref(m)>t.step?1:""}:{},{g:t.step,h:e.unref(m)==t.step?1:"",i:e.o((e=>T(t.step)),t.step)}))),c:1===e.unref(m)},1===e.unref(m)?e.e({d:t._imports_0$35,e:e.o(A),f:e.t(e.unref(_).length),g:e.unref(_).length},e.unref(_).length?{h:e.f(e.unref(_),((t,r,u)=>({a:"ad78b166-2-"+u,b:e.o((e=>(e=>{_.value.splice(e,1)})(r)),r),c:"ad78b166-3-"+u,d:e.p({data:t,type:t.file_type}),e:r}))),i:e.p({name:"close",size:"20",color:"#ffffff"})}:{j:e.p({size:260,text:"您还没有添加任务哦"})}):{},{k:2===e.unref(m)},2===e.unref(m)?e.e({l:e.o((t=>e.unref(h).wechat_id=t)),m:e.p({multiple:!0,localdata:e.unref(z).wechatLists,modelValue:e.unref(h).wechat_id}),n:e.o((t=>e.unref(h).wechat_reg_type=t)),o:e.p({clear:!1,localdata:[{text:"全部",value:0},{text:"微信号",value:1},{text:"手机号",value:2}],modelValue:e.unref(h).wechat_reg_type}),p:e.f(j,((t,r,u)=>({a:e.t(t),b:r,c:e.unref(h).add_number==t?1:"",d:e.o((e=>(e=>{h.add_number=e})(t)),r)}))),q:e.f(w,((t,r,u)=>({a:e.t(t),b:r,c:e.unref(y)==r?1:"",d:e.o((e=>((e,t)=>{y.value=t,h.add_interval_time=e})(t,r)),r)}))),r:4==e.unref(y)},4==e.unref(y)?{s:e.o((e=>y.value=4)),t:e.o((t=>e.isRef(q)?q.value=t:null)),v:e.p({type:"digit",height:"20",placeholder:"请输入","placeholder-style":"color: #00000080;font-size: 24rpx;",modelValue:e.unref(q)})}:{},{w:4==e.unref(y)?1:"",x:e.o((e=>y.value=4)),y:t._imports_1$21,z:e.o((e=>F(-1))),A:e.f(e.unref(h).remarks,((t,r,u)=>({a:e.t(t),b:"ad78b166-8-"+u,c:e.o((e=>(e=>{h.remarks.splice(e,1)})(r)),r),d:r,e:e.o((e=>F(r)),r)}))),B:e.p({name:"close",size:"16",color:"#ffffff"})}):{},{C:3===e.unref(m)},3===e.unref(m)?{D:e.o((e=>E.value=e)),E:e.o((t=>e.isRef(h)?h.value=t:null)),F:e.p({"current-frequency":e.unref(E),modelValue:e.unref(h)})}:{},{G:e.unref(m)!=e.unref(d).length},e.unref(m)!=e.unref(d).length?e.e({H:1===e.unref(m)},1===e.unref(m)?{I:e.t(e.unref(_).length),J:e.n(e.unref(_).length>0?"bg-primary":"bg-_h787878CC_")}:{K:e.o((t=>T(e.unref(m),"prev")))},{L:e.n(e.unref(V)?"bg-primary":"bg-_h787878CC_"),M:e.o((t=>T(e.unref(m),"next")))}):{N:e.o(I)},{O:e.o((t=>e.isRef(x)?x.value=t:null)),P:e.p({"upload-list":e.unref(g),modelValue:e.unref(x)}),Q:e.o((t=>e.isRef(k)?k.value=t:null)),R:e.p({placeholder:"请输入备注内容",maxlength:"100","placeholder-style":"color: #0000004d; font-size: 26rpx;",modelValue:e.unref(k)}),S:e.o(R),T:e.o(O),U:e.o((t=>e.isRef(b)?b.value=t:null)),V:e.p({mode:"center",width:"90%","border-radius":20,modelValue:e.unref(b)}),W:e.o(S),X:e.o(S),Y:e.o((t=>e.isRef(L)?L.value=t:null)),Z:e.p({center:!0,"confirm-text":"确定",content:"创建成功，回到首页？","show-close":!1,modelValue:e.unref(L)})})}}),d=e._export_sfc(p,[["__scopeId","data-v-ad78b166"]]);wx.createPage(d);
