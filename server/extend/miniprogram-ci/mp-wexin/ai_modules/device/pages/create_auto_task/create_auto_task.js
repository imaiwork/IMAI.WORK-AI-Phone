"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),a=require("../../../../api/device.js"),i=require("../../../../enums/appEnums.js"),r=require("../../../../hooks/useKeyboardHeight.js"),u=require("../../hooks/useDeviceWs.js"),n=require("../../hooks/useDevice.js"),s=require("../../stores/material.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),require("../../../../hooks/useWebSocket.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("video-preview"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/video-preview/video-preview.js"))();const o=e.defineComponent({__name:"create_auto_task",setup(o){const{platformLogo:c}=n.useDevice(),{send:l,onEvent:d,close:m,isConnected:v}=u.useDeviceWs(),{dynamicHeight:f,hideKeyboard:p}=r.useKeyboardHeight(),h=s.useMaterialStore(),{anchorList:g,videoList:_,imageList:y}=e.storeToRefs(h),j=e.ref(!0),q=e.ref(),x=e.ref({}),k=e.ref(1),T=e.ref([{step:1,title:"获取账号"},{step:2,title:"运营方向"},{step:3,title:"素材预设"}]),b=e.reactive({clue:"",videoTheme:"",imageTheme:""}),w=e.ref(Object.values(c)),L=e.ref(!1),D=e.ref([]),E=e.ref(!1),C=e.ref({url:"",pic:""}),$=e.computed((()=>I(k.value))),A=e.computed((()=>w.value.every((e=>e.active)))),I=e=>{switch(e){case 1:return w.value.some((e=>e.active));case 2:return b.clue&&b.videoTheme&&b.imageTheme;case 3:return!0;default:return!1}},S=(t,a)=>{if("prev"!==a)if("next"!==a){if(t!==k.value)if(t<k.value)k.value=t;else{for(let a=1;a<t;a++)if(!I(a))return void e.index.$u.toast("请按顺序完成步骤");k.value=t}}else if($.value)k.value++;else{const t={1:"请获取账号",2:"请输入相关关键词"};e.index.$u.toast(t[k.value]||"请完成当前步骤")}else k.value--},F=(e=!1)=>{let t;t=e?w.value.map((e=>e.type)):w.value.filter((e=>!e.active)).map((e=>e.type)),D.value=t,w.value.forEach((t=>{D.value.includes(t.type)&&(t.status=0,e&&(t.active=!1))})),L.value=!0,O()},O=()=>{e.index.showLoading({title:"获取中...",mask:!0});const t=w.value.find((e=>D.value.includes(e.type)&&0===e.status));t&&(t.status=1,z(t.type))},z=e=>{l({type:i.DeviceCmdEnum.GET_USER_INFO,content:{deviceId:q.value},deviceId:q.value,appType:e})},B=e=>{C.value={url:e.url,pic:e.pic},E.value=!0},M=t=>{e.index.$u.route({url:{anchor_material:"/ai_modules/device/pages/anchor_material/anchor_material",video_material:"/ai_modules/device/pages/video_material/video_material",image_material:"/ai_modules/device/pages/image_material/image_material"}[t]})},R=async()=>{if(h.anchorList.length)if(h.videoList.length)if(h.imageList.length){e.index.showLoading({title:"创建中...",mask:!0});try{const t={device_code:q.value,text_theme:b.imageTheme,video_theme:b.videoTheme,human_image:h.anchorList.map((e=>({...e.anchor_ids,...e.extra_info,id:e.id,pic:e.pic,voice_id:e.extra_info.shanjian_voice_id,anchor_url:e.result_url}))),clip_material:h.videoList.map((e=>({type:e.type,fileUrl:e.url,cover:e.pic}))),image_material:h.imageList.map((e=>e.url))},i=await a.createAutoTask({...t,clue_theme:b.clue});await a.createAutoTaskPublishConfig({...t,device_config_id:i.id}),e.index.hideLoading(),e.index.showToast({title:"创建成功",icon:"none",duration:3e3}),setTimeout((()=>{e.index.$u.route({url:"/ai_modules/device/pages/auto_task/auto_task",type:"reLaunch",params:{device_code:q.value}})}),3e3)}catch(t){e.index.hideLoading(),e.index.showToast({title:t||"创建失败",icon:"none",duration:3e3})}}else e.index.$u.toast("请选择图文素材");else e.index.$u.toast("请选择视频素材");else e.index.$u.toast("请选择形象")},U=async()=>{e.index.showLoading({title:"加载中...",mask:!0});try{const e=await a.getDeviceDetail({device_code:q.value});await H(),x.value=e;const{accounts:t}=e;w.value=Object.values(c).sort(((e,a)=>{const i=t.some((t=>t.type===e.type)),r=t.some((e=>e.type===a.type));return i&&!r?-1:!i&&r?1:0})).map((e=>{const a=t.find((t=>t.type==e.type));return{...e,...a,active:!!a,status:a?2:0}}))}finally{j.value=!1,e.index.hideLoading()}},H=async()=>{const e=await a.getAutoTaskDetail({device_code:q.value});b.clue=e.clue_theme,b.videoTheme=e.video_theme,b.imageTheme=e.text_theme,h.anchorList=e.human_image,h.videoList=e.clip_material,h.imageList=e.image_material};return d("success",(async t=>{var r;const{type:u,content:n,deviceId:s,appType:o}=t;if(u!==i.DeviceCmdEnum.GET_USER_INFO)return;const c=w.value.find((e=>e.type===o));if(c&&1===c.status){const{account:e,account_no:t,extra:i,avatar:u,nickname:d}=n,m=null==(r=x.value.accounts)?void 0:r.find((e=>e.type===o)),v={account:e,account_no:t,avatar:u,device_code:s,type:o,nickname:d,extra:JSON.stringify(i)};try{m?await a.updateDeviceAccount({...v,id:m.id}):await a.addDeviceAccount(v),c.status=2,c.active=!0,c.account=e,c.account_no=t,c.avatar=u,c.nickname=d,c.extra=i}catch(l){c.status=3}}!w.value.some((e=>D.value.includes(e.type)&&(0===e.status||1===e.status)))?(e.index.hideLoading(),await U()):O()})),d("error",(t=>{e.index.hideLoading();const a=w.value.find((e=>1===e.status));a&&(a.error=t.error,a.status=3,O())})),e.onLoad((e=>{e.device_code&&(q.value=e.device_code),e.is_auto&&d("open",(()=>{setTimeout((()=>{F(!0)}),1e3)})),U()})),e.onUnload((()=>{m(),p(),h.clearMaterial()})),(a,i)=>e.e({a:!e.unref(j)},e.unref(j)?{}:e.e({b:e.p({"title-bold":!0,title:"自动任务配置","border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),c:e.f(e.unref(T),((t,a,i)=>e.e({a:e.unref(k)>t.step},e.unref(k)>t.step?{b:"004a8e1e-1-"+i,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(T).length},t.step!==e.unref(T).length?{f:e.unref(k)>t.step?1:""}:{},{g:t.step,h:e.unref(k)==t.step?1:"",i:e.o((e=>S(t.step)),t.step)}))),d:1==e.unref(k)},1==e.unref(k)?{e:t._imports_0$38,f:e.t(e.unref(A)?"重新获取":"一键获取"),g:e.o((t=>F(e.unref(A)))),h:e.f(e.unref(w),((a,i,r)=>e.e({a:a.activeIcon,b:e.t(a.name),c:a.active||2==a.status},a.active||2==a.status?{d:a.avatar,e:e.t(a.nickname),f:e.t(a.account),g:t._imports_1$23}:e.e({h:a.icon,i:1==a.status},1==a.status?{}:3==a.status?{k:e.t(a.error),l:e.o((e=>F(!1)),i)}:{},{j:3==a.status}),{m:i})))}:{},{i:2==e.unref(k)},2==e.unref(k)?{j:e.unref(b).clue,k:e.o((t=>e.unref(b).clue=t.detail.value)),l:e.t(e.unref(b).clue.length),m:e.unref(b).videoTheme,n:e.o((t=>e.unref(b).videoTheme=t.detail.value)),o:e.t(e.unref(b).videoTheme.length),p:e.unref(b).imageTheme,q:e.o((t=>e.unref(b).imageTheme=t.detail.value)),r:e.t(e.unref(b).imageTheme.length)}:{},{s:3==e.unref(k)},3==e.unref(k)?e.e({t:e.t(e.unref(g).length),v:e.p({name:"arrow-right",color:"#0065FB",size:"20"}),w:e.o((e=>M("anchor_material"))),x:e.unref(g).length>0},e.unref(g).length>0?{y:e.f(e.unref(g).slice(0,3),((t,a,i)=>({a:t.pic,b:e.o((e=>B(t)),a),c:a})))}:{z:e.o((e=>M("anchor_material")))},{A:e.t(e.unref(_).length),B:e.p({name:"arrow-right",color:"#0065FB",size:"20"}),C:e.o((e=>M("video_material"))),D:e.unref(_).length>0},e.unref(_).length>0?{E:e.f(e.unref(_).slice(0,3),((a,i,r)=>e.e({a:a.pic,b:"image"===a.type},"image"===a.type?{c:t._imports_0$11}:{d:t._imports_3$5},{e:e.o((e=>B(a)),i),f:i})))}:{F:e.o((e=>M("video_material")))},{G:e.t(e.unref(y).length),H:e.p({name:"arrow-right",color:"#0065FB",size:"20"}),I:e.o((e=>M("image_material"))),J:e.unref(y).length>0},e.unref(y).length>0?{K:e.f(e.unref(y).slice(0,3),((e,t,a)=>({a:e.pic,b:t})))}:{L:e.o((e=>M("image_material")))}):{},{M:e.unref(k)!=e.unref(T).length},e.unref(k)!=e.unref(T).length?e.e({N:1!=e.unref(k)},1!=e.unref(k)?{O:e.o((t=>S(e.unref(k),"prev")))}:{},{P:e.n(e.unref($)?"bg-black":"bg-_h787878CC_"),Q:e.o((t=>S(e.unref(k),"next")))}):{R:e.o(R)},{S:e.n(1==e.unref(k)?"justify-end":"justify-between")}),{T:e.o((t=>e.isRef(E)?E.value=t:null)),U:e.p({"video-url":e.unref(C).url,poster:e.unref(C).pic,modelValue:e.unref(E)})})}});wx.createPage(o);
