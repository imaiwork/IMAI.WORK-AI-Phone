"use strict";const e=require("../../../common/vendor.js"),o=require("../../../hooks/useWebSocket.js"),s=require("../../../enums/appEnums.js"),n=require("../../../stores/user.js"),c=require("../../../config/index.js"),r=require("../../../utils/util.js"),t=c.config.version;exports.useDeviceWs=function(d){const i=n.useUserStore(),{userInfo:u}=e.toRefs(i),{baseUrl:C}=c.config,m=`wss://${C.split("//")[1]}wss`,{on:p,send:v,isConnected:E,reconnect:a,close:D}=o.useWebSocket(m,{...d}),S=(e,o)=>{const s=I.get(e);s&&s(o)},I=new Map,l=o=>{if(!E.value)return void e.index.$u.toast(s.DeviceWsMessage[s.DeviceCmdCodeEnum.CONNECT_ERROR]);const{appType:n}=o;return v({type:o.type,content:{...o.content,userId:u.value.id,deviceId:o.deviceId||void 0,accountType:o.accountType},deviceId:o.deviceId||"",messageId:Date.now(),appVersion:t,appType:n})};return p("open",(()=>{S("open"),l({type:s.DeviceCmdEnum.BIND_WS,content:{type:s.DeviceCmdEnum.BIND_WS,sourceType:"mprog"}})})),p("close",(()=>{S("close",{error:s.DeviceWsMessage[s.DeviceCmdCodeEnum.CONNECT_ERROR],code:s.DeviceCmdCodeEnum.CONNECT_ERROR})})),p("error",(e=>{S("error",e)})),p("message",(e=>{let{type:o,code:n,content:c,deviceId:t}=e;if(c=r.isJson(c)?JSON.parse(c):c,n==s.DeviceCmdCodeEnum.SUCCESS)switch(n){case s.DeviceCmdCodeEnum.SUCCESS:case s.DeviceCmdCodeEnum.INIT_COMPLETE:case s.DeviceCmdCodeEnum.CHECK_INIT:S("success",{...e,content:c});break;default:S("error",{error:c.msg,code:s.DeviceCmdCodeEnum.PUSH_MESSAGE_ERROR,deviceCode:t})}else{if("pong"==o)return;S("error",{error:c.msg,type:o,code:n,deviceCode:t})}})),{on:p,send:l,reconnect:a,isConnected:E,onEvent:(e,o)=>{I.set(e,o)},close:D}};
