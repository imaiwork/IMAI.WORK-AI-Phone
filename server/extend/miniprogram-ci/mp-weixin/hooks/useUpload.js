"use strict";const e=require("../common/vendor.js"),i=require("../components/file-upload/choose-file.js"),t=require("../api/app.js");exports.useUpload=function(n){const{count:o=9,imageAccept:a=[],imageSize:u=20,imageResolution:s=[],videoAccept:l=[],videoSize:c=200,videoDuration:r=[1,600],fileAccept:p=[],fileSize:d=200,onSuccess:h}=n,f=e.ref([]),m=e.ref(!1),g=(e,i)=>{const t=f.value.findIndex((e=>e.tempFilePath===i.tempFilePath));if(-1!==t){const i=[...f.value];i[t]={...i[t],progress:e},f.value=i}};return{uploadMaterialList:f,showUploadProgress:m,uploadAndProcessFiles:async n=>{var v;f.value=[];try{const v="image"===n,x="video"===n,F="file"===n,P="all"===n,{tempFiles:w}=await i.chooseFile({type:n,count:o,sourceType:["album"],extension:v?a:x?l:p}),z=[];for(const i of w){if(v)try{const{width:t,height:n}=await e.index.getImageInfo({src:i.tempFilePath});if(a.length>0&&!a.includes(i.name.split(".").pop())){e.index.$u.toast(`图片格式必须是${a.join("、")}`);continue}if(t>s[0]||n>s[1]){e.index.$u.toast(`图片分辨率不能超过${s[0]}*${s[1]}`);continue}if(i.size>1024*u*1024){e.index.$u.toast(`图片大小不能超过${u}M`);continue}z.push(i)}catch($){continue}if(x){if(!(i.duration>=r[0]&&i.duration<=r[1])&&r.length>0){e.index.$u.toast(`视频时长不能小于${r[0]}秒，不能超过${r[1]}秒`);continue}if(i.size>1024*c*1024){e.index.$u.toast(`视频大小不能超过${c}M`);continue}if(l.length>0&&!l.includes(i.name.split(".").pop())){e.index.$u.toast(`视频格式必须是${l.join("、")}`);continue}z.push(i)}if(F||P){if(p.length>0&&!p.includes(i.name.split(".").pop())){e.index.$u.toast(`文件格式必须是${p.join("、")}`);continue}if(i.size>1024*d*1024){e.index.$u.toast(`文件大小不能超过${d}M`);continue}z.push(i)}}if(0===z.length)return;f.value=z.map((e=>({...e,progress:0}))),m.value=!0;const y=[];for(const e of f.value){const i=x?await t.uploadFile("image",{filePath:e.thumbTempFilePath}):{},o=await t.uploadFile(P?"file":n,{filePath:e.tempFilePath},(i=>g(i,e)));y.push({name:e.name,url:o.uri,size:e.size,type:n,pic:v?o.uri:i.uri,duration:e.duration||0,width:e.width||0,height:e.height||0})}f.value.every((e=>100===e.progress))&&(m.value=!1,null==h||h(y))}catch($){(null==(v=null==$?void 0:$.errMsg)?void 0:v.includes("cancel"))||e.index.$u.toast((null==$?void 0:$.errMsg)||$),f.value=[],m.value=!1}}}};
