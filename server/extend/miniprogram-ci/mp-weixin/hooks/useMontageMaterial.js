"use strict";const e=require("../common/vendor.js"),i=require("../stores/app.js"),t=require("../components/file-upload/choose-file.js"),o=require("../api/app.js"),a=require("../api/material.js"),n=require("./usePolling.js"),s=["webp","jpg","png"],c=["mp4","mov"],l={count:9,imageAccept:s,videoAccept:c,imageSize:20,imageResolution:[2e3,2e3],videoSize:200,videoDuration:[1,60],videoResolution:[2e3,2e3],fileAccept:[...s,...c],fileSize:100,imageDuration:2,materialTotalDuration:5};exports.montageConfig=l,exports.useMontageMaterial=function(s){const c=i.useAppStore(),{count:u=9,imageAccept:r=l.imageAccept,imageSize:d=l.imageSize,imageResolution:p=l.imageResolution,videoAccept:m=l.videoAccept,videoSize:f=l.videoSize,videoDuration:g=l.videoDuration,videoResolution:v=l.videoResolution,fileAccept:h=l.fileAccept,onSuccess:y}=s,$=e.computed((()=>c.config.is_oss_transcode)),x=e.ref([]),w=e.ref(!1),P=async e=>new Promise((async(i,t)=>{try{const t=await o.videoTranscode({video_url:e}),{start:a,end:s}=n.usePolling((async()=>{try{const e=await o.getVideoTranscodeResult({jobid:t.jobid});"TranscodeSuccess"==e.state?(s(),i(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(s(),i(!1))}catch(e){s(),i(!1)}}),{});await a()}catch(a){i(!1)}})),R=(e,i)=>{const t=x.value.findIndex((e=>e.tempFilePath===i.tempFilePath));if(-1!==t){const i=[...x.value];i[t]={...i[t],progress:e},x.value=i}};return{uploadMaterialList:x,showUploadProgress:w,uploadAndProcessFiles:async i=>{x.value=[];try{const s="image"===i,c="video"===i,l="all"===i,T=l?h:s?r:m,{tempFiles:j}=await t.chooseFile({type:i,count:u,sourceType:["album"],extension:T}),z=[];for(const M of j){const b=M.name.split(".").pop();if(s||l&&b&&r.includes(b))try{const{width:L,height:q}=await e.index.getImageInfo({src:M.tempFilePath});if(!r.includes(M.name.split(".").pop())){e.index.$u.toast(`图片格式必须是${r.join("、")}`);continue}if(L>p[0]||q>p[1]){e.index.$u.toast(`图片分辨率不能超过${p[0]}*${p[1]}`);continue}if(M.size>1024*d*1024){e.index.$u.toast(`图片大小不能超过${d}M`);continue}z.push({...M,materialType:"image"})}catch(n){continue}else if(c||l&&b&&m.includes(b)){if(!(M.duration>=g[0]&&M.duration<=g[1])){e.index.$u.toast(`视频时长不能超过${g[1]}秒`);continue}if(M.size>1024*f*1024){e.index.$u.toast(`视频大小不能超过${f}M`);continue}if(!m.includes(M.name.split(".").pop())){e.index.$u.toast(`视频格式必须是${m.join("、")}`);continue}if(M.width>v[0]||M.height>v[1]){e.index.$u.toast(`视频单边分辨率不能超过宽：【${v[0]}】或高：【${v[1]}】`);continue}z.push({...M,materialType:"video"})}}if(0===z.length)return void e.index.$u.toast(`所选${s?"图片":"视频"}素材均不符合条件，重新上传`);x.value=z.map((e=>({...e,progress:0}))),w.value=!0;const A=[];for(const D of x.value){const _=s?null:await o.uploadFile("image",{filePath:D.thumbTempFilePath}),I=await o.uploadFile(l?"file":i,{filePath:D.tempFilePath},(e=>R(e,D)));A.push({item:D,coverRes:s?I:_,fileRes:I})}const F=[];async function S(e){try{const{item:i,coverRes:t,fileRes:o}=e;F.push({name:i.name,url:o.uri,type:i.materialType,pic:t.uri,duration:i.duration});const n=await a.addMaterialLibrary({name:i.name,size:i.size,type:0,sort:0,pic:null==t?void 0:t.uri,m_type:"image"===i.materialType?1:2,content:o.uri,duration:i.duration||0});n.id&&(F[F.length-1].id=n.id)}catch(n){console.error("添加素材失败:",n)}}if("video"===i||"all"===i){for(const[C,k]of A.entries()){const{fileRes:U}=k;if($.value){e.index.showLoading({title:`转码中(${C+1}/${A.length})...`,mask:!0});try{await P(U.uri),e.index.hideLoading()}catch(n){e.index.hideLoading(),w.value=!1}}S(k)}e.index.hideLoading()}else for(const V of A)S(V);x.value.every((e=>100===e.progress))&&(w.value=!1,e.index.$u.toast("上传成功"),null==y||y(F))}catch(n){e.index.$u.toast(n),x.value=[],w.value=!1}},handleDeleteMaterial:e=>{a.deleteMaterialLibrary({id:e})}}};
