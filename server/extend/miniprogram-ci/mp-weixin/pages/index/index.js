"use strict";const e=require("../../common/vendor.js"),a=require("../../stores/user.js"),n=require("../../stores/app.js"),o=require("../../api/chat.js"),i=require("../../enums/appEnums.js"),t=require("../../config/index.js");if(require("../../api/user.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../hooks/useShareMessage.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("tabbar")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../components/tabbar/tabbar.js")+(()=>"../../components/empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../components/popup-bottom/popup-bottom.js")+(()=>"../../components/recharge-popup/recharge-popup.js"))();const s=e.defineComponent({__name:"index",setup(s){var r;const l=[{key:"ai_customer",name:"AI获客",icon:"index_img_1.png"},{key:"dh",name:"数字人",icon:"index_img_2.png"},{key:"publish_img",name:"发布图文",icon:"index_img_3.png"},{key:"publish_video",name:"发布视频",icon:"index_img_4.png"},{key:"my_creation",name:"我的创作",icon:"index_img_5.png"},{key:"ai_puzzle",name:"AI拼图",icon:"index_img_6.png"},{key:"ladder_player",name:"AI陪练",icon:"index_img_7.png"},{key:"meeting_minutes",name:"会议助手",icon:"index_img_8.png"}],u=[{key:"digital_person_broadcast",name:"数字人口播",icon:"index_img_9.png"},{key:"oral_video_mix",name:"口播混剪",icon:"index_img_10.png"},{key:"real_person_broadcast",name:"真人口播",icon:"index_img_11.png"},{key:"material_mix",name:"素材混剪",icon:"index_img_12.png"},{key:"one_sentence_generation",name:"一句话生成",icon:"index_img_13.png"},{key:"news_body_generation",name:"新闻体生成",icon:"index_img_14.png"}],c=a=>{const n={create_task:"/ai_modules/device/pages/choose_task_type/choose_task_type",view_schedule:"/ai_modules/device/pages/task_calendar_full/task_calendar_full",dh:"/ai_modules/digital_human/pages/index/index",digital_person_clone:"/ai_modules/digital_human/pages/anchor_create/anchor_create",publish_img:"/ai_modules/device/pages/create_task/create_task?type=2",publish_video:"/ai_modules/device/pages/create_task/create_task?type=1",my_creation:"/packages/pages/creation/creation",ai_customer:"/ai_modules/sph/pages/create_task/create_task",ai_puzzle:"/ai_modules/drawing/pages/index/index",ladder_player:"/ai_modules/ladder_player/pages/index/index",meeting_minutes:"/ai_modules/meeting_minutes/pages/index/index",digital_person_broadcast:"/ai_modules/digital_human/pages/szr_create/szr_create",oral_video_mix:"/ai_modules/digital_human/pages/montage_create/montage_create",real_person_broadcast:"/ai_modules/digital_human/pages/montage_person_create/montage_person_create",material_mix:"/ai_modules/digital_human/pages/montage_material_create/montage_material_create",one_sentence_generation:"/ai_modules/digital_human/pages/sora_create/sora_create",news_body_generation:"/ai_modules/digital_human/pages/montage_news_create/montage_news_create"};e.index.navigateTo({url:n[a]})},_=n.useAppStore(),d=a.useUserStore(),{chatConfig:m}=e.toRefs(_),g=e.computed(()=>_.getWebsiteConfig),{userTokens:p}=e.toRefs(d),v=null==(r=d.getTokenByScene(i.TokensSceneEnum.CHAT))?void 0:r.score,f=e.ref(),h=e.shallowRef(),k=e.shallowRef(),y=e.ref(50),b=e.ref(!1),x=e.ref(!1),w=e.ref(!1),j=e.ref(!1),q=e.ref(!1),C=e.ref([]),z=e.ref([]),T=e.ref(""),$=e.ref([]);let A=null;const R=e.reactive({page_no:1,page_size:1500,assistant_id:0}),S=e=>{x.value=e},B=async(e,a)=>{var n,i;try{const{lists:i}=await o.getCreativeRecord({page_no:e,page_size:a,scene_id:0,type:1});null==(n=k.value)||n.complete(i)}catch(t){null==(i=k.value)||i.complete([])}},E=async()=>{try{const a=await o.getChatLog({...R,task_id:T.value}),n=null==a?void 0:a.map(e=>1===e.type?{...e,fileList:(null==e?void 0:e.file_info)?Array.isArray(e.file_info)?e.file_info:[e.file_info]:[]}:{...e,is_reasoning_finished:!0,consume_tokens:e.tokens_info});z.value=n,console.log("chatContentList",z.value),await e.nextTick$1(),h.value.scrollToBottom()}catch(a){console.error("获取聊天记录失败:",a)}},U=async(a,n=!1)=>{var i,t,s;if(p.value<=1)return e.index.$u.toast("算力不足，请充值！"),void(null==(i=f.value)||i.open());if(j.value)return;n||z.value.push({type:1,message:a,fileList:C.value});const r=e.reactive({type:2,loading:!0,reply:"",reasoning_content:"",consume_tokens:{}});z.value.push(r),j.value=!0;try{await o.chatSendTextStream({message:a,task_id:T.value,open_reasoning:0,is_network_search:x.value?1:0,file_info:C.value[0],...(null==(s=null==(t=h.value)?void 0:t.getChatConfig)?void 0:s.call(t))||{}},{onstart(e){A=e,q.value=!0},onmessage(e){F(e,r)},onclose(){L(r)}})}catch(l){I(l,r)}e.nextTick$1(()=>h.value.scrollToBottom())},F=(e,a)=>{e.trim().split("data:").forEach(e=>{if(e)try{const{object:n,content:o,task_id:i,usage:t,reasoning_content:s}=JSON.parse(e);if((o||s)&&"loading"===n&&(s?a.reasoning_content+=s:a.reply+=o),"finished"===n)return a.loading=!1,a.consume_tokens=t,void(T.value||(T.value=i));h.value.scrollToBottom()}catch(n){console.error("解析流式消息失败:",n)}})},L=e=>{e.loading=!1,M(),d.getUser(),setTimeout(()=>h.value.scrollToBottom(),600)},I=(a,n)=>{n.reply=600004===a.errno?"用户已停止内容生成":a||"发生错误",600004!==a.errno&&e.index.$u.toast(a),n.loading=!1,M()},K=()=>{T.value?(T.value="",z.value=[],M(),P(),U(m.value.new_chat_prompt,!0)):e.index.$u.toast("当前会话已经是最新的了")},M=()=>{C.value=[],j.value=!1,q.value=!1},H=()=>{z.value=[],M(),P()},P=()=>{null==A||A.abort(),j.value=!1,q.value=!1};return e.onMounted(()=>{const{safeArea:a}=e.index.$u.sys();y.value=a.top}),e.onLoad(a=>{(null==a?void 0:a.task_id)&&(T.value=a.task_id,E()),(async a=>{var n,o;await e.nextTick$1(),(null==a?void 0:a.agent_name)&&(null==(n=h.value)||n.setAgentConfig({name:a.agent_name,id:a.agent_id,avatar:a.agent_logo}),b.value=!0,await e.nextTick$1(),null==(o=h.value)||o.openKeyboard())})(a),e.index.$on("chooseFile",e=>{C.value=e})}),e.onUnload(()=>{var a;e.index.$off("chooseFile"),null==(a=h.value)||a.hideKeyboard()}),e.onHide(()=>{var e;null==(e=h.value)||e.hideKeyboard()}),e.onShow(()=>{_.getChatConfig()}),(a,n)=>e.e({a:e.p({name:"arrow-left",size:32}),b:e.p({"border-bottom":!1,"is-fixed":!1,"is-back":e.unref(z).length>0,background:{background:"transparent"},"is-custom-back-icon":!0,"custom-back":H}),c:!e.unref(b)},e.unref(b)?{}:e.e({d:0==e.unref(z).length},0==e.unref(z).length?{e:e.unref(g).shop_logo,f:e.o(e=>c("create_task")),g:e.o(e=>c("view_schedule")),h:e.p({name:"arrow-right",size:20,color:"#0000004d"}),i:`${e.unref(t.config).baseUrl}static/images/index_img_15.png`,j:e.o(e=>c("digital_person_clone")),k:e.f(l,(a,n,o)=>({a:`${e.unref(t.config).baseUrl}static/images/${a.icon}`,b:e.t(a.name),c:a.key,d:e.o(e=>c(a.key),a.key)})),l:e.p({name:"arrow-right",size:20,color:"#0000004d"}),m:e.f(u,(a,n,o)=>({a:e.t(a.name),b:`${e.unref(t.config).baseUrl}static/images/${a.icon}`,c:a.key,d:e.o(e=>c(a.key),a.key)}))}:{}),{n:e.sr(h,"287c3fd0-2",{k:"chattingRef"}),o:e.o(P),p:e.o(K),q:e.o(S),r:e.o(U),s:e.o(e=>w.value=!0),t:e.o(a=>e.isRef(C)?C.value=a:null),v:e.p({placeholder:"发送消息、输入@选择智能体","is-stop":e.unref(q),"content-list":e.unref(z),"send-disabled":e.unref(j),tokens:e.unref(v),"file-list":e.unref(C)}),w:0===e.unref(z).length},(e.unref(z).length,{}),{x:e.f(e.unref($),(a,n,o)=>({a:e.t(a.create_time),b:e.t(a.message||a.file_info.name),c:n,d:e.o(e=>(async e=>{var a;const{robot_id:n,avatar:o,robot_name:i,task_id:t}=e;null==(a=h.value)||a.setAgentConfig({id:n,avatar:o,name:i}),T.value=t,await E(),w.value=!1})(a),n)})),y:e.sr(k,"287c3fd0-7,287c3fd0-6",{k:"pagingRef"}),z:e.o(B),A:e.o(a=>e.isRef($)?$.value=a:null),B:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref($)}),C:e.o(a=>e.isRef(w)?w.value=a:null),D:e.p({title:"历史记录","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(w)}),E:e.sr(f,"287c3fd0-9",{k:"rechargePopupRef"})})}});wx.createPage(s);
