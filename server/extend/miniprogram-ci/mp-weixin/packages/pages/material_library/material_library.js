"use strict";const e=require("../../../common/vendor.js"),n=require("../../../api/material.js"),o=require("../../../enums/appEnums.js"),a=require("../../../hooks/useUpload.js"),i=require("../../../utils/file.js"),u=require("../../../utils/util.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../utils/auth.js"),require("../../../enums/constantEnums.js"),require("../../../utils/cache.js"),require("../../../stores/user.js"),require("../../../api/user.js"),require("../../../hooks/useShareMessage.js"),require("../../../router/index.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../api/chat.js"),require("../../../api/voice_chat.js"),require("../../../config/index.js"),require("../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("vieW")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("video-preview")+e.resolveComponent("popup-bottom")+e.resolveComponent("u-input")+e.resolveComponent("u-popup")+e.resolveComponent("upload-progress"))()}Math||((()=>"../../../components/empty/empty.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../components/video-preview/video-preview.js")+(()=>"../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../components/upload-progress/upload-progress.js"))();const r=e.defineComponent({__name:"material_library",setup(r){const t=[{name:"全部展示",key:0},{name:"分组展示",key:1}],l=e.ref(0);e.computed(()=>t.findIndex(e=>e.key==l.value));const s=[{name:"全部",key:""},{name:"图片",key:1},{name:"视频",key:2}],d=e.ref(""),p=e.ref([]),c=e.shallowRef(),f=e.ref([]),v=e.shallowRef(),m=e.ref(!1),h=e.ref(-1),g=e.ref(""),y=e.ref(!1),x=e.ref(),w=e.ref(!1),j=e.ref(!1),q=e.ref([]),L=e.ref(!1),b=e.reactive({url:"",pic:""}),_=async(e,o)=>{var a,i;try{const{lists:i}=await n.getMaterialLibraryList({page_no:e,page_size:o,m_type:d.value});null==(a=c.value)||a.complete(i.filter(e=>6!=e.m_type))}catch(u){null==(i=c.value)||i.complete([])}},k=async(e,n)=>{var o,a;try{null==(o=v.value)||o.complete([])}catch(i){null==(a=v.value)||a.complete([])}},T=e=>q.value.includes(e),R=o=>{e.index.showModal({title:"提示",content:"确定要删除吗？",success:async a=>{var i;if(a.confirm){e.index.showLoading({title:"删除中..."});try{await n.deleteMaterialLibrary({id:Array.isArray(o)?o:[o]}),null==(i=c.value)||i.reload(),q.value=[],e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none"})}catch(u){e.index.hideLoading()}}}})},A=async()=>{var o;e.index.showLoading({title:"修改中...",mask:!0});try{await n.updateMaterialLibraryGroup({id:p.value[h.value].id,name:g.value}),e.index.hideLoading(),e.index.showToast({title:"修改成功",icon:"none"}),m.value=!1,null==(o=c.value)||o.reload()}catch(a){e.index.hideLoading(),e.index.showToast({title:a,icon:"none",duration:3e3})}},M=()=>{w.value=!0},C=async()=>{var o;if(g.value){e.index.showLoading({title:"添加中...",mask:!0});try{await n.addMaterialLibraryGroup({name:g.value}),e.index.hideLoading(),e.index.showToast({title:"添加成功",icon:"none"}),w.value=!1,null==(o=v.value)||o.reload()}catch(a){e.index.hideLoading(),e.index.showToast({title:a,icon:"none",duration:3e3})}}else e.index.$u.toast("请输入分组名称")},z=()=>{w.value=!1,x.value=-1},V=async()=>{-1!=x.value||e.index.$u.toast("至少选择一个分组")},I=e=>{b.pic=e.pic,b.url=e.content,L.value=!0},{uploadAndProcessFiles:P,showUploadProgress:S,uploadMaterialList:E}=a.useUpload({fileAccept:["mp4","m4a","jpg","png","jpeg","webp"],onSuccess:async a=>{var i;const u=[];for(const e of a)u.push(n.addMaterialLibrary({name:e.name.split(".")[0],content:e.url,size:e.size,pic:e.pic,duration:e.duration,sort:0,type:o.AppTypeEnum.XHS,m_type:"image"==e.type?1:2}));e.index.showLoading({title:"添加中...",mask:!0});try{await Promise.all(u),null==(i=c.value)||i.reload(),e.index.hideLoading(),e.index.showToast({title:"添加成功",icon:"none",duration:3e3})}catch(r){e.index.hideLoading(),e.index.showToast({title:r,icon:"none",duration:3e3})}}}),G=()=>{e.index.showActionSheet({itemList:["上传图片","上传视频"],success:e=>{0==e.tapIndex?P("image"):P("video")}})};return(o,a)=>e.e({},{c:0==e.unref(l)},0==e.unref(l)?{d:e.f(s,(n,o,a)=>({a:e.t(n.name),b:o,c:n.key==e.unref(d)?1:"",d:e.o(e=>{return o=n.key,void(d.value!=o&&(d.value=o,null==(a=c.value)||a.reload()));var o,a},o)}))}:{},{e:0==e.unref(l)},0==e.unref(l)?{f:e.o(G)}:{},{g:1==e.unref(l)},1==e.unref(l)?{h:e.o(M)}:{},{i:0==e.unref(l)},0==e.unref(l)?{j:e.f(e.unref(p),(n,o,a)=>e.e({a:n.pic||n.content,b:e.o(o=>(n=>{e.index.showActionSheet({itemList:["预览","下载","删除"],success:o=>{0==o.tapIndex?2==n.m_type?I(n):e.index.previewImage({urls:[n.content]}):1==o.tapIndex?2==n.m_type?i.saveVideoToPhotosAlbum(n.content):i.saveImageToPhotosAlbum(n.content):R(n.id)}})})(n),o)},e.unref(j)?e.e({c:T(n.id)},(T(n.id),{}),{d:T(n.id)?1:"",e:e.o(e=>{return o=n.id,void(T(o)?q.value=q.value.filter(e=>e!=o):q.value.push(o));var o},o)}):{},{f:2==n.m_type},2==n.m_type?{g:e.t(e.unref(u.formatAudioTime)(n.duration))}:{},{h:o})),k:e.unref(j)}:{},{l:1==e.unref(l)},1==e.unref(l)?{m:e.f(e.unref(p),(o,a,i)=>({a:o.pic,b:e.o(o=>(o=>{e.index.showActionSheet({itemList:["修改名称","删除素材组"],success:a=>{0==a.tapIndex?(h.value=o,m.value=!0):e.index.showModal({title:"提示",content:"删除后无法找回，是否确认删除？",success:async a=>{var i;if(a.confirm){e.index.showLoading({title:"删除中..."});try{await n.deleteMaterialLibrary({id:p.value[o].id}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none"}),null==(i=c.value)||i.reload()}catch(u){e.index.hideLoading(),e.index.showToast({title:u,icon:"none",duration:3e3})}}}})}})})(a),a),c:a}))}:{},{n:e.sr(c,"5727d946-1",{k:"pagingRef"}),o:e.o(_),p:e.o(n=>e.isRef(p)?p.value=n:null),q:e.p({fixed:!1,"default-page-size":40,"safe-area-inset-bottom":!0,modelValue:e.unref(p)}),r:e.unref(j)},e.unref(j)?e.e({s:e.o(e=>{j.value=!1,q.value=[]}),t:e.unref(q).length>0&&e.unref(q).length==e.unref(p).length},(e.unref(q).length>0&&(e.unref(q).length,e.unref(p).length),{}),{v:e.o(e=>{q.value.length==p.value.length?q.value=[]:q.value=p.value.map(e=>e.id)})},{}):{},{B:e.unref(j)},e.unref(j)?{C:e.t(e.unref(q).length),D:e.o(n=>R(e.unref(q)))}:{E:e.o(e=>j.value=!0)},{F:e.n(e.unref(j)?"justify-between":"justify-end"),G:e.o(n=>e.isRef(L)?L.value=n:null),H:e.p({"video-url":e.unref(b).url,poster:e.unref(b).pic,modelValue:e.unref(L)}),I:e.f(e.unref(f),(n,o,a)=>e.e({a:n.pic,b:n.id==e.unref(x)},(n.id,e.unref(x),{}),{c:o,d:e.o(e=>{return o=n.id,void(x.value==o?x.value=-1:x.value=o);var o},o)})),J:e.sr(v,"5727d946-5,5727d946-4",{k:"pagingGroupRef"}),K:e.o(k),L:e.o(n=>e.isRef(f)?f.value=n:null),M:e.p({fixed:!1,modelValue:e.unref(f)}),N:e.o(z),O:e.o(V),P:e.o(z),Q:e.p({show:e.unref(y),title:"选择分组",showCloseBtn:!0,"is-disabled-touch":!0}),R:e.o(n=>e.isRef(g)?g.value=n:null),S:e.p({placeholder:"请输入分组名称",maxlength:"30",clearable:!0,"placeholder-style":"color: #0000004d; font-size: 26rpx;",modelValue:e.unref(g)}),T:e.o(e=>{m.value=!1,g.value=""}),U:e.o(A),V:e.o(n=>e.isRef(m)?m.value=n:null),W:e.p({mode:"center",width:"90%","border-radius":20,modelValue:e.unref(m)}),X:e.o(n=>e.isRef(g)?g.value=n:null),Y:e.p({placeholder:"请输入素材组名称",maxlength:"30",clearable:!0,"placeholder-style":"color: #0000004d; font-size: 26rpx;",modelValue:e.unref(g)}),Z:e.o(e=>{w.value=!1,g.value=""}),aa:e.o(C),ab:e.o(n=>e.isRef(w)?w.value=n:null),ac:e.p({mode:"center",width:"90%","border-radius":20,modelValue:e.unref(w)}),ad:e.o(n=>e.isRef(S)?S.value=n:null),ae:e.p({"upload-list":e.unref(E),modelValue:e.unref(S)})})}}),t=e._export_sfc(r,[["__scopeId","data-v-5727d946"]]);wx.createPage(t);
