"use strict";const e=require("../../../common/vendor.js"),t=require("../../../api/agent.js"),o=require("../../../stores/user.js"),n=require("../../../enums/appEnums.js"),a=require("../../../hooks/useLockFn.js"),i=require("../../../hooks/usePolling.js"),r=require("../../../utils/util.js"),u=require("../../../hooks/useCopy.js"),l=require("../../../utils/request/cancel.js"),s=require("../../../enums/requestEnums.js"),c=require("../../../utils/file.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/auth.js"),require("../../../enums/constantEnums.js"),require("../../../utils/cache.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../api/user.js"),require("../../../hooks/useShareMessage.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../api/chat.js"),require("../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("u-input")+e.resolveComponent("file-upload")+e.resolveComponent("u-line")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("data-select")+e.resolveComponent("u-button")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../components/file-upload/file-upload.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../components/empty/empty.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../components/data-select/data-select.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../components/recharge-popup/recharge-popup.js"))();const d=e.defineComponent({__name:"coze_chat",setup(d){var p;const v=o.useUserStore(),{userTokens:m,isLogin:f}=e.toRefs(v),g=null==(p=v.getTokenByScene(n.TokensSceneEnum.SCENE_CHAT))?void 0:p.score,h=e.ref(),y=e.shallowRef(),_=e.ref(),b=e.reactive({id:"",name:"",avatar:"",introduced:"",coze_id:"",stream:"",inputs:"",outputs:""}),w=e.ref({}),x=e.ref({}),j=e.ref({}),k=e.ref(!1),q=e.ref(-1),z={image:["jpg","jpeg","png","gif","bmp","webp","svg"],audio:["mp3","wav","wma","aac","m4a","ogg","flac"],doc:["doc","docx","pdf","txt","md"],table:["xls","xlsx","csv","tsv"],code:["py","java","html","css","js","php","c","cpp","sh","json","xml"],zip:["zip","rar","7z","tar","gz","bz2","iso","dmg","pkg","deb","rpm","msi","exe"],ppt:["ppt","pptx","pptm","pptm","pptx"],video:["mp4","mov","avi","mkv","wmv","flv","webm"],txt:["txt","md","log","error","warning","info","debug"]},C=e.computed((()=>{var e,t;return q.value>=0&&(null==(t=null==(e=w.value)?void 0:e.shortcut_commands)?void 0:t[q.value])||{}})),A=e.computed((()=>{const{components:e}=C.value;if(e&&e.length>0){return e.some((e=>{var t;return"file"===e.type?!(null==(t=j.value)?void 0:t[e.name]):!e.default_value}))}return!0})),R=e.ref({}),T=e.ref({}),E=e.computed((()=>1==b.stream)),L=e.computed((()=>{if(!b.inputs)return[];try{const e=JSON.parse(b.inputs);return e.forEach((e=>{R.value[e.fields]=e.value||"",T.value[e.fields]={required:Boolean(e.required),message:"file"===e.type?"请上传文件":"请输入"}})),e}catch(e){return console.error("解析表单配置失败:",e),[]}})),F=e.computed((()=>{if(!b.outputs)return{};try{return(r.isJson(b.outputs)?JSON.parse(b.outputs):[]).reduce(((e,t)=>(e[t.fields]={...t},e)),{})}catch(e){return console.error("解析输出参数失败:",e),{}}})),B=e=>{if(e.length){const t=[];return e.forEach((e=>{t.push(...z[e])})),t}return[]},S=e.ref([]),P=e.ref(!1),{copy:V}=u.useCopy(),O=e.shallowRef(),$=e.ref(!1),J=e.ref(!1),N=e.ref([]),M=e.ref("");let I=null;const D=e.reactive({page_no:1,page_size:25e3}),G=async(e,o)=>{var n,a;try{const{lists:a}=await t.cozeAgentChatRecord({page_no:e,page_size:o,bot_id:b.coze_id,type:_.value});null==(n=y.value)||n.complete(a)}catch(i){null==(a=y.value)||a.complete([])}},H=(e,t)=>{var o;R.value[t]=(null==(o=null==e?void 0:e[0])?void 0:o.url)||""},K=()=>{e.index.navigateBack()},U=async()=>{try{const{lists:e}=await t.cozeAgentChatRecord({...D,bot_id:b.coze_id,type:_.value,conversation_id:M.value});N.value=e.map((e=>"user"===e.role?{...e,type:1,message:e.content}:{...e,type:2,reply:e.content,consume_tokens:{total_tokens:e.token_total}})),await re()}catch(o){console.error("获取聊天记录失败:",o),e.index.showToast({title:"获取聊天记录失败",icon:"none"})}},W=()=>{let{id:e,components:t,query_template:o}=C.value,n={};t.forEach((e=>{"file"===e.type?(o=o.replace(`{{${e.name}}}`,j.value[e.name].url),n[e.name]=j.value[e.name].url):(o=o.replace(`{{${e.name}}}`,e.default_value),n[e.name]=e.default_value)})),x.value={command_id:e,parameters:n,text:o},Q(o),q.value=-1,x.value={},j.value={},k.value=!1},Q=async t=>{var o;if(!f.value)return void e.index.$u.route({url:"/pages/login/login"});if(m.value<=1)return e.index.$u.toast("算力不足，请充值！"),void(null==(o=h.value)||o.open());if($.value)return;N.value.push({type:1,message:t,conversation_id:M.value||""});const n=e.reactive({type:2,loading:!0,reply:"",conversation_id:M.value||"",consume_tokens:{}});N.value.push(n),$.value=!0,await re(),E.value?await X(t,n):await Z(t,n)},X=async(e,o)=>{try{await t.cozeAgentChatStream({id:b.id,content:e||"",conversation_id:M.value,...x.value},{onstart(e){I=e,J.value=!0},onmessage:e=>((e,t)=>{e.trim().split("data:").forEach((e=>{if(e)try{const{object:o,content:n,conversation_id:a,usage:i}=JSON.parse(e);if(n&&"loading"===o&&(t.reply+=n),"finished"===o)return t.loading=!1,t.consume_tokens={total_tokens:i.token_count},void(M.value||(M.value=a));re()}catch(o){console.error("解析流式消息失败:",o)}}))})(e,o),onclose(){o.loading=!1,v.getUser(),le(),re()}})}catch(n){ee(n,o)}};let Y=null;const Z=async(e,o)=>{try{J.value=!0;const n={id:b.id,content:e||"",conversation_id:M.value,...x.value},{conversation_id:a,id:r}=await t.cozeAgentChat(n);a&&M.value!==a&&(M.value=a);const u={id:b.id,conversation_id:M.value},{start:l,end:s}=i.usePolling((async()=>{try{const{status:e,id:n}=await t.cozeAgentChatView({chat_id:r,...u});if("completed"===e){s();const e=await t.cozeAgentChatMsgList({chat_id:n,...u});(null==e?void 0:e.length)&&e.forEach((e=>o.reply+=e.content)),o.loading=!1,le(),re()}else if("failed"===e)throw new Error("聊天失败")}catch(e){throw s(),ee(e,o),re(),e}}),{});Y=s,await l()}catch(n){ee(n,o)}},ee=(t,o)=>{o.loading=!1,o.reply=t.errno===s.RequestCodeEnum.ABORT?"用户已停止内容生成":t||"发生错误",t.errno!==s.RequestCodeEnum.ABORT&&e.index.$u.toast((null==t?void 0:t.message)||"发生错误"),o.loading=!1,le()},te=e.ref(null),oe=()=>L.value.every((t=>{if(t.required){if(!R.value[t.fields])return e.index.$u.toast(`请填写${t.name}`),!1}return!0})),ne=()=>{te.value=null,Object.keys(R.value).forEach((e=>{R.value[e]=""}))},{lockFn:ae,isLock:ie}=a.useLockFn((async()=>{if(!$.value&&oe()){e.index.showLoading({title:"生成中",mask:!0});try{const o=await t.cozeWorkflowGenerate({id:b.id,...R.value});te.value=o,e.index.hideLoading(),e.index.showToast({title:"生成成功",icon:"none",duration:3e3})}catch(o){e.index.hideLoading(),e.index.showToast({title:o||"生成失败",icon:"none",duration:3e3})}}})),re=async()=>{var t;await e.nextTick$1(),null==(t=O.value)||t.scrollToBottom()},ue=()=>{M.value="",N.value=[],le(),se()},le=()=>{$.value=!1,J.value=!1},se=()=>{null==I||I.abort(),le(),Y&&(Y(),Y=null),l.requestCancel.remove("/coze.cozeChat/chat"),l.requestCancel.remove("/coze.cozeChat/retrieve"),N.value.length>0&&J.value&&(N.value[N.value.length-1].loading=!1)},ce=e=>e?Array.isArray(e)?e:[e]:[],de=async()=>{const e=await t.getCozeAgentDetail({id:b.id});r.setFormData(e,b)},pe=async()=>{const e=await t.cozeAgentGetConfig({id:b.id});w.value=e};return e.onLoad((t=>{if(!t)return;const{id:o,task_id:n,type:a}=t;b.id=o,M.value=n||"",_.value=a,(async()=>{e.index.showLoading({title:"加载中"});try{await Promise.all([de(),pe()]),M.value&&(await U(),setTimeout((()=>re()),500))}catch(t){console.error("初始化页面失败:",t)}finally{e.index.hideLoading()}})()})),e.onUnload((()=>{var e;null==(e=O.value)||e.hideKeyboard()})),e.onHide((()=>{var e;null==(e=O.value)||e.hideKeyboard()})),(o,n)=>{var a,i,r,u,l,s,d;return e.e({a:e.p({name:"/static/images/icons/back_black.svg",size:"32"}),b:e.o(K),c:e.unref(b).avatar,d:e.t(e.unref(b).name),e:e.t(e.unref(b).introduced),f:e.p({"border-bottom":!1,"is-fixed":!1,"is-custom-back-icon":!0,background:{background:"transparent"}}),g:1==e.unref(_)},1==e.unref(_)?e.e({h:0==e.unref(N).length},0==e.unref(N).length?e.e({i:e.unref(b).avatar},e.unref(b).avatar?{j:e.unref(b).avatar}:{},{k:e.t(null==(i=null==(a=e.unref(w))?void 0:a.onboarding_info)?void 0:i.prologue),l:e.f(null==(u=null==(r=e.unref(w))?void 0:r.onboarding_info)?void 0:u.suggested_questions,((t,o,n)=>({a:e.t(t),b:e.o((e=>Q(t)),o),c:o})))}):{},{m:e.p({name:"/static/images/icons/history.svg",size:32}),n:e.o((e=>P.value=!0)),o:e.f(null==(l=e.unref(w))?void 0:l.shortcut_commands,((t,o,n)=>({a:e.t(t.name),b:o,c:e.o((e=>(e=>{k.value=!0,q.value=e})(o)),o)}))),p:e.sr(O,"c935d16e-2",{k:"chattingRef"}),q:e.o(se),r:e.o(ue),s:e.o(Q),t:e.p({"is-coze":!0,"is-stop":e.unref(J),"content-list":e.unref(N),"send-disabled":e.unref($),tokens:e.unref(g)})}):{},{v:2==e.unref(_)},2==e.unref(_)?e.e({w:!e.unref(te)},e.unref(te)?{y:e.f(e.unref(te),((t,o,n)=>{var a,i,r;return{a:e.t((null==(a=e.unref(F)[o])?void 0:a.name)||"-"),b:e.t(null==(i=e.unref(F)[o])?void 0:i.type),c:e.o((o=>e.unref(V)(t)),o),d:e.f(ce(t),((t,n,a)=>{var i,r,u,l,s;return e.e(["video","image"].includes(null==(i=e.unref(F)[o])?void 0:i.type)?e.e({a:"video"==(null==(r=e.unref(F)[o])?void 0:r.type)},"video"==(null==(u=e.unref(F)[o])?void 0:u.type)?{b:t}:{},{c:"image"==(null==(l=e.unref(F)[o])?void 0:l.type)},"image"==(null==(s=e.unref(F)[o])?void 0:s.type)?{d:t,e:e.o((o=>{return n=t,void e.index.previewImage({urls:[n]});var n}),n)}:{},{f:t},t?{g:e.o((n=>{return a=t,void("video"==e.unref(F)[o].type?c.saveVideoToPhotosAlbum(a):c.saveImageToPhotosAlbum(a));var a}),n)}:{}):{h:e.t(t)},{i:n})})),e:["video","image"].includes(null==(r=e.unref(F)[o])?void 0:r.type),f:o}}))}:{x:e.f(e.unref(L),((t,o,n)=>e.e({a:e.t(t.name),b:"input"===t.type},"input"===t.type?{c:"c935d16e-4-"+n,d:e.o((o=>e.unref(R)[t.fields]=o),o),e:e.p({placeholder:t.message,modelValue:e.unref(R)[t.fields]})}:{},{f:"textarea"===t.type},"textarea"===t.type?{g:"c935d16e-5-"+n,h:e.o((o=>e.unref(R)[t.fields]=o),o),i:e.p({height:"200",maxlength:1e3,placeholder:t.message,type:"textarea",modelValue:e.unref(R)[t.fields]})}:{},{j:"number"===t.type},"number"===t.type?{k:"c935d16e-6-"+n,l:e.o((o=>e.unref(R)[t.fields]=o),o),m:e.p({placeholder:t.message,type:"number",modelValue:e.unref(R)[t.fields]})}:{},{n:["video","image","file"].includes(t.type)},["video","image","file"].includes(t.type)?{o:e.o((e=>H(e,t.fields)),o),p:"c935d16e-7-"+n,q:e.p({"file-type":"all"})}:{},{r:o})))},{z:!e.unref(te)},e.unref(te)?{D:e.o(ne)}:{A:e.p({name:"/static/images/icons/history.svg",size:48}),B:e.o((e=>P.value=!0)),C:e.o(((...t)=>e.unref(ae)&&e.unref(ae)(...t)))}):{},{E:e.f(e.unref(S),((o,n,a)=>({a:e.t(o.content),b:"c935d16e-11-"+a+",c935d16e-10",c:e.t(o.create_time),d:"c935d16e-12-"+a+",c935d16e-10",e:e.o((n=>(async o=>{var n;const{confirm:a}=await new Promise((t=>{e.index.showModal({title:"提示",content:"确定要删除该聊天记录吗？",success:t})}));if(a){e.index.showLoading({title:"删除中",mask:!0});try{await t.cozeAgentChatRecordClear({bot_id:b.coze_id,conversation_id:o.conversation_id||"0"}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),null==(n=y.value)||n.reload()}catch(i){e.index.hideLoading(),e.index.showToast({title:i||"删除失败",icon:"none",duration:3e3})}}})(o)),n),f:n,g:e.o((e=>(async e=>{if(1==_.value)M.value=e.conversation_id,await U();else if(2==_.value){const{lists:o}=await t.cozeAgentChatRecord({bot_id:b.coze_id,type:2,conversation_id:e.conversation_id});o.length&&(te.value=JSON.parse(o[0].content))}P.value=!1})(o)),n)}))),F:e.p({name:"/static/images/icons/delete.svg",size:"24"}),G:e.sr(y,"c935d16e-10,c935d16e-9",{k:"pagingRef"}),H:e.o(G),I:e.o((t=>e.isRef(S)?S.value=t:null)),J:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(S)}),K:e.o((t=>e.isRef(P)?P.value=t:null)),L:e.p({title:"历史记录","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(P)}),M:e.f(null==(s=e.unref(C))?void 0:s.components,((t,o,n)=>{var a;return e.e({a:e.t(t.name),b:"text"===t.type},"text"===t.type?{c:"c935d16e-15-"+n+",c935d16e-14",d:e.o((e=>t.default_value=e),o),e:e.p({placeholder:t.description,clearable:!0,modelValue:t.default_value})}:{},{f:"select"===t.type},"select"===t.type?{g:"c935d16e-16-"+n+",c935d16e-14",h:e.o((e=>t.default_value=e),o),i:e.p({"is-border":!1,localdata:(null==(a=t.options)?void 0:a.map((e=>({text:e,value:e}))))||[],modelValue:t.default_value})}:{},{j:"file"===t.type},"file"===t.type?{k:"c935d16e-18-"+n+",c935d16e-17-"+n,l:e.p({name:"plus",color:"#0065FB",size:16}),m:e.o((e=>H(e,t.name)),o),n:"c935d16e-17-"+n+",c935d16e-14",o:e.o((o=>e.unref(j)[t.name]=o),o),p:e.p({"file-type":"all","return-type":"object","file-extname":B(t.options),modelValue:e.unref(j)[t.name]})}:{},{q:o})})),N:e.o(W),O:e.p({type:"primary",disabled:e.unref(A),"custom-style":{height:"90rpx",fontWeight:"bold",borderRadius:"20rpx"}}),P:e.o((t=>e.isRef(k)?k.value=t:null)),Q:e.p({title:null==(d=e.unref(C))?void 0:d.name,"custom-class":"bg-_hF6F6F6_",show:e.unref(k)}),R:e.sr(h,"c935d16e-20",{k:"rechargePopupRef"})})}}}),p=e._export_sfc(d,[["__scopeId","data-v-c935d16e"]]);wx.createPage(p);
