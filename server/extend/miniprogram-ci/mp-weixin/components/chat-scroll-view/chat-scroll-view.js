"use strict";const e=require("../../common/vendor.js"),t=require("../../api/chat.js"),o=require("../../api/agent.js"),n=require("../../utils/util.js"),a=require("../../hooks/useKeyboardHeight.js"),i=require("../../stores/app.js"),s=require("../../enums/appEnums.js"),u=require("../../stores/user.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("u-icon")+e.resolveComponent("u-switch")+e.resolveComponent("u-button")+e.resolveComponent("popup-bottom")+e.resolveComponent("empty")+e.resolveComponent("z-paging"))()}Math||((()=>"../chat-record-item/chat-record-item.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+r+(()=>"../../uni_modules/vk-uview-ui/components/u-switch/u-switch.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../popup-bottom/popup-bottom.js")+(()=>"../empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js"))();const r=()=>"./components/file-item.js",l=e.defineComponent({__name:"chat-scroll-view",props:{contentList:{default:()=>[]},fileList:{default:()=>[]},placeholder:{default:"在这里输入任何问题 ..."},sendDisabled:{type:Boolean,default:!1},tokens:{default:0},isStop:{type:Boolean},isNetwork:{type:Boolean,default:!0},isCoze:{type:Boolean,default:!1},isStaff:{type:Boolean,default:!1},isHome:{type:Boolean}},emits:["update:modelValue","contentPost","close","add-session","update:fileList","update:network","showHistory"],setup(r,{expose:l,emit:d}){const p=r,f=i.useAppStore(),m=e.computed((()=>u.useUserStore().isLogin)),c=e.ref({id:"",name:"",model_id:"",model_sub_id:""}),g=e.computed((()=>{var e;return((null==(e=f.getAiModelConfig)?void 0:e.channel)||[]).filter((e=>"1"==e.status))})),v=e.ref(!1),_=()=>{m.value?(v.value=!v.value,d("update:network",v.value)):e.index.$u.route({url:"/pages/login/login"})},h=e.computed({get:()=>p.fileList,set(e){d("update:fileList",e)}}),E=e.computed((()=>{const e=0===h.value.length&&!I.value;return p.sendDisabled||e})),y=()=>{O(),e.index.$u.route({url:"/packages/pages/choose_file/choose_file",params:{limit:1}})},b=e.ref(!1),x=e.ref(!1),w=e.reactive({id:"",name:"",avatar:""}),S=()=>{w.id="",w.name="",w.avatar=""},j=e.ref(!1),C=e.reactive({top_p:.5,temperature:1,presence_penalty:.1,frequency_penalty:2,context_num:3,top_logprobs:10,logprobs:0,max_tokens:4096}),q=e.computed((()=>c.value.model_id==s.ModelIdEnum.DEEPSEEK?2:1)),z=e.computed((()=>c.value.model_id==s.ModelIdEnum.DEEPSEEK?4096:1e4)),L=(e,t,o)=>{let{value:n}=e.detail;0==o||Number.isInteger(n)?C[t]=n:C[t]=n.toFixed(o)},k=()=>{O(),Q(),j.value=!0},D=async()=>{e.index.showLoading({title:"保存中...",mask:!0});try{await t.saveUserChatConfig({model_id:c.value.model_id,model_sub_id:c.value.model_sub_id,...C}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"none",duration:3e3}),j.value=!1}catch(o){e.index.hideLoading(),e.index.showToast({title:o||"保存失败",icon:"none",duration:3e3})}};e.shallowRef();const I=e.ref(""),K=e.ref(0),{dynamicHeight:M,hideKeyboard:P}=a.useKeyboardHeight(),$=e.computed((()=>{const{platform:t}=e.index.getSystemInfoSync(),o=0==p.contentList.length;return p.isStaff||p.isCoze?o?10:48:"android"===t?o?58:40:o?90:40})),A=e.computed((()=>{if(M.value<=0)return 0;const e=M.value-$.value;return e>0?e:0})),N=e=>{0==I.value.indexOf("@")&&1==I.value.length&&(x.value=!0)},R=e.ref(!1),T=()=>{R.value=!0},B=()=>{O(),""!=I.value.replace(/(^\s*)|(\s*$)/g,"")||0!=h.value.length?p.sendDisabled||(d("contentPost",I.value),e.nextTick$1((()=>{H()})),G(),I.value="",h.value=[],d("update:fileList",[])):e.index.$u.toast("输入为空")},F=()=>{d("close")},O=()=>{m.value||e.index.$u.route({url:"/pages/login/login"})},{proxy:U}=e.getCurrentInstance(),H=async()=>{await e.nextTick$1(),n.getRect(".content-box",!1,U).then((e=>{K.value=e.height}))},J=e=>{h.value.splice(e,1)},V=e.shallowRef(),G=()=>{var t,o;(null==(t=V.value)?void 0:t.blur)&&(null==(o=V.value)||o.blur()),e.index.hideKeyboard()},Q=async()=>{var e,o;if(!(null==(e=c.value)?void 0:e.model_id)){const e=g.value[0];c.value=e?JSON.parse(JSON.stringify(e)):{}}if(null==(o=c.value)?void 0:o.model_id){const e=await t.getUserChatConfig({model_id:c.value.model_id,model_sub_id:c.value.model_sub_id});Object.keys(e).forEach((t=>{e[t]=parseFloat(e[t])})),n.setFormData(e,C)}},W=e.ref([]),X=e.shallowRef(),Y=async(e,t)=>{var n,a;try{const{lists:a}=await o.getAgentList({page_no:e,page_size:t,source:1});null==(n=X.value)||n.complete(a)}catch(i){null==(a=X.value)||a.complete([])}};return e.watch((()=>f.getAiModelConfig),(e=>{e&&Q()}),{deep:!0,immediate:!0}),e.onUnmounted((()=>{F(),P()})),l({scrollToBottom:H,setUserInput:(e="")=>{I.value=e},getChatConfig:()=>({model_id:c.value.model_id||void 0,model_sub_id:c.value.model_sub_id||void 0,robot_id:w.id||void 0,...C}),setAgentConfig:e=>{n.setFormData(e,w)},hideKeyboard:P,openKeyboard:()=>{T()}}),(t,o)=>e.e({a:r.contentList.length},r.contentList.length?e.e({b:r.contentList.length},r.contentList.length?{c:e.f(r.contentList,((t,o,n)=>({a:"13dd2a29-0-"+n,b:e.p({type:t.type,avatar:t.form_avatar,content:1==t.type?t.message:t.reply,"reasoning-content":t.reasoning_content,"is-reasoning-finished":t.is_reasoning_finished,loading:t.loading,"consume-tokens":t.consume_tokens,"file-list":t.fileList,index:o,"is-markdown":2==t.type,showCopyBtn:2==t.type}),c:`${t.id} + ${o} + ''`})))}:{},{d:e.unref(K),e:0==e.unref(M)},0==e.unref(M)?{f:e.o((e=>{d("add-session")}))}:{}):{},{g:0==r.contentList.length},0==r.contentList.length?e.e({h:!r.isCoze&&!r.isStaff},(r.isCoze||r.isStaff,{})):{},{i:!r.isCoze&&!r.isStaff},r.isCoze||r.isStaff?{}:e.e({j:e.unref(c).id&&!e.unref(w).id},e.unref(c).id&&!e.unref(w).id?{k:e.unref(c).logo,l:e.t(e.unref(c).name),m:e.p({name:"arrow-down",size:"20",color:"#a8abb2"}),n:e.o((e=>b.value=!0))}:{},{o:e.unref(w).id},e.unref(w).id?{p:e.unref(w).avatar,q:e.t(e.unref(w).name),r:e.p({name:"close",color:"#ffffff",size:14}),s:e.o(S),t:e.o((e=>x.value=!0))}:{},{v:!e.unref(v)},e.unref(v)?{x:e.p({name:"/static/images/icons/deep_white.svg",size:28})}:{w:e.p({name:"/static/images/icons/deep.svg",size:28})},{y:e.unref(v)?1:"",z:e.o(_),A:e.p({name:"/static/images/icons/history.svg",size:28}),B:e.o((e=>d("showHistory"))),C:e.p({name:"/static/images/icons/setting.svg",size:28}),D:e.o(k)}),{E:t.$slots.chatAreaTop},(t.$slots.chatAreaTop,{}),{F:t.$slots.sendLeft&&!e.unref(R)},(t.$slots.sendLeft&&e.unref(R),{}),{G:e.unref(h).length},e.unref(h).length?{H:e.f(e.unref(h),((t,o,n)=>({a:e.o(J,o),b:"13dd2a29-7-"+n,c:e.p({item:t,index:o}),d:o})))}:{},{I:!r.isCoze&&!r.isStaff},r.isCoze||r.isStaff?{}:{J:e.o(y)},{K:e.unref(R),L:r.placeholder,M:e.o(T),N:e.o((e=>R.value=!1)),O:e.o([t=>e.isRef(I)?I.value=t.detail.value:null,N]),P:e.unref(I),Q:r.isStop},r.isStop?{R:e.p({name:"/static/images/icons/chat_stop.svg",size:36}),S:e.o(F)}:e.e({T:!e.unref(E)},e.unref(E)?{V:e.p({name:"/static/images/icons/arrow_up.svg",size:36})}:{U:e.p({name:"/static/images/icons/arrow_up_primary.svg",size:36})},{W:e.n(e.unref(E)?"bg-_hF2F2F2_":"bg-primary-light-9"),X:e.o(B)}),{Y:r.contentList.length>0},r.contentList.length>0?{Z:e.p({name:"/static/images/icons/tips.svg",size:32})}:{},{aa:e.n(r.isCoze||r.isStaff?"mb-_40rpx_":"mb-_20rpx_"),ab:e.unref(A)+"px",ac:e.unref(C).context_num,ad:e.o((e=>L(e,"context_num",0))),ae:e.t(e.unref(C).context_num),af:e.unref(c).model_id!=e.unref(s.ModelIdEnum).CLAUDE_SONNET_4_5},e.unref(c).model_id!=e.unref(s.ModelIdEnum).CLAUDE_SONNET_4_5?{ag:e.unref(C).top_p,ah:e.o((e=>L(e,"top_p",1))),ai:e.t(e.unref(C).top_p)}:{},{aj:e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK},e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK?{ak:e.unref(C).frequency_penalty,al:-2,am:e.o((e=>L(e,"frequency_penalty",1))),an:e.t(e.unref(C).frequency_penalty)}:{},{ao:e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK},e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK?{ap:e.unref(C).presence_penalty,aq:e.o((e=>L(e,"presence_penalty",1))),ar:e.t(e.unref(C).presence_penalty)}:{},{as:e.unref(C).temperature,at:e.unref(q),av:e.o((e=>L(e,"temperature",1))),aw:e.t(e.unref(C).temperature),ax:e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK},e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK?{ay:e.unref(C).top_logprobs,az:e.o((e=>L(e,"top_logprobs",1))),aA:e.t(e.unref(C).top_logprobs)}:{},{aB:e.unref(C).max_tokens,aC:e.unref(z),aD:e.o((e=>L(e,"max_tokens",1))),aE:e.t(e.unref(C).max_tokens),aF:e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK},e.unref(c).model_id!=e.unref(s.ModelIdEnum).DEEPSEEK?{aG:e.o((t=>e.unref(C).logprobs=t)),aH:e.p({"active-value":1,"inactive-value":0,size:"40",modelValue:e.unref(C).logprobs})}:{},{aI:e.o(D),aJ:e.p({type:"primary","custom-style":{height:"100rpx",fontSize:"28rpx"}}),aK:e.o((t=>e.isRef(j)?j.value=t:null)),aL:e.p({title:"参数设置",height:"85%","show-close-btn":!0,"custom-class":"bg-white","is-disabled-touch":!0,show:e.unref(j)}),aM:e.f(e.unref(g),((t,o,n)=>({a:t.logo,b:e.t(t.name),c:o,d:e.unref(c).id==t.id?1:"",e:e.o((e=>(e=>{c.value=JSON.parse(JSON.stringify(e)),b.value=!1,Q()})(t)),o)}))),aN:e.o((t=>e.isRef(b)?b.value=t:null)),aO:e.p({title:"选择模型",height:"55%",show:e.unref(b)}),aP:e.f(e.unref(W),((t,o,a)=>({a:t.image,b:e.t(t.name),c:e.t(t.intro),d:e.unref(w).id==t.id?1:"",e:o,f:e.o((e=>(e=>{n.setFormData(e,w),I.value="",x.value=!1})(t)),o)}))),aQ:e.sr(X,"13dd2a29-17,13dd2a29-16",{k:"agentPagingRef"}),aR:e.o(Y),aS:e.o((t=>e.isRef(W)?W.value=t:null)),aT:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(W)}),aU:e.o((t=>e.isRef(x)?x.value=t:null)),aV:e.p({title:"选择智能体",height:"85%","show-close-btn":!0,"is-disabled-touch":!0,show:e.unref(x)})})}}),d=e._export_sfc(l,[["__scopeId","data-v-13dd2a29"]]);wx.createComponent(d);
