"use strict";const e=require("../../common/vendor.js"),s=require("./choose-file.js"),t=require("../../api/app.js"),a=require("../../stores/app.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../stores/user.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),require("../../router/index.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../config/index.js"),require("../../api/chat.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-line-progress"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js"))();const r=e.defineComponent({__name:"file-upload",props:{modelValue:{type:[Array,Object],default:()=>[]},limit:{type:Number,default:10},disabled:{type:Boolean,default:!1},fileType:{type:String,default:"file",validator:e=>["image","video","file","all"].includes(e)},returnType:{type:String,default:"array"},fileExtname:{type:Array,default:()=>[]},data:{type:Object,default:()=>({})},header:{type:Object,default:()=>({})},sizeType:{type:Array,default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},showProgress:{type:Boolean,default:!0},maxCount:{type:Number,default:2},isGpt:{type:Boolean,default:!1},fileSizeLimit:{type:Number,default:0}},emits:["update:modelValue"],setup(r,{expose:i,emit:u}){const l=r,o=a.useAppStore(),{uploadAssistantId:n}=e.toRefs(o),c=e.ref([]),p=e.computed(()=>"object"===l.returnType?1:0===l.limit?Number.MAX_SAFE_INTEGER:l.limit),f=e.ref(l.fileType),d=e=>{if(0===e)return"0 Bytes";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][s]},m=async()=>{if(l.disabled)return;const t=p.value-c.value.length;if(l.limit>0&&t<=0)return void e.index.showToast({title:`您最多选择 ${l.limit} 个文件`,icon:"none"});const a={compressed:!1,sizeType:l.sizeType,sourceType:l.sourceType,extension:l.fileExtname.length?l.fileExtname:void 0,count:t};if("all"===l.fileType){const t={0:"image",1:"video",2:"file"};return void e.index.showActionSheet({itemList:["选择图片","选择视频","选择文件"],success:async e=>{f.value=t[e.tapIndex];const r=await s.chooseFile({type:f.value,...a});v(r)}})}const r=await s.chooseFile({type:f.value,...a});v(r)},v=async t=>{1===Number(p.value)&&(c.value=[]);const{files:a}=s.getFilesByExtname(t,l.fileExtname),r=[];for(let i=0;i<a.length&&!(p.value-c.value.length<=0);i++){const t=s.normalizeFileData(a[i]);l.fileSizeLimit>0&&t.size&&t.size>l.fileSizeLimit?e.index.showToast({title:`文件 "${t.name}" 大小超出限制 (${d(l.fileSizeLimit)})`,icon:"none",duration:3e3}):(c.value.push(t),r.push(t))}await y(r),h()},h=()=>{let e={};if("object"===l.returnType){const[s]=c.value;"success"===s.status&&(e={url:s.url,name:s.name})}else{e=c.value.filter(e=>"success"===e.status).map(e=>({url:e.url,name:e.name,id:e.id}))}u("update:modelValue",e)},y=e=>{const s=e.length;let a=0,r=0;return new Promise(i=>{const u=async()=>{const o=a++,p=e[o],d=c.value.findIndex(e=>e.path===p.path);try{const{uri:e,id:s}=l.isGpt?await t.uploadGPTFile({filePath:p.url,formData:{purpose:"assistants",assistants_id:n.value},header:l.header},e=>{c.value[d].progress=e}):await t.uploadFile(f.value,{filePath:p.url,formData:l.data,header:l.header},e=>{c.value[d].progress=e});c.value[d].status="success",c.value[d].url=e,c.value[d].id=s}catch(m){c.value[d].errMsg=m,c.value[d].status="error"}r++,r!==s?a<s&&u():i()};for(let e=0;e<Math.min(s,l.maxCount);e++)u()})},g=e.computed(()=>{switch(l.fileType){case"image":return"上传图片";case"video":return"上传视频";default:return"上传文件"}}),j=e=>{if(!e.url)return;c.value.some(s=>s.url==e.url)||(e.name||(e.name=s.getFileName(e.url)),e.status="success",c.value.push({...e}))};e.watch(()=>l.modelValue,e=>{Array.isArray(e)?e.forEach(e=>{j(e)}):(e.url||(c.value=[]),j(e))},{immediate:!0});return i({clear:()=>{c.value=[]}}),(s,t)=>e.e({a:s.$slots.trigger},s.$slots.trigger?{}:{b:e.p({name:"/static/images/icons/upload.svg",size:48}),c:e.t(e.unref(g))},{d:e.o(m),e:e.f(c.value,(s,t,a)=>e.e("file"==f.value?{a:"a142eff4-1-"+a,b:e.p({size:30,name:"file-text",color:"#ffffff"})}:{},"image"==f.value?{c:s.path||s.url}:{},"video"==f.value?{d:"a142eff4-2-"+a,e:e.p({size:30,name:"camera",color:"#ffffff"})}:{},{f:e.t(s.name)},r.disabled?{}:{g:"a142eff4-3-"+a,h:e.p({name:"close",size:16,color:"#ffffff"}),i:e.o(e=>(e=>{const s=c.value.findIndex(s=>s.url===e);s>-1&&(c.value.splice(s,1),h())})(s.url),s.url)},{j:r.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status},r.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status?{k:"a142eff4-4-"+a,l:e.p({height:"6","show-percent":!1,"active-color":"#0065FB",percent:s.progress})}:{},{m:"error"===s.status},"error"===s.status?{n:e.o(e=>(async e=>{e.status="ready",e.progress=0,await y([{...e}])})(s),s.url)}:{},{o:s.url})),f:"file"==f.value,g:"image"==f.value,h:"video"==f.value,i:!r.disabled})}});wx.createComponent(r);
