"use strict";const e=require("../../../common/vendor.js"),i=require("../config/index.js"),t=require("../../../stores/app.js"),o=require("../../../components/file-upload/choose-file.js"),a=require("../../../api/app.js"),n=require("../../../api/material.js"),s=require("../../../hooks/usePolling.js");exports.useMontageMaterial=function(c){const r=t.useAppStore(),{count:l=9,imageAccept:u=i.montageConfig.imageAccept,imageSize:d=i.montageConfig.imageSize,imageResolution:p=i.montageConfig.imageResolution,videoAccept:m=i.montageConfig.videoAccept,videoSize:f=i.montageConfig.videoSize,videoDuration:g=i.montageConfig.videoDuration,videoResolution:h=i.montageConfig.videoResolution,fileAccept:v=i.montageConfig.fileAccept,onSuccess:y}=c,$=e.computed(()=>r.config.is_oss_transcode),x=e.ref([]),w=e.ref(!1),P=async e=>new Promise(async(i,t)=>{try{const t=await a.videoTranscode({video_url:e}),{start:o,end:n}=s.usePolling(async()=>{try{const e=await a.getVideoTranscodeResult({jobid:t.jobid});"TranscodeSuccess"==e.state?(n(),i(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(n(),i(!1))}catch(e){n(),i(!1)}},{});await o()}catch(o){i(!1)}}),j=(e,i)=>{const t=x.value.findIndex(e=>e.tempFilePath===i.tempFilePath);if(-1!==t){const i=[...x.value];i[t]={...i[t],progress:e},x.value=i}};return{uploadMaterialList:x,showUploadProgress:w,uploadAndProcessFiles:async i=>{x.value=[];try{const s="image"===i,c="video"===i,r="all"===i,F=r?v:s?u:m,{tempFiles:T}=await o.chooseFile({type:i,count:l,sourceType:["album"],extension:F}),R=[];for(const M of T){const q=M.name.split(".").pop();if(s||r&&q&&u.includes(q))try{const{width:L,height:S}=await e.index.getImageInfo({src:M.tempFilePath});if(!u.includes(M.name.split(".").pop())){e.index.$u.toast(`图片格式必须是${u.join("、")}`);continue}if(L>p[0]||S>p[1]){e.index.$u.toast(`图片分辨率不能超过${p[0]}*${p[1]}`);continue}if(M.size>1024*d*1024){e.index.$u.toast(`图片大小不能超过${d}M`);continue}R.push({...M,materialType:"image"})}catch(t){continue}else if(c||r&&q&&m.includes(q)){if(!(M.duration>=g[0]&&M.duration<=g[1])){e.index.$u.toast(`视频时长不能超过${g[1]}秒`);continue}if(M.size>1024*f*1024){e.index.$u.toast(`视频大小不能超过${f}M`);continue}if(!m.includes(M.name.split(".").pop())){e.index.$u.toast(`视频格式必须是${m.join("、")}`);continue}if(M.width>h[0]||M.height>h[1]){e.index.$u.toast(`视频单边分辨率不能超过宽：【${h[0]}】或高：【${h[1]}】`);continue}R.push({...M,materialType:"video"})}}if(0===R.length)return;x.value=R.map(e=>({...e,progress:0})),w.value=!0;const C=[];for(const b of x.value){const _=s?null:await a.uploadFile("image",{filePath:b.thumbTempFilePath}),D=await a.uploadFile(r?"file":i,{filePath:b.tempFilePath},e=>j(e,b));C.push({item:b,coverRes:s?D:_,fileRes:D})}const z=[];async function A(e){try{const{item:i,coverRes:t,fileRes:o}=e,a=await n.addMaterialLibrary({name:i.name,size:i.size,type:0,sort:0,pic:null==t?void 0:t.uri,m_type:"image"===i.materialType?1:2,content:o.uri,duration:i.duration||0});z.push({name:i.name,url:o.uri,type:i.materialType,pic:t.uri,duration:i.duration,id:a.id})}catch(t){console.error("添加素材失败:",t)}}if("video"===i||"all"===i){for(const[I,k]of C.entries()){const{fileRes:U}=k;if($.value){e.index.showLoading({title:`转码中(${I+1}/${C.length})...`,mask:!0});try{await P(U.uri),e.index.hideLoading()}catch(t){e.index.hideLoading(),w.value=!1}}await A(k)}e.index.hideLoading()}else for(const V of C)await A(V);x.value.every(e=>100===e.progress)&&(w.value=!1,e.index.$u.toast("上传成功"),null==y||y(z))}catch(t){e.index.$u.toast(t),x.value=[],w.value=!1}},handleDeleteMaterial:e=>{n.deleteMaterialLibrary({id:e})}}};
