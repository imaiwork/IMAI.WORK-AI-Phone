"use strict";const e=require("../../../../common/vendor.js"),r=require("../../../../common/assets.js"),a=require("../../../../api/digital_human.js"),t=require("../../../../stores/user.js"),n=require("../../enums/index.js"),o=require("../../config/index.js"),i=require("../../hooks/useMontageMaterial.js"),s=require("../../../../hooks/useEventBusManager.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),require("../../../../api/material.js"),require("../../../../hooks/usePolling.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-input")+e.resolveComponent("upload-progress")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+l+u+(()=>"../../../../components/upload-progress/upload-progress.js")+p+c+(()=>"../../../../components/recharge-popup/recharge-popup.js")+f)();const u=()=>"../../components/upload-rule-pop/upload-rule-pop.js",l=()=>"../../components/choose-character/choose-character.js",c=()=>"../../components/create-success-pop/create-success-pop.js",p=()=>"../../../../components/video-preview/video-preview.js",f=()=>"../../components/tokens-cost/tokens-cost.js",m=e.defineComponent({__name:"montage_create",setup(u){const{on:l}=s.useEventBusManager(),c=t.useUserStore(),{userTokens:p}=e.toRefs(c),f=e.ref([{step:1,title:"选择形象"},{step:2,title:"填写身份"},{step:3,title:"选择文案"},{step:4,title:"参考素材"},{step:5,title:"生成设置"}]),m=e.ref(1),d=e.reactive({shanjian_type:n.MontageTypeEnum.REAL_PERSON_MIX,anchorLists:[],name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM")+"口播混剪",person_name:"",person_introduction:"",copywriterList:[],materialList:[]}),h=e.ref([]),g=e.ref(!1),v=e.ref(!1),_=e.reactive({page_no:1,page_size:20,status:6}),L=e.ref(!1),y=e.ref(!1),j=e.ref(-1),w=e.ref(-1),x=e.ref(!1),q=e.ref(!0),b=e.ref(!1),k=e.reactive({poster:"",url:""}),C=e.shallowRef(),E=e.ref(!1),M=e.ref(null),R=e.ref(!1),T=r=>{switch(r){case 1:return d.anchorLists.length>0;case 2:return!!d.person_name&&!!d.person_introduction;case 3:return d.copywriterList.length>0;case 4:return d.materialList.reduce(((e,r)=>"video"===r.type?e+r.duration:e),0)+d.materialList.filter((e=>"image"===e.type)).length*o.montageConfig.imageDuration>60*o.montageConfig.materialTotalDuration?(e.index.$u.toast(`素材总时长不能超过${o.montageConfig.materialTotalDuration}分钟`),!1):d.materialList.length>=3;case 5:return!0;default:return!1}},$=e.computed((()=>T(m.value))),A=(r,a)=>{if("prev"!==a)if("next"!==a){if(r!==m.value)if(r<m.value)m.value=r;else{for(let a=1;a<r;a++)if(!T(a))return void e.index.$u.toast("请按顺序完成步骤");m.value=r}}else if($.value)m.value++;else{const r={1:"请至少选择一个形象",2:"请填写人物名称和介绍",3:"请至少添加一条文案",4:"请上传至少3个素材"};e.index.$u.toast(r[m.value]||"请完成当前步骤")}else m.value--},z=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/anchor_create/anchor_create",params:{source:n.DigitalHumanModelVersionEnum.SHANJIAN}})},B=e=>{d.person_name=e.name,d.person_introduction=e.introduced,y.value=!0,L.value=!1},S=r=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_copywriter/montage_copywriter",params:{data:r?JSON.stringify(r):""}})},{showUploadProgress:V,uploadMaterialList:I,uploadAndProcessFiles:P,handleDeleteMaterial:D}=i.useMontageMaterial({onSuccess:e=>{-1!==w.value?d.materialList[w.value]=e[0]:d.materialList=d.materialList.concat(e),w.value=-1}}),N=()=>{if(q.value)return q.value=!1,void(x.value=!0);x.value=!1,e.index.showActionSheet({itemList:["选择图片素材","选择视频素材"],success:e=>{0===e.tapIndex?P("image"):1===e.tapIndex&&P("video")}})},O=r=>{const{type:a,pic:t,url:n}=r;"image"===a?e.index.previewImage({urls:[t]}):(k.poster=t,k.url=n,b.value=!0)},H=async()=>{var r;if(p.value<0)null==(r=C.value)||r.open();else if(d.name){e.index.showLoading({title:"创建中...",mask:!0});try{const r=await a.createShanjianTask({name:d.name,anchor:d.anchorLists.map((e=>({anchor_id:e.anchor_id,pic:e.pic,anchor_url:e.anchor_url,name:e.name}))),character_design:[{name:d.person_name,introduced:d.person_introduction}],voice:d.anchorLists.map((e=>({voice_id:e.voice_id,voice_url:e.voice_url,voice_name:e.voice_name}))),copywriting:d.copywriterList,material:d.materialList.map((e=>({fileUrl:e.url,type:e.type})))});y.value||a.addShanjianPerson({name:d.person_name,introduced:d.person_introduction}),e.index.hideLoading(),M.value=r,E.value=!0}catch(t){e.index.hideLoading(),e.index.showToast({title:t||"创建失败",icon:"none",duration:3e3})}}else e.index.$u.toast("请输入视频名称")},J=()=>{E.value=!1,e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_publish/montage_publish",type:"redirect",params:{task_id:JSON.stringify([M.value.id]),scene:1,type:d.shanjian_type}})},U=()=>{e.index.$u.route({url:"/packages/pages/creation/creation",type:"redirect"})},F=async()=>{g.value=!0;try{const{lists:e,count:r}=await a.getShanjianAnchorList(_);v.value=!(e.length<(_.page_size||r)),h.value=h.value.concat(e)}finally{g.value=!1}},G=()=>{v.value&&!g.value&&(_.page_no++,F())};return e.onShow((()=>{h.value=[],F()})),e.onLoad((()=>{l("confirm",(e=>{const{type:r,data:a}=e;if(r===n.ListenerTypeEnum.CREATE_ANCHOR){if(!a)return;h.value=h.value.concat(a)}if(r===n.ListenerTypeEnum.MONTAGE_COPYWRITER||r===n.ListenerTypeEnum.MONTAGE_AI_COPYWRITER){if(0==a.length)return;-1!==j.value?d.copywriterList[j.value]=a[0]:d.copywriterList=d.copywriterList.concat(a)}}))})),(a,t)=>e.e({a:e.p({title:"数字人口播混剪","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(f),((r,a,t)=>e.e({a:e.unref(m)>r.step},e.unref(m)>r.step?{b:"4c965a43-1-"+t,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(r.title),e:r.step!==e.unref(f).length},r.step!==e.unref(f).length?{f:e.unref(m)>r.step?1:""}:{},{g:r.step,h:e.unref(m)==r.step?1:"",i:e.o((e=>A(r.step)),r.step)}))),c:1===e.unref(m)},1===e.unref(m)?e.e({d:r._imports_0$6,e:e.o(z),f:e.unref(h).length>0},e.unref(h).length>0?{g:e.f(e.unref(h),((r,a,t)=>e.e({a:r.pic,b:e.o((e=>O({pic:r.pic,url:r.anchor_url})),a),c:e.unref(d).anchorLists.includes(r)},(e.unref(d).anchorLists.includes(r),{}),{d:a,e:e.o((e=>{return a=r,void(d.anchorLists.includes(a)?d.anchorLists=d.anchorLists.filter((e=>e!==a)):d.anchorLists.push(a));var a}),a)}))),h:e.o(G)}:{i:r._imports_1$4,j:e.o(z)}):{},{k:2===e.unref(m)},2===e.unref(m)?{l:e.o((e=>y.value=!1)),m:e.o((r=>e.unref(d).person_name=r)),n:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物名称",maxlength:"20",modelValue:e.unref(d).person_name}),o:e.o((e=>y.value=!1)),p:e.o((r=>e.unref(d).person_introduction=r)),q:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物介绍",maxlength:"50",modelValue:e.unref(d).person_introduction}),r:r._imports_0$10,s:e.o((e=>L.value=!0))}:{},{t:3===e.unref(m)},3===e.unref(m)?{v:e.o((e=>S())),w:e.o((e=>j.value=-1)),x:e.f(e.unref(d).copywriterList,((r,a,t)=>({a:e.t(r.title),b:e.t(r.content),c:"4c965a43-4-"+t,d:e.o((e=>(e=>{d.copywriterList.splice(e,1)})(a)),a),e:a,f:e.o((e=>(e=>{j.value=e;const r=d.copywriterList[e];S(r)})(a)),a)}))),y:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{z:4===e.unref(m)},4===e.unref(m)?{A:e.t(e.unref(d).materialList.length),B:e.t(e.unref(o.montageConfig).materialTotalDuration),C:e.t(e.unref(o.montageConfig).imageDuration),D:e.f(e.unref(d).materialList,((a,t,n)=>e.e({a:a.pic,b:"image"===a.type},"image"===a.type?{c:r._imports_0$11}:{d:r._imports_3$5},{e:e.o((e=>(e=>{w.value=e,N()})(t)),t),f:e.o((e=>O(a)),t),g:"4c965a43-5-"+n,h:e.o((e=>{return r=a.id,d.materialList=d.materialList.filter((e=>e.id!==r)),void D(r);var r}),t),i:t}))),E:e.p({name:"close",color:"#ffffff",size:"16"}),F:r._imports_0$6,G:e.o(N)}:{},{H:5===e.unref(m)},5===e.unref(m)?{I:e.o((r=>e.unref(d).name=r)),J:e.p({maxlength:"50","placeholder-style":"font-size:26rpx;",placeholder:"请输入",modelValue:e.unref(d).name}),K:e.t(e.unref(d).anchorLists.length),L:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),M:e.o((e=>A(2))),N:e.f(e.unref(d).anchorLists,((e,r,a)=>({a:e.pic,b:r}))),O:e.t(e.unref(d).person_name),P:e.t(e.unref(d).person_introduction),Q:e.p({name:"arrow-right",size:20,color:"#C5CACA"}),R:e.t(e.unref(d).copywriterList.length),S:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),T:e.o((e=>A(3))),U:e.t(e.unref(d).materialList.length),V:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),W:e.o((e=>A(4))),X:e.t(e.unref(d).copywriterList.length)}:{},{Y:e.unref(m)!=e.unref(f).length},e.unref(m)!=e.unref(f).length?e.e({Z:1===e.unref(m)},1===e.unref(m)?{aa:e.t(e.unref(d).anchorLists.length),ab:e.n(e.unref(d).anchorLists.length>0?"bg-black":"bg-_h787878CC_")}:{ac:e.o((r=>A(e.unref(m),"prev")))},{ad:e.n(e.unref($)?"bg-black":"bg-_h787878CC_"),ae:e.o((r=>A(e.unref(m),"next")))}):{af:r._imports_3$2,ag:e.o((e=>R.value=!0)),ah:e.t(e.unref(d).copywriterList.length),ai:e.o(H)},{aj:e.o(B),ak:e.o((r=>e.isRef(L)?L.value=r:null)),al:e.p({modelValue:e.unref(L)}),am:e.o(N),an:e.o((r=>e.isRef(x)?x.value=r:null)),ao:e.p({modelValue:e.unref(x)}),ap:e.o((r=>e.isRef(V)?V.value=r:null)),aq:e.p({"upload-list":e.unref(I),modelValue:e.unref(V)}),ar:e.o((r=>e.isRef(b)?b.value=r:null)),as:e.p({title:"视频预览",poster:e.unref(k).poster,"video-url":e.unref(k).url,modelValue:e.unref(b)}),at:e.o(J),av:e.o(U),aw:e.o((r=>e.isRef(E)?E.value=r:null)),ax:e.p({title:"混剪视频创建成功",desc:"您可以立即去设置发布任务，也可以等待混剪视频成功后再发布",modelValue:e.unref(E)}),ay:e.sr(C,"4c965a43-16",{k:"rechargePopupRef"}),az:e.o((r=>e.isRef(R)?R.value=r:null)),aA:e.p({type:1,modelValue:e.unref(R)})})}}),d=e._export_sfc(m,[["__scopeId","data-v-4c965a43"]]);wx.createPage(d);
