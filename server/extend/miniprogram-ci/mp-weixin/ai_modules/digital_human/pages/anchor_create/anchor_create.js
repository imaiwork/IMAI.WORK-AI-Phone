"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),i=require("../../../../api/app.js"),n=require("../../../../api/digital_human.js"),r=require("../../enums/index.js"),a=require("../../../../utils/request/cancel.js"),t=require("../../../../stores/user.js"),u=require("../../../../stores/app.js"),s=require("../../../../config/index.js"),l=require("../../../../utils/file.js"),d=require("../../../../hooks/usePolling.js"),c=require("../../../../enums/appEnums.js"),m=require("../../hooks/useUpload.js"),p=require("../../../../hooks/useEventBusManager.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-popup")+e.resolveComponent("video-player")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/video-player/video-player.js")+(()=>"../../../../components/popup-bottom/popup-bottom.js")+h+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const h=()=>"../../components/upload-loading/upload-loading.js",v=e.defineComponent({__name:"anchor_create",setup(h){const{emit:v,on:f}=p.useEventBusManager(),g=t.useUserStore(),{userTokens:_}=e.toRefs(g),x=u.useAppStore(),y=e.computed(()=>{var e;return null==(e=x.config)?void 0:e.is_oss_transcode}),w=e.reactive({name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM"),pic:"",url:"",width:0,height:0,anchor_id:""}),j=e.reactive({name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM"),pic:"",url:""}),A=e.ref({}),q=e.ref(!1),L=e.ref([]),U=e.ref(),T=e.ref(!1),b=["mp4","mov"],k=e.ref(!1),E=e.ref(!1),C=e.ref(0),M=e.shallowRef(),R=e.ref(""),H=e.shallowRef(),S=e.computed(()=>{var e,o;const i=null==(e=g.getTokenByScene(c.TokensSceneEnum.HUMAN_AVATAR_SHANJIAN))?void 0:e.score,n=null==(o=g.getTokenByScene(c.TokensSceneEnum.HUMAN_AVATAR_CHANJING))?void 0:o.score;return parseFloat(i)+parseFloat(n)}),D=e.computed(()=>j.url&&w.url),N=()=>{const{upload:o}=m.useUpload({size:m.commonUploadLimit.size,widthResolution:[m.commonUploadLimit.minWidthResolution,m.commonUploadLimit.maxWidthResolution],heightResolution:[m.commonUploadLimit.minHeightResolution,m.commonUploadLimit.maxHeightResolution],duration:[m.commonUploadLimit.videoMinDuration,m.commonUploadLimit.videoMaxDuration],extension:b,async onSuccess(o){const{url:i,pic:n,width:r,height:a}=o;w.url=i,w.pic=n,w.width=r,w.height=a,w.name=e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM"),E.value=!1},onProgress(e){M.value=e.type,C.value=e.progress,R.value="video"===M.value?"视频正在上传中...":"图片正在上传中...",E.value=!0},onError(e){E.value=!1,C.value=0,I()}});o()},P=()=>{e.index.showActionSheet({itemList:["录制授权视频","从手机相册选择","选择历史授权视频"],success:async o=>{if(0===o.tapIndex){if(!(await l.requestAuthorization("scope.camera")))return void e.index.$u.toast("您关闭了权限，请前往设置打开权限");e.index.$u.route({url:"/ai_modules/digital_human/pages/anchor_auth_camera/anchor_auth_camera"})}else 1===o.tapIndex?F():2===o.tapIndex&&e.index.$u.route({url:"/ai_modules/digital_human/pages/anchor_auth_video/anchor_auth_video"})}})},$=()=>{a.requestCancel.remove("/upload/video"),a.requestCancel.remove("/upload/image"),E.value=!1,C.value=0,R.value="",I()},I=()=>{e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#F9FAFB"})},V=async e=>new Promise(async(o,n)=>{try{const n=await i.videoTranscode({video_url:e}),{start:r,end:a}=d.usePolling(async()=>{try{const e=await i.getVideoTranscodeResult({jobid:n.jobid});"TranscodeSuccess"==e.state?(a(),o(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(a(),o(!1))}catch(e){a(),o(!1)}},{});L.value.push(a),await r()}catch(r){o(!1)}}),F=()=>{const{upload:o}=m.useUpload({duration:[1,120],extension:b,onProgress:o=>{e.index.showLoading({title:"视频上传中",mask:!0})},onSuccess:async o=>{e.index.hideLoading(),e.index.showToast({title:"视频上传成功",icon:"none",duration:3e3}),j.pic=o.pic,j.url=o.url,j.width=o.width,j.height=o.height},onError:o=>{const{type:i,error:n}=o;e.index.hideLoading(),"video"==i&&e.index.showToast({title:n||"视频上传失败",icon:"none",duration:3e3})}});o()},z=async()=>{var o;if(_.value<=S.value)return void(null==(o=H.value)||o.open());if(!w.url)return void e.index.showToast({title:"请上传形象视频",icon:"none",duration:3e3});if(!j.url)return void e.index.showToast({title:"请上传授权视频",icon:"none",duration:3e3});if(e.index.showLoading({title:"创建形象中...",mask:!0}),y.value)try{Promise.allSettled([await V(w.url),await V(j.url)])}catch(a){}const i=e=>new Promise(async(o,i)=>{await n.createAnchor({name:w.name,url:w.url,pic:w.pic,model_version:e,width:w.width,height:w.height}).then(e=>{o(e)}).catch(e=>{i(!1)})});try{const[o,a]=await Promise.allSettled([new Promise(async(e,o)=>{await n.createShanjianAnchor({name:w.name,pic:w.pic,anchor_url:w.url,authorized_pic:j.pic,authorized_url:j.url}).then(async o=>{e(o)}).catch(e=>{o(!1)})}),i(r.DigitalHumanModelVersionEnum.CHANJING),i(r.DigitalHumanModelVersionEnum.STANDARD)]),t=U.value==r.DigitalHumanModelVersionEnum.SHANJIAN;if(U.value)if(t){const{start:i,end:r}=d.usePolling(async()=>{A.value=await n.getShanjianAnchorDetail({id:o.value.id});const{status:i}=A.value;if(2==i||3==i||5==i||6==i)return e.index.hideLoading(),q.value=!0,T.value=3==i||6==i,void r()});L.value.push(r),i()}else e.index.hideLoading(),q.value=!0,w.anchor_id=a.value.id,w.model_version=r.DigitalHumanModelVersionEnum.CHANJING,T.value=!!a.value;else e.index.hideLoading(),q.value=!0,T.value=!0}catch(a){T.value=!1,e.index.hideLoading()}},B=()=>{T.value?(v("confirm",{type:r.ListenerTypeEnum.CREATE_ANCHOR,data:r.DigitalHumanModelVersionEnum.SHANJIAN==U.value?A.value:w}),e.index.navigateBack()):(j.pic="",j.url="",j.name="",j.width=0,j.height=0,j.anchor_id="",q.value=!1)};return e.onLoad(e=>{e.source&&(U.value=e.source),f("confirm",e=>{const{type:o,data:i}=e;o===r.ListenerTypeEnum.VIDEO_UPLOAD&&(e=>{w.name=e.name,w.pic=e.pic,w.url=e.url,w.width=e.width,w.height=e.height})(i),o!==r.ListenerTypeEnum.ANCHOR_AUTH&&o!==r.ListenerTypeEnum.UPLOAD_AUTH_CAMERA||(e=>{j.name=e.name,j.pic=e.pic,j.url=e.url})(i)})}),e.onUnload(()=>{e.index.hideLoading(),L.value.forEach(e=>e()),L.value=[]}),(i,n)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.unref(w).pic},e.unref(w).pic?{c:e.o(N)}:{},{d:!e.unref(w).pic},e.unref(w).pic?{n:e.unref(w).url,o:e.unref(w).pic}:{e:o._imports_0$12,f:e.t(e.unref(m.commonUploadLimit).videoMinDuration),g:e.t(e.unref(m.commonUploadLimit).videoMaxDuration),h:e.t(e.unref(m.commonUploadLimit).size),i:e.t(e.unref(m.commonUploadLimit).maxWidthResolution/1e3),j:e.t(e.unref(m.commonUploadLimit).maxWidthResolution),k:e.t(e.unref(m.commonUploadLimit).maxHeightResolution),l:e.t(b.join("、")),m:e.o(N)},{p:e.unref(j).pic},e.unref(j).pic?{q:e.o(P)}:{},{r:!e.unref(j).pic},e.unref(j).pic?{w:e.unref(j).url,x:e.unref(j).pic}:{s:o._imports_0$12,t:e.t(2),v:e.o(P)},{y:e.o(e=>k.value=!0),z:e.t(e.unref(S)),A:e.n(e.unref(D)?"bg-black":"bg-_h787878CC_"),B:e.o(z),C:e.p({name:e.unref(T)?"checkmark":"error",color:"#ffffff",size:"28"}),D:e.t(e.unref(T)?"克隆成功":e.unref(A).remark||"创建失败"),E:e.o(B),F:e.o(o=>e.isRef(q)?q.value=o:null),G:e.p({mode:"center","border-radius":"48",width:"90%","mask-close-able":!1,modelValue:e.unref(q)}),H:o._imports_1$2,I:e.p({"play-icon-size":88,poster:`${e.unref(s.config).baseUrl}static/images/dh_example_bg2.png`,"video-url":`${e.unref(s.config).baseUrl}static/videos/dh_example2.mp4`}),J:o._imports_2$1,K:o._imports_3,L:o._imports_4,M:o._imports_5$1,N:o._imports_6,O:o._imports_7,P:o._imports_8,Q:e.o(e=>k.value=!1),R:e.p({show:e.unref(k),title:"拍摄教程",height:"80%"}),S:e.unref(E)},e.unref(E)?{T:e.o($),U:e.p({progress:e.unref(C),"loading-text":e.unref(R),"progress-type":e.unref(M)})}:{},{V:e.sr(H,"a10b69a0-6",{k:"rechargePopupRef"})})}}),f=e._export_sfc(v,[["__scopeId","data-v-a10b69a0"]]);wx.createPage(f);
