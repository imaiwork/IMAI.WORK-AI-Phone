"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js"),r=require("../../../../api/app.js"),u=require("../../../../api/digital_human.js"),a=require("../../../../hooks/useAudio.js"),i=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),c=require("../../../../enums/appEnums.js"),m=require("../../enums/index.js"),d=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../common/vendor.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("recharge-popup")+e.resolveComponent("popup-bottom"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js")+p+(()=>"../../../../components/popup-bottom/popup-bottom.js"))();const p=()=>"../../components/choose-model/choose-model.js",v=e.defineComponent({__name:"tone_clone",setup(p){const v=s.useAppStore(),f=l.useUserStore(),{userTokens:g}=e.toRefs(f),h=e.computed((()=>{const{channel:e}=v.getDigitalHumanConfig;return e&&e.length>0?e.find((e=>e.id==j.model_version)):{}})),_=e.computed((()=>{var e,o,n;const r={[m.DigitalHumanModelVersionEnum.STANDARD]:null==(e=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[m.DigitalHumanModelVersionEnum.CHANJING]:null==(o=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_CHANJING))?void 0:o.score,[m.DigitalHumanModelVersionEnum.SHANJIAN]:null==(n=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_SHANJIAN))?void 0:n.score};return parseFloat(r[j.model_version])})),j=e.reactive({url:"",name:"",gender:"male",model_version:m.DigitalHumanModelVersionEnum.STANDARD}),q=e.ref(""),w=[{name:"男声",value:"male",icon:o.ManIcon,activeIcon:o.ManActiveIcon},{name:"女声",value:"female",icon:o.WomanIcon,activeIcon:o.WomanActiveIcon}],x=e.ref(!1),y=e.ref(!1),A=e.ref(0),I=e.ref(null),N=e.ref(0),k=e.ref(!1),{setUrl:H,isPlaying:C,play:M,pause:b,destroy:E}=a.useAudio(),{authorize:S,isRecording:$,start:V,stop:D,close:T}=i.useRecorder({onstart:()=>{O()},onstop:async e=>{if(k.value)return;const{tempFilePath:o,fileSize:n}=e;L(n)&&(clearInterval(I.value),await z(o),H(o))},onerror:e=>{G()}},{duration:6e4}),F=e.ref(),B=e=>{j.model_version=e},R=()=>{y.value=!0,k.value=!1},J=async()=>{await P(),H(j.url)},L=o=>!(o>10485760)||(e.index.$u.toast("音频文件大小不能超过10M"),!1),P=async()=>{try{const e=await n.chooseFile({type:"file",extension:["mp3","wav","m4a"]});await U(e)}catch(e){console.error("选择文件出错:",e)}},U=async o=>{var n;const{tempFiles:r}=o,{size:u,name:a}=r[0],i=null==(n=a.split(".").pop())?void 0:n.toLowerCase();i&&["mp3","m4a","wav"].includes(i)?L(u)&&await z(r[0].path):e.index.$u.toast("请上传mp3、m4a、wav格式的音频文件")},z=async o=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:e,name:n}=await r.uploadFile("audio",{filePath:o});j.url=e,q.value=n,y.value=!1}catch(n){e.index.showToast({title:n.message||"上传失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},O=()=>{G(),I.value=setInterval((()=>{N.value+=1}),1e3)},G=()=>{N.value=0,clearInterval(I.value)},W=async()=>{await S(),$.value||V()},K=()=>{N.value<15?e.index.$u.toast("录制时间不能少于15秒"):D()},Q=()=>{$.value=!1,y.value=!1,k.value=!0,D(),E(),G(),T()},X=()=>{$.value=!1,y.value=!1,k.value=!1,j.url="",q.value="",D(),E(),G(),T()},Y=()=>{A.value=Math.floor(Math.random()*d.cratedVoiceCopywriter.length)},Z=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/clone_manage/clone_manage",type:"redirect"})};return(n,r)=>{var a;return e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((o=>e.unref(j).name=o)),c:e.p({placeholder:"请输入音色名称",maxlength:"50",clearable:!0,modelValue:e.unref(j).name}),d:e.t((null==(a=e.unref(h))?void 0:a.name)||"请选择"),e:e.p({name:"arrow-right",color:"#B2B2B2",size:20}),f:e.o((e=>x.value=!0)),g:e.unref(j).model_version!=e.unref(m.DigitalHumanModelVersionEnum).SHANJIAN},e.unref(j).model_version!=e.unref(m.DigitalHumanModelVersionEnum).SHANJIAN?{h:e.f(w,((o,n,r)=>e.e({a:e.unref(j).gender===o.value},e.unref(j).gender===o.value?{b:o.activeIcon}:{c:o.icon},{d:e.t(o.name),e:e.n(e.unref(j).gender===o.value?"border-_h0065FB_ text-primary":"border-_transparent_ text-_h00000080_"),f:n,g:e.o((e=>{return n=o.value,void(j.gender=n);var n}),n)})))}:{},{i:e.unref(j).url},e.unref(j).url?e.e({j:o._imports_0$7,k:e.t(e.unref(q)),l:!e.unref(C)},e.unref(C)?{n:o._imports_1$5}:{m:o._imports_2$2},{o:e.t(e.unref(C)?"暂停":"试听"),p:e.o((e=>(async()=>{C.value?b():M()})())),q:e.o(X)}):{r:o._imports_3$3,s:e.o(R),t:o._imports_4$3,v:e.o(J)},{w:e.unref(_)},e.unref(_)?{x:e.t(e.unref(_))}:{},{y:e.o((o=>(async()=>{var o;if(j.name.trim())if(j.url)if(j.model_version){if(g.value<_.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(o=F.value)||o.open());try{e.index.showLoading({title:"克隆中",mask:!0}),j.model_version==m.DigitalHumanModelVersionEnum.SHANJIAN?await u.shanjianVoiceClone({name:j.name,audio_url:j.url}):await u.voiceClone(j),f.getUser(),e.index.$u.toast("克隆成功，请在我的音色中查看"),setTimeout((()=>{Z()}),300)}catch(n){e.index.$u.toast(n.message||"克隆失败")}finally{e.index.hideLoading()}}else e.index.$u.toast("请选择使用模型");else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请输入音色名称")})())),z:e.sr(F,"113e5702-3",{k:"rechargePopupRef"}),A:e.o(B),B:e.o((o=>e.isRef(x)?x.value=o:null)),C:e.p({show:e.unref(x)}),D:e.t(e.unref(d.cratedVoiceCopywriter)[e.unref(A)]),E:e.p({name:"reload",color:"#0065FB"}),F:e.o(Y),G:e.unref($)},e.unref($)?{H:e.t(e.unref(t.formatAudioTime)(e.unref(N)))}:{},{I:!e.unref($)},e.unref($)?{L:e.o(K)}:{J:o._imports_5,K:e.o(W)},{M:e.o(Q),N:e.o(X),O:e.o((o=>e.isRef(y)?y.value=o:null)),P:e.p({title:"录制声音","custom-class":"bg-_hF6F6F6_","show-footer":!1,height:"80%",show:e.unref(y)})})}}}),f=e._export_sfc(v,[["__scopeId","data-v-113e5702"]]);wx.createPage(f);
