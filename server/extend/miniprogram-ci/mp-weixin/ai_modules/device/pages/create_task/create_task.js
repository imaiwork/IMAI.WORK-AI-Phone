"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../api/app.js"),i=require("../../../../api/device.js"),r=require("../../enums/index.js"),s=require("../../../../hooks/useEventBusManager.js"),n=require("../../../../api/drawing.js"),a=require("../../../../hooks/useUpload.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("confirm-dialog")+e.resolveComponent("upload-progress")+e.resolveComponent("choose-material"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+o+(()=>"../../../../components/confirm-dialog/confirm-dialog.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+u+(()=>"../../../../components/choose-material/choose-material.js"))();const o=()=>"../../components/bast-setting/bast-setting.js",u=()=>"../../../../components/video-preview/video-preview.js",l=e.defineComponent({__name:"create_task",setup(o){const{on:u}=s.useEventBusManager(),l=e.ref(1),c=e.ref([{step:1,title:"选择素材"},{step:2,title:"填写文案"},{step:3,title:"设定时间"}]),f=e.ref(1),p=e.reactive({name:"",introduction:"",copywriterList:[],materialLists:[],time_config:[{start_time:"09:00",end_time:"09:30"},{start_time:"09:30",end_time:"10:30"}],accounts:[],publish_frep:2,custom_date:[],task_frep:1}),m=e.shallowRef(),d=e.ref(-1),v=e.ref(-1),g=e.ref(!1),h=e.ref(!1),_=e.ref(!1),L=99,y=["mp4","mov"],w=e.ref("video"),x=e.ref(!0),b=e.ref(-1),j=e.reactive({url:"",pic:""}),q=e.ref(!1),k=e.ref(""),z=e.ref(-1),C=e.ref(!1),$=e.computed(()=>2==l.value?"发布图文":"发布视频"),M=e.computed(()=>`\n        <div>· 视频素材支持：${y.join("、")}格式，100M以内</div>\n    <div class="mt-2">· 最多可传99个视频</div>\n    <div class="mt-2">· 不符合条件的视频会被自动删除</div>\n    `),R=e.computed(()=>T(f.value)),T=e=>{switch(e){case 1:return p.materialLists.length>0;case 2:return p.copywriterList.length>0;case 3:return!0;default:return!1}},E=(t,i)=>{if("prev"!==i)if("next"!==i){if(t!==f.value)if(t<f.value)f.value=t;else{for(let i=1;i<t;i++)if(!T(i))return void e.index.$u.toast("请按顺序完成步骤");f.value=t}}else if(R.value)f.value++;else{const t={1:"请至少选择一个图组",2:"请至少添加一条文案"};e.index.$u.toast(t[f.value]||"请完成当前步骤")}else f.value--},{showUploadProgress:S,uploadMaterialList:I,uploadAndProcessFiles:O}=a.useUpload({count:L,imageSize:100,onSuccess:e=>{const t=L-p.materialLists.length;p.materialLists=p.materialLists.concat(e.slice(0,t).map(e=>({url:[e.pic,e.url]})))}}),V=()=>{_.value=!1,e.index.showActionSheet({itemList:['从"微信聊天"中选择','从"手机相册"中选择'],success:e=>{if(0==e.tapIndex||1==e.tapIndex){if(x.value)return x.value=!1,void(_.value=!0);w.value=0==e.tapIndex?"all":"video",x.value||O(w.value)}}})},P=async t=>{const i=t.map((t,i)=>new Promise(i=>{e.wx$1.getVideoInfo({src:t.content,success:r=>{const{type:s,width:n,height:a}=r,o=n<=y[0]&&a<=y[1]&&y.includes(s.toLowerCase())&&parseInt(t.size)<=100;console.log(t),o?i(t.content):(e.index.showToast({title:"选择的视频包含不符合条件的视频，已自动过滤",icon:"none"}),i(null))},fail:()=>{i(null)}})}));e.index.showLoading({title:"素材检查中...",mask:!0});try{const e=await Promise.all(i);console.log(e)}finally{e.index.hideLoading()}},A=t=>{v.value=t??-1,e.index.$u.route({url:"/ai_modules/device/pages/task_img_group/task_img_group",params:{imgs:-1!==v.value?JSON.stringify(p.materialLists[v.value].url):""}})},F=()=>{p.materialLists.splice(d.value,1),h.value=!1,d.value=-1},N=()=>{e.index.$u.route({url:"/pages/phone/phone",type:"reLaunch"}),C.value=!1},U=async()=>{var t;if(null==(t=m.value)?void 0:t.validateForm())e.index.$u.toast("时间配置存在冲突");else if(p.name){if(0===p.accounts.length)return e.index.$u.toast("请选择发布账号"),void e.index.$u.route({url:"/ai_modules/device/pages/account_choose/account_choose"});e.index.showLoading({title:"创建中...",mask:!0});try{const{id:t}=await i.addMatrixTask({name:p.name,media_type:l.value,media_url:p.materialLists,copywriting:p.copywriterList});await i.publishDeviceTask({name:p.name,matrix_media_setting_id:t,time_config:p.time_config.map(e=>`${e.start_time}-${e.end_time}`),accounts:p.accounts,publish_frep:p.publish_frep,media_type:l.value,task_type:3,scene:2,data_type:0}),C.value=!0,e.index.hideLoading()}catch(r){k.value=r,e.index.hideLoading(),e.index.showToast({title:r,icon:"none",duration:3e3})}}else e.index.$u.toast("请输入任务名称")};function B(e,t){let i=[];const r=e.length;for(let s=0;s<t;s++){const t=Math.floor(Math.random()*r);i.push(e[t])}return i}return e.onLoad(async i=>{if(i.type){l.value=i.type;const t=2==l.value?"图文":"视频";p.name=`${t}矩阵任务${e.index.$u.timeFormat(new Date,"yyyymmddhhMM")}`}if("creation_video"==i.source){const e=JSON.parse(i.ids),{lists:r}=await t.getVideoCreationRecord({page_size:99999});r&&r.length>0&&r.filter(t=>e.includes(t.task_id)).forEach(e=>{p.materialLists.push({url:[e.pic,e.clip_result_url||e.video_result_url]})})}else if("puzzle"==i.source){const{id:e,count:t}=i,{lists:r}=await n.getPuzzleTaskResultList({puzzle_setting_id:e,page_size:999});if(r&&r.length>0){const e=r.reduce((e,t)=>(e.push(...t.puzzle_url),e),[]);p.materialLists=function(e,t){if(t<=0)return console.error("组数必须大于0。"),[];let i=[];for(let r=0;r<t;r++){const t=1,r=B(e,Math.floor(Math.random()*(Math.min(e.length,9)-t+1))+t);i.push({url:r})}return i}(e,t)}}u("confirm",e=>{const{type:t,data:i}=e;if(t===r.ListenerTypeEnum.CHOOSE_IMG)if(-1!==v.value){if(0===i.length)return void p.materialLists.splice(v.value,1);p.materialLists[v.value].url=i}else p.materialLists.push({url:i});if(t===r.ListenerTypeEnum.TASK_COPYWRITER||t===r.ListenerTypeEnum.TASK_AI_COPYWRITER){if(0===i.length)return;-1!==z.value?p.copywriterList[z.value]=i[0]:p.copywriterList=p.copywriterList.concat(i)}if(t===r.ListenerTypeEnum.CHOOSE_ACCOUNT){if(0===i.length)return;p.accounts=i.map(e=>({account:e.account,type:e.type,id:e.id}))}})}),(t,i)=>e.e({a:e.p({"title-bold":!0,title:e.unref($),"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),b:e.f(e.unref(c),(t,i,r)=>e.e({a:e.unref(f)>t.step},e.unref(f)>t.step?{b:"90bf217f-1-"+r,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(c).length},t.step!==e.unref(c).length?{f:e.unref(f)>t.step?1:""}:{},{g:t.step,h:e.unref(f)==t.step?1:"",i:e.o(e=>E(t.step),t.step)})),c:1===e.unref(f)},1===e.unref(f)?e.e({d:e.t(2==e.unref(l)?"图组列表":"视频素材"),e:e.t(e.unref(p).materialLists.length),f:2==e.unref(l)},2==e.unref(l)?{g:e.o(e=>A())}:{},{h:2==e.unref(l)},2==e.unref(l)?e.e({i:e.unref(p).materialLists.length>0},e.unref(p).materialLists.length>0?{j:e.f(e.unref(p).materialLists,(t,i,r)=>({a:e.t(`图组${e.unref(p).materialLists.length<10?`0${i+1}`:i+1}`),b:e.t(t.url.length),c:"90bf217f-2-"+r,d:e.o(e=>A(i),i),e:e.f(t.url,(e,t,i)=>({a:e,b:t})),f:e.o(e=>(e=>{d.value=e,h.value=!0})(i),i),g:i})),k:e.p({name:"arrow-right",size:"20",color:"#00000099"})}:{l:e.p({size:260,text:"您还没有图组哦"}),m:e.p({name:"plus",size:"24"}),n:e.o(e=>A())}):e.e({o:e.f(e.unref(p).materialLists,(t,i,r)=>({a:t.url[0],b:e.o(e=>(e=>{j.pic=e[0],j.url=e[1],q.value=!0})(t.url),i),c:"90bf217f-5-"+r,d:e.o(e=>(e=>{p.materialLists.splice(e,1)})(i),i),e:e.o(e=>(e=>{b.value=e,O("video")})(i),i),f:i})),p:e.p({name:"close",size:"20",color:"#ffffff"}),q:e.unref(p).materialLists.length<L},e.unref(p).materialLists.length<L?{r:e.p({name:"plus",size:"24",color:"#ffffff"}),s:e.o(V)}:{})):{},{t:2===e.unref(f)},2===e.unref(f)?e.e({v:e.o(e=>z.value=-1),w:e.t(e.unref(p).copywriterList.length),x:e.unref(p).copywriterList.length>0},e.unref(p).copywriterList.length>0?{y:e.f(e.unref(p).copywriterList,(t,i,r)=>({a:e.t(t.title),b:e.t(t.content),c:e.f(t.topic,(t,i,r)=>({a:e.t(t),b:i})),d:"90bf217f-7-"+r,e:e.o(e=>(e=>{p.copywriterList.splice(e,1)})(i),i),f:i,g:e.o(t=>(t=>{z.value=t,e.index.$u.route({url:"/ai_modules/device/pages/task_copywriter/task_copywriter",params:{copywriter:JSON.stringify(p.copywriterList[t])}})})(i),i)})),z:e.p({name:"close",size:"20",color:"#ffffff"})}:{A:e.p({size:260,text:"您还没有文案哦"})}):{},{B:3===e.unref(f)},3===e.unref(f)?e.e({C:e.sr(m,"90bf217f-9",{k:"baseFormRef"}),D:e.o(t=>e.isRef(p)?p.value=t:null),E:e.p({modelValue:e.unref(p)}),F:e.unref(k)},e.unref(k)?{G:e.t(e.unref(k))}:{}):{},{H:e.unref(f)!=e.unref(c).length},e.unref(f)!=e.unref(c).length?e.e({I:1===e.unref(f)},1===e.unref(f)?{J:e.t(e.unref(p).materialLists.length),K:e.n(e.unref(p).materialLists.length>0?"bg-black":"bg-_h787878CC_")}:{L:e.o(t=>E(e.unref(f),"prev"))},{M:e.n(e.unref(R)?"bg-black":"bg-_h787878CC_"),N:e.o(t=>E(e.unref(f),"next"))}):{O:e.o(U)},{P:e.o(F),Q:e.o(t=>e.isRef(h)?h.value=t:null),R:e.p({"confirm-text":"删除",center:!0,content:"是否确定删除图组？",modelValue:e.unref(h)}),S:e.o(N),T:e.o(t=>e.isRef(C)?C.value=t:null),U:e.p({"confirm-text":"确定",center:!0,content:"创建成功，回到任务列表？","show-close":!1,modelValue:e.unref(C)}),V:e.o(e=>{x.value=!1,_.value=!1}),W:e.o(t=>e.unref(O)("video")),X:e.o(t=>e.isRef(_)?_.value=t:null),Y:e.p({"confirm-text":"去上传",content:e.unref(M),modelValue:e.unref(_)}),Z:e.o(t=>e.isRef(S)?S.value=t:null),aa:e.p({"upload-list":e.unref(I),modelValue:e.unref(S)}),ab:e.o(e=>q.value=!1),ac:e.o(t=>e.isRef(q)?q.value=t:null),ad:e.p({"video-url":e.unref(j).url,poster:e.unref(j).pic,modelValue:e.unref(q)}),ae:e.o(P),af:e.o(t=>e.isRef(g)?g.value=t:null),ag:e.p({type:"video",limit:L-e.unref(p).materialLists.length,modelValue:e.unref(g)})})}}),c=e._export_sfc(l,[["__scopeId","data-v-90bf217f"]]);wx.createPage(c);
