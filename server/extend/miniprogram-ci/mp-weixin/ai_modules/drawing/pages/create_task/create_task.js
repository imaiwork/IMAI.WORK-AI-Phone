"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),r=require("../../../../api/drawing.js"),u=require("../../../../stores/user.js"),s=require("../../../../hooks/useUpload.js"),o=require("../../enums/index.js"),n=require("../../../../hooks/useEventBusManager.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-input")+e.resolveComponent("u-popup")+e.resolveComponent("choose-material")+e.resolveComponent("upload-progress")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/choose-material/choose-material.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const i=e.defineComponent({__name:"create_task",setup(i){const{on:a}=n.useEventBusManager(),l=u.useUserStore(),{userTokens:p}=e.toRefs(l),c=e.ref([{step:1,title:"上传图片"},{step:2,title:"填写主题"},{step:3,title:"生成设置"}]),f=e.ref(1),m=e.reactive({copywriterList:[],materialList:[],name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM")+"拼图",result_count:4}),d=e.ref(!1),v=e.ref(!0),h=["jpg","png"],g=[2e3,2e3],_=e.ref(!1),w=e.ref("image"),j=e.ref(-1),x=e.ref(!1),L=e.shallowRef(),y=e=>{switch(e){case 1:return m.materialList.length>1;case 2:return m.copywriterList.length>0;case 3:return!0;default:return!1}},q=e.computed(()=>y(f.value)),b=(t,r)=>{if("prev"!==r)if("next"!==r){if(t!==f.value)if(t<f.value)f.value=t;else{for(let r=1;r<t;r++)if(!y(r))return void e.index.$u.toast("请按顺序完成步骤");f.value=t}}else if(q.value)f.value++;else{const t={1:"请上传图片",2:"请填写主题"};e.index.$u.toast(t[f.value]||"请完成当前步骤")}else f.value--},k=()=>{e.index.showActionSheet({itemList:['从"微信聊天"中选择','从"素材库"中选择','从"手机相册"中选择'],success:e=>{if(0==e.tapIndex||2==e.tapIndex){if(v.value)return v.value=!1,void(d.value=!0);w.value=0==e.tapIndex?"all":"image",v.value||$(w.value)}1==e.tapIndex&&(_.value=!0)}})},{uploadMaterialList:C,showUploadProgress:z,uploadAndProcessFiles:$}=s.useUpload({imageAccept:h,imageSize:5,imageResolution:g,fileAccept:h,fileSize:5,onSuccess:e=>{m.materialList.push(...e)}}),I=async t=>{const r=t.map((t,r)=>new Promise(r=>{e.wx$1.getImageInfo({src:t.content,success:u=>{const{type:s,width:o,height:n}=u;o<=g[0]&&n<=g[1]&&h.includes(s.toLowerCase())&&parseInt(t.size)<=5242880?r(t):(e.index.showToast({title:"选择的图片包含不符合条件的图片，已自动过滤",icon:"none"}),r(null))},fail:()=>{r(null)}})})),u=await Promise.all(r);m.materialList.push(...u)},R=t=>{e.index.$u.route({url:"/ai_modules/drawing/pages/puzzle_copywriter/puzzle_copywriter",params:{data:t?JSON.stringify(t):""}})},P=t=>{if("minus"===t){if(m.result_count<4)return void e.index.$u.toast("最少生成4个拼图哦");m.result_count=4*Math.floor((m.result_count-1)/4)}else{if(m.result_count>=100)return e.index.$u.toast("最多生成100个拼图哦"),void(m.result_count=100);m.result_count=4*Math.ceil((m.result_count+1)/4)}},E=async()=>{var t;if(p.value<0)null==(t=L.value)||t.open();else if(m.result_count<4)e.index.$u.toast("最少生成4个拼图哦");else if(m.result_count%4==0){e.index.showLoading({title:"提交中...",mask:!0});try{await r.createPuzzleTask({name:m.name,copywriting:m.copywriterList.map(e=>({title:e})),material:m.materialList.map(e=>e.pic),result_count:m.result_count}),x.value=!0,e.index.hideLoading()}catch(u){e.index.hideLoading(),e.index.showToast({title:u,icon:"none",duration:3e3})}}else e.index.$u.toast("生成数量必须是4的倍数")},B=()=>{e.index.$u.route({url:"/packages/pages/creation/creation?tab=2",type:"reLaunch"})};return e.onLoad(()=>{a("confirm",e=>{const{type:t,data:r}=e;if(t===o.ListenerTypeEnum.PUZZLE_AI_COPYWRITER||t===o.ListenerTypeEnum.PUZZLE_COPYWRITER){if(0==r.length)return;-1!==j.value?m.copywriterList[j.value]=r[0]:m.copywriterList.push(...r)}})}),(r,u)=>e.e({a:e.p({title:"智能拼图","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(c),(t,r,u)=>e.e({a:e.unref(f)>t.step},e.unref(f)>t.step?{b:"e30a550d-1-"+u,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(c).length},t.step!==e.unref(c).length?{f:e.unref(f)>t.step?1:""}:{},{g:t.step,h:e.unref(f)==t.step?1:"",i:e.o(e=>b(t.step),t.step)})),c:1==e.unref(f)},1==e.unref(f)?{d:e.t(e.unref(m).materialList.length),e:e.f(e.unref(m).materialList,(t,r,u)=>({a:t.pic,b:e.o(r=>{return u=t.pic,void e.index.previewImage({urls:[u]});var u},r),c:"e30a550d-2-"+u,d:e.o(e=>(e=>{m.materialList.splice(e,1)})(r),r),e:r})),f:t._imports_0$11,g:e.p({name:"close",color:"#ffffff",size:"16"}),h:t._imports_0$6,i:e.o(k)}:{},{j:2==e.unref(f)},2==e.unref(f)?{k:e.o(e=>R()),l:e.o(e=>j.value=-1),m:e.f(e.unref(m).copywriterList,(t,r,u)=>({a:e.f(t,(t,r,u)=>({a:e.t(0==r?"主标题":"副标题"),b:e.t(t),c:r})),b:"e30a550d-3-"+u,c:e.o(e=>(e=>{m.copywriterList.splice(e,1)})(r),r),d:r,e:e.o(e=>(e=>{j.value=e;const t=m.copywriterList[e];R(t)})(r),r)})),n:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{o:3==e.unref(f)},3==e.unref(f)?{p:e.o(t=>e.unref(m).name=t),q:e.p({maxlength:"50","placeholder-style":"font-size:26rpx;",placeholder:"请输入",clearable:!0,modelValue:e.unref(m).name}),r:e.t(e.unref(m).materialList.length),s:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),t:e.o(e=>b(1)),v:e.t(e.unref(m).copywriterList.length),w:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),x:e.o(e=>b(2)),y:t._imports_2$4,z:e.o(e=>P("minus")),A:e.o(t=>e.unref(m).result_count=t),B:e.p({type:"digit",placeholder:"",min:1,max:100,"custom-style":{color:"#0065fb",fontWeight:"bold"},"input-align":"center",modelValue:e.unref(m).result_count}),C:t._imports_3$6,D:e.o(e=>P("add"))}:{},{E:e.unref(f)!=e.unref(c).length},e.unref(f)!=e.unref(c).length?e.e({F:1===e.unref(f)},1===e.unref(f)?{G:e.t(e.unref(m).materialList.length),H:e.n(e.unref(m).materialList.length>0?"bg-black":"bg-_h787878CC_")}:{I:e.o(t=>b(e.unref(f),"prev"))},{J:e.n(e.unref(q)?"bg-black":"bg-_h787878CC_"),K:e.o(t=>b(e.unref(f),"next"))}):{L:e.t(e.unref(m).result_count),M:e.o(E)},{N:e.t(h.join("、")),O:e.t(5),P:e.t(g[0]),Q:e.t(g[1]),R:e.o(e=>{d.value=!1,v.value=!1}),S:e.o(t=>{d.value=!1,e.unref($)(e.unref(w))}),T:e.o(t=>e.isRef(d)?d.value=t:null),U:e.p({mode:"center","border-radius":"24",width:"90%",modelValue:e.unref(d)}),V:e.o(I),W:e.o(t=>e.isRef(_)?_.value=t:null),X:e.p({type:"image",limit:100-e.unref(m).materialList.length,modelValue:e.unref(_)}),Y:e.o(t=>e.isRef(z)?z.value=t:null),Z:e.p({"upload-list":e.unref(C),modelValue:e.unref(z)}),aa:e.o(B),ab:e.o(t=>e.isRef(x)?x.value=t:null),ac:e.p({mode:"center","border-radius":"20",width:"85%","custom-style":{backgroundColor:"transparent"},"mask-close-able":!1,modelValue:e.unref(x)}),ad:e.sr(L,"e30a550d-12",{k:"rechargePopupRef"})})}}),a=e._export_sfc(i,[["__scopeId","data-v-e30a550d"]]);wx.createPage(a);
