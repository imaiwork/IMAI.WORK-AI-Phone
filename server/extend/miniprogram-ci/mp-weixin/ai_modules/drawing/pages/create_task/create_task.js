"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),r=require("../../../../api/drawing.js"),u=require("../../../../stores/user.js"),s=require("../../../../hooks/useUpload.js"),n=require("../../enums/index.js"),o=require("../../../../hooks/useEventBusManager.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-input")+e.resolveComponent("u-popup")+e.resolveComponent("choose-material")+e.resolveComponent("upload-progress")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/choose-material/choose-material.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const i=e.defineComponent({__name:"create_task",setup(i){const{on:a}=o.useEventBusManager(),l=u.useUserStore(),{userTokens:p}=e.toRefs(l),c=e.ref([{step:1,title:"上传图片"},{step:2,title:"填写主题"},{step:3,title:"生成设置"}]),f=e.ref(1),m=e.reactive({copywriterList:[],materialList:[],name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM")+"拼图",result_count:4}),d=e.ref(!1),v=e.ref(!0),g=["jpg","png","jpeg"],h=[2e3,2e3],_=e.ref(!1),w=e.ref("image"),j=e.ref(-1),L=e.ref(-1),x=e.ref(!1),b=e.shallowRef(),y=e=>{switch(e){case 1:return m.materialList.length>1;case 2:return m.copywriterList.length>0;case 3:return!0;default:return!1}},q=e.computed((()=>y(f.value))),k=(t,r)=>{if("prev"!==r)if("next"!==r){if(t!==f.value)if(t<f.value)f.value=t;else{for(let r=1;r<t;r++)if(!y(r))return void e.index.$u.toast("请按顺序完成步骤");f.value=t}}else if(q.value)f.value++;else{const t={1:"请上传图片",2:"请填写主题"};e.index.$u.toast(t[f.value]||"请完成当前步骤")}else f.value--},z=()=>{e.index.showActionSheet({itemList:['从"微信聊天"中选择','从"素材库"中选择','从"手机相册"中选择'],success:e=>{if(0==e.tapIndex||2==e.tapIndex){if(w.value=0==e.tapIndex?"file":"image",v.value)return v.value=!1,void(d.value=!0);v.value||R(w.value)}1==e.tapIndex&&(_.value=!0)}})},{uploadMaterialList:C,showUploadProgress:I,uploadAndProcessFiles:R}=s.useUpload({imageAccept:g,imageSize:5,imageResolution:h,fileAccept:g,fileSize:5,onSuccess:e=>{-1!==j.value?m.materialList[j.value]=e[0].url:m.materialList.push(...e.map((e=>e.url))),j.value=-1}}),$=async t=>{const r=t.map(((t,r)=>new Promise((r=>{e.wx$1.getImageInfo({src:t.content,success:u=>{const{type:s,width:n,height:o}=u;n<=h[0]&&o<=h[1]&&g.includes(s)&&parseInt(t.size)<=5242880?r(t.content):(e.index.showToast({title:"选择的图片包含不符合条件的图片，已自动过滤",icon:"none"}),r(null))},fail:()=>{r(null)}})})))),u=(await Promise.all(r)).filter((e=>e));-1!==j.value?m.materialList[j.value]=u[0]:m.materialList.push(...u),j.value=-1},P=t=>{e.index.$u.route({url:"/ai_modules/drawing/pages/puzzle_copywriter/puzzle_copywriter",params:{data:t?JSON.stringify(t):""}})},E=t=>{if("minus"===t){if(m.result_count<4)return void e.index.$u.toast("最少生成4个拼图哦");m.result_count=4*Math.floor((m.result_count-1)/4)}else{if(m.result_count>=100)return e.index.$u.toast("最多生成100个拼图哦"),void(m.result_count=100);m.result_count=4*Math.ceil((m.result_count+1)/4)}},B=async()=>{var t;if(p.value<0)null==(t=b.value)||t.open();else if(m.result_count<4)e.index.$u.toast("最少生成4个拼图哦");else if(m.result_count%4==0){e.index.showLoading({title:"提交中...",mask:!0});try{await r.createPuzzleTask({name:m.name,copywriting:m.copywriterList.map((e=>({title:e}))),material:m.materialList,result_count:m.result_count}),x.value=!0,e.index.hideLoading()}catch(u){e.index.hideLoading(),e.index.showToast({title:u,icon:"none",duration:3e3})}}else e.index.$u.toast("生成数量必须是4的倍数")},M=()=>{e.index.$u.route({url:"/packages/pages/creation/creation?tab=2",type:"reLaunch"})};return e.onLoad((()=>{a("confirm",(e=>{const{type:t,data:r}=e;if(t===n.ListenerTypeEnum.PUZZLE_AI_COPYWRITER||t===n.ListenerTypeEnum.PUZZLE_COPYWRITER){if(0==r.length)return;-1!==L.value?m.copywriterList[L.value]=r[0]:m.copywriterList.push(...r)}}))})),(r,u)=>e.e({a:e.p({title:"智能拼图","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(c),((t,r,u)=>e.e({a:e.unref(f)>t.step},e.unref(f)>t.step?{b:"8ed5be40-1-"+u,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(c).length},t.step!==e.unref(c).length?{f:e.unref(f)>t.step?1:""}:{},{g:t.step,h:e.unref(f)==t.step?1:"",i:e.o((e=>k(t.step)),t.step)}))),c:1==e.unref(f)},1==e.unref(f)?{d:e.t(e.unref(m).materialList.length),e:e.f(e.unref(m).materialList,((t,r,u)=>({a:t,b:e.o((r=>{return u=t,void e.index.previewImage({urls:[u]});var u}),r),c:"8ed5be40-2-"+u,d:e.o((e=>(e=>{m.materialList.splice(e,1)})(r)),r),e:e.o((e=>(e=>{j.value=e,z()})(r)),r),f:r}))),f:e.p({name:"close",color:"#ffffff",size:"16"}),g:t._imports_0$6,h:e.o(z)}:{},{i:2==e.unref(f)},2==e.unref(f)?{j:e.o((e=>P())),k:e.o((e=>L.value=-1)),l:e.f(e.unref(m).copywriterList,((t,r,u)=>({a:e.f(t,((t,r,u)=>({a:e.t(0==r?"主标题":"副标题"),b:e.t(t),c:r}))),b:"8ed5be40-3-"+u,c:e.o((e=>(e=>{m.copywriterList.splice(e,1)})(r)),r),d:r,e:e.o((e=>(e=>{L.value=e;const t=m.copywriterList[e];P(t)})(r)),r)}))),m:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{n:3==e.unref(f)},3==e.unref(f)?{o:e.o((t=>e.unref(m).name=t)),p:e.p({maxlength:"50","placeholder-style":"font-size:26rpx;",placeholder:"请输入",clearable:!0,modelValue:e.unref(m).name}),q:e.t(e.unref(m).materialList.length),r:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),s:e.o((e=>k(1))),t:e.t(e.unref(m).copywriterList.length),v:e.p({name:"arrow-right",size:20,color:"#B2B2B2"}),w:e.o((e=>k(2))),x:t._imports_1$22,y:e.o((e=>E("minus"))),z:e.o((t=>e.unref(m).result_count=t)),A:e.p({type:"digit",placeholder:"",min:1,max:100,"custom-style":{color:"#0065fb",fontWeight:"bold"},"input-align":"center",modelValue:e.unref(m).result_count}),B:t._imports_2$9,C:e.o((e=>E("add")))}:{},{D:e.unref(f)!=e.unref(c).length},e.unref(f)!=e.unref(c).length?e.e({E:1===e.unref(f)},1===e.unref(f)?{F:e.t(e.unref(m).materialList.length),G:e.n(e.unref(m).materialList.length>0?"bg-black":"bg-_h787878CC_")}:{H:e.o((t=>k(e.unref(f),"prev")))},{I:e.n(e.unref(q)?"bg-black":"bg-_h787878CC_"),J:e.o((t=>k(e.unref(f),"next")))}):{K:e.t(e.unref(m).result_count),L:e.o(B)},{M:e.t(g.join("、")),N:e.t(5),O:e.t(h[0]),P:e.t(h[1]),Q:e.o((e=>{d.value=!1,v.value=!1})),R:e.o((t=>{d.value=!1,e.unref(R)(e.unref(w))})),S:e.o((t=>e.isRef(d)?d.value=t:null)),T:e.p({mode:"center","border-radius":"24",width:"90%",modelValue:e.unref(d)}),U:e.o($),V:e.o((t=>e.isRef(_)?_.value=t:null)),W:e.p({type:"image",multiple:-1==e.unref(j),limit:100-e.unref(m).materialList.length,modelValue:e.unref(_)}),X:e.o((t=>e.isRef(I)?I.value=t:null)),Y:e.p({"upload-list":e.unref(C),modelValue:e.unref(I)}),Z:e.o(M),aa:e.o((t=>e.isRef(x)?x.value=t:null)),ab:e.p({mode:"center","border-radius":"20",width:"85%","custom-style":{backgroundColor:"transparent"},"mask-close-able":!1,modelValue:e.unref(x)}),ac:e.sr(b,"8ed5be40-12",{k:"rechargePopupRef"})})}}),a=e._export_sfc(i,[["__scopeId","data-v-8ed5be40"]]);wx.createPage(a);
